
{% extends "base.html" %}

{% block title %}User Activity - Email Guardian{% endblock %}

{% block content %}
<div class="row">
    <div class="col-12">
        <div class="d-flex justify-content-between align-items-center mb-4">
            <h1>
                <i class="fas fa-user-clock"></i>
                User Activity Dashboard
            </h1>
            <div class="btn-group" role="group">
                <button class="btn btn-outline-primary" onclick="loadUserActivity()">
                    <i class="fas fa-sync"></i> Refresh
                </button>
                <button class="btn btn-outline-success" onclick="exportActivity()">
                    <i class="fas fa-download"></i> Export
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Activity Statistics Cards -->
<div class="row mb-4" id="activityStats">
    <!-- Statistics will be loaded dynamically -->
</div>

<!-- Activity Filters -->
<div class="row mb-4">
    <div class="col-12">
        <div class="card">
            <div class="card-header">
                <h5 class="mb-0">
                    <i class="fas fa-filter"></i>
                    Activity Filters
                </h5>
            </div>
            <div class="card-body">
                <div class="row g-3">
                    <div class="col-md-3">
                        <label for="userFilter" class="form-label">User</label>
                        <input type="text" class="form-control" id="userFilter" placeholder="Filter by user ID...">
                    </div>
                    <div class="col-md-3">
                        <label for="actionFilter" class="form-label">Action Type</label>
                        <select class="form-select" id="actionFilter">
                            <option value="">All Actions</option>
                            <option value="clear_email">Clear Email</option>
                            <option value="escalate_email">Escalate Email</option>
                            <option value="flag_sender">Flag Sender</option>
                            <option value="create_case">Create Case</option>
                            <option value="update_case_status">Update Case</option>
                            <option value="dashboard_filter">Search/Filter</option>
                        </select>
                    </div>
                    <div class="col-md-2">
                        <label for="limitFilter" class="form-label">Limit</label>
                        <select class="form-select" id="limitFilter">
                            <option value="50">50 records</option>
                            <option value="100" selected>100 records</option>
                            <option value="250">250 records</option>
                            <option value="500">500 records</option>
                        </select>
                    </div>
                    <div class="col-md-2">
                        <label for="daysFilter" class="form-label">Period</label>
                        <select class="form-select" id="daysFilter">
                            <option value="7">Last 7 days</option>
                            <option value="30" selected>Last 30 days</option>
                            <option value="90">Last 90 days</option>
                        </select>
                    </div>
                    <div class="col-md-2 d-flex align-items-end">
                        <button class="btn btn-primary w-100" onclick="loadUserActivity()">
                            <i class="fas fa-search"></i> Apply
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Activity Table -->
<div class="row">
    <div class="col-12">
        <div class="card">
            <div class="card-header">
                <h5 class="mb-0">
                    <i class="fas fa-list"></i>
                    Recent Activity
                </h5>
            </div>
            <div class="card-body">
                <div class="table-responsive">
                    <table class="table table-striped table-hover" id="activityTable">
                        <thead>
                            <tr>
                                <th>Timestamp</th>
                                <th>User</th>
                                <th>Action</th>
                                <th>Email</th>
                                <th>Case</th>
                                <th>Details</th>
                            </tr>
                        </thead>
                        <tbody id="activityTableBody">
                            <tr>
                                <td colspan="6" class="text-center text-muted">
                                    <i class="fas fa-spinner fa-spin"></i> Loading activity...
                                </td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
// Load user activity on page load
document.addEventListener('DOMContentLoaded', function() {
    loadUserActivity();
    loadActivityStatistics();
});

function loadUserActivity() {
    const userFilter = document.getElementById('userFilter').value;
    const limit = document.getElementById('limitFilter').value;
    
    let url = `/api/user-activity?limit=${limit}`;
    if (userFilter) {
        url += `&user_id=${encodeURIComponent(userFilter)}`;
    }
    
    fetch(url)
        .then(response => response.json())
        .then(data => {
            displayActivity(data);
        })
        .catch(error => {
            console.error('Error loading activity:', error);
            document.getElementById('activityTableBody').innerHTML = `
                <tr><td colspan="6" class="text-center text-danger">
                    <i class="fas fa-exclamation-triangle"></i> Failed to load activity
                </td></tr>
            `;
        });
}

function loadActivityStatistics() {
    const days = document.getElementById('daysFilter').value;
    
    fetch(`/api/action-statistics?days=${days}`)
        .then(response => response.json())
        .then(data => {
            displayStatistics(data);
        })
        .catch(error => {
            console.error('Error loading statistics:', error);
        });
}

function displayActivity(activities) {
    const tbody = document.getElementById('activityTableBody');
    
    if (!activities || activities.length === 0) {
        tbody.innerHTML = `
            <tr><td colspan="6" class="text-center text-muted">
                <i class="fas fa-inbox"></i> No activity found
            </td></tr>
        `;
        return;
    }
    
    tbody.innerHTML = activities.map(activity => `
        <tr>
            <td>
                <small>${new Date(activity.timestamp).toLocaleString()}</small>
            </td>
            <td>
                <span class="badge bg-info">${activity.user_id}</span>
            </td>
            <td>
                <span class="badge ${getActionBadgeClass(activity.action_type)}">
                    ${formatActionType(activity.action_type)}
                </span>
            </td>
            <td>
                ${activity.email_id ? `
                    <a href="#" onclick="showEmailDetails(${activity.email_id})">${activity.sender || 'Email #' + activity.email_id}</a>
                    ${activity.subject ? `<br><small class="text-muted">${activity.subject.substring(0, 50)}...</small>` : ''}
                ` : '<span class="text-muted">N/A</span>'}
            </td>
            <td>
                ${activity.case_id ? `
                    Case #${activity.case_id}
                    ${activity.escalation_reason ? `<br><small class="text-muted">${activity.escalation_reason.substring(0, 30)}...</small>` : ''}
                ` : '<span class="text-muted">N/A</span>'}
            </td>
            <td>
                ${formatActivityDetails(activity.details)}
            </td>
        </tr>
    `).join('');
}

function displayStatistics(data) {
    const statsContainer = document.getElementById('activityStats');
    
    if (!data.statistics || data.statistics.length === 0) {
        statsContainer.innerHTML = `
            <div class="col-12">
                <div class="alert alert-info">
                    <i class="fas fa-info-circle"></i> No activity statistics available for the selected period.
                </div>
            </div>
        `;
        return;
    }
    
    const totalActions = data.statistics.reduce((sum, stat) => sum + stat.count, 0);
    
    statsContainer.innerHTML = `
        <div class="col-md-3">
            <div class="card bg-primary text-white">
                <div class="card-body">
                    <div class="d-flex justify-content-between">
                        <div>
                            <h5 class="card-title">Total Actions</h5>
                            <h2 class="mb-0">${totalActions.toLocaleString()}</h2>
                        </div>
                        <div class="align-self-center">
                            <i class="fas fa-chart-line fa-2x"></i>
                        </div>
                    </div>
                    <small>Last ${data.period_days} days</small>
                </div>
            </div>
        </div>
        ${data.statistics.slice(0, 3).map(stat => `
            <div class="col-md-3">
                <div class="card">
                    <div class="card-body">
                        <h6 class="card-title">${formatActionType(stat.action_type)}</h6>
                        <h3 class="mb-1">${stat.count.toLocaleString()}</h3>
                        <small class="text-muted">${stat.unique_users} users</small>
                    </div>
                </div>
            </div>
        `).join('')}
    `;
}

function getActionBadgeClass(actionType) {
    switch(actionType) {
        case 'clear_email': return 'bg-success';
        case 'escalate_email': return 'bg-warning';
        case 'flag_sender': return 'bg-danger';
        case 'create_case': return 'bg-info';
        case 'update_case_status': return 'bg-secondary';
        default: return 'bg-light text-dark';
    }
}

function formatActionType(actionType) {
    return actionType.split('_').map(word => 
        word.charAt(0).toUpperCase() + word.slice(1)
    ).join(' ');
}

function formatActivityDetails(details) {
    if (!details || Object.keys(details).length === 0) {
        return '<span class="text-muted">No details</span>';
    }
    
    const detailItems = Object.entries(details)
        .slice(0, 2)
        .map(([key, value]) => `${key}: ${value}`)
        .join('<br>');
    
    return `<small>${detailItems}</small>`;
}

function exportActivity() {
    window.EmailGuardian.showNotification('Export functionality coming soon', 'info');
}

function showEmailDetails(emailId) {
    // Reuse the email details function from main dashboard
    if (window.showEmailDetails) {
        window.showEmailDetails(emailId);
    } else {
        window.EmailGuardian.showNotification('Email details not available on this page', 'warning');
    }
}

// Auto-refresh every 60 seconds
setInterval(() => {
    if (document.visibilityState === 'visible') {
        loadUserActivity();
    }
}, 60000);
</script>
{% endblock %}
