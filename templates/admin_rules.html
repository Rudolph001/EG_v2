{% extends "base.html" %}

{% block title %}Admin Rules - Email Guardian{% endblock %}

{% block content %}
<div class="row">
    <div class="col-12">
        <div class="d-flex justify-content-between align-items-center mb-4">
            <h1>
                <i class="fas fa-cogs"></i>
                Advanced Admin Rules Configuration
            </h1>
            <div>
                <button type="button" class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#addRuleModal">
                    <i class="fas fa-plus"></i>
                    Build New Rule
                </button>
                <button type="button" class="btn btn-info" onclick="loadAvailableFields()">
                    <i class="fas fa-database"></i>
                    View Available Fields
                </button>
                <button type="button" class="btn btn-warning" onclick="testRuleCreation()">
                    <i class="fas fa-flask"></i>
                    Test Rule Creation
                </button>
                <button type="button" class="btn btn-success" onclick="viewAllPolicies()">
                    <i class="fas fa-list"></i>
                    View All Policies
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Available Fields Info Card -->
<div class="row mb-4">
    <div class="col-12">
        <div class="card border-info">
            <div class="card-header bg-info text-white">
                <h5 class="mb-0">
                    <i class="fas fa-info-circle"></i>
                    Available Fields for Rule Building
                </h5>
            </div>
            <div class="card-body">
                <div class="row" id="availableFieldsContainer">
                    <div class="col-md-12 text-center">
                        <button class="btn btn-outline-info" onclick="loadAvailableFields()">
                            <i class="fas fa-sync"></i> Load Current Database Fields
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Rules Table -->
<div class="row">
    <div class="col-12">
        <div class="card">
            <div class="card-header">
                <h5 class="mb-0">
                    <i class="fas fa-table"></i>
                    Active Admin Rules
                </h5>
            </div>
            <div class="card-body p-0">
                {% if rules %}
                <div class="table-responsive">
                    <table class="table table-striped table-hover mb-0" id="rulesTable">
                        <thead class="table-dark">
                            <tr>
                                <th>RULE ID</th>
                                <th>RULE NAME</th>
                                <th>RULE TYPE</th>
                                <th>CONDITIONS</th>
                                <th>LOGIC</th>
                                <th>ACTION</th>
                                <th>STATUS</th>
                                <th>CREATED</th>
                                <th>ACTIONS</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for rule in rules %}
                            <tr>
                                <td>
                                    <strong>#{{ rule[0] }}</strong>
                                </td>
                                <td>
                                    <strong>
                                        {% set rule_name = 'Rule ' + rule[0]|string %}
                                        {% if rule[2] %}
                                            {% try %}
                                                {% set conditions_json = rule[2]|from_json %}
                                                {% set rule_name = conditions_json.get('rule_name', 'Rule ' + rule[0]|string) %}
                                            {% except %}
                                                {% set rule_name = 'Rule ' + rule[0]|string %}
                                            {% endtry %}
                                        {% endif %}
                                        {{ rule_name }}
                                    </strong>
                                </td>
                                <td>
                                    {% if rule[1] == 'advanced_rule' %}
                                        <span class="badge bg-primary">
                                            <i class="fas fa-brain"></i> Advanced Rule
                                        </span>
                                    {% elif rule[1] == 'whitelist_sender' %}
                                        <span class="badge bg-success">
                                            <i class="fas fa-user-check"></i> Whitelist Sender
                                        </span>
                                    {% elif rule[1] == 'whitelist_domain' %}
                                        <span class="badge bg-success">
                                            <i class="fas fa-globe"></i> Whitelist Domain
                                        </span>
                                    {% else %}
                                        <span class="badge bg-secondary">
                                            <i class="fas fa-cog"></i> {{ rule[1]|title }}
                                        </span>
                                    {% endif %}
                                </td>
                                <td>
                                    <small class="text-muted">
                                        {% if rule[2] %}
                                            {% try %}
                                                {% set conditions_json = rule[2]|from_json %}
                                                {% if conditions_json.get('conditions') %}
                                                    {{ conditions_json.conditions|length }} condition(s)
                                                {% else %}
                                                    {{ rule[2][:50] + '...' if rule[2]|length > 50 else rule[2] }}
                                                {% endif %}
                                            {% except %}
                                                {{ rule[2][:50] + '...' if rule[2]|length > 50 else rule[2] }}
                                            {% endtry %}
                                        {% else %}
                                            No conditions
                                        {% endif %}
                                    </small>
                                </td>
                                <td>
                                    {% if rule[2] %}
                                        {% try %}
                                            {% set conditions_json = rule[2]|from_json %}
                                            <span class="badge bg-info">{{ conditions_json.get('logic_type', 'Simple') }}</span>
                                        {% except %}
                                            <span class="badge bg-info">Simple</span>
                                        {% endtry %}
                                    {% else %}
                                        <span class="badge bg-info">Simple</span>
                                    {% endif %}
                                </td>
                                <td>
                                    {% if rule[3] %}
                                        <span class="badge bg-warning">{{ rule[3]|upper }}</span>
                                    {% else %}
                                        <span class="badge bg-secondary">FLAG</span>
                                    {% endif %}
                                </td>
                                <td>
                                    {% if rule[4] %}
                                        {% if rule[4] == 'true' or rule[4] == True %}
                                            <span class="badge bg-success">
                                                <i class="fas fa-check"></i> Active
                                            </span>
                                        {% else %}
                                            <span class="badge bg-secondary">
                                                <i class="fas fa-pause"></i> Inactive
                                            </span>
                                        {% endif %}
                                    {% else %}
                                        <span class="badge bg-secondary">
                                            <i class="fas fa-pause"></i> Inactive
                                        </span>
                                    {% endif %}
                                </td>
                                <td>
                                    <small class="text-muted">
                                        {% if rule[5] %}
                                            {{ rule[5].strftime('%Y-%m-%d') if rule[5].strftime else rule[5] }}
                                        {% else %}
                                            N/A
                                        {% endif %}
                                    </small>
                                </td>
                                <td>
                                    <div class="btn-group btn-group-sm" role="group">
                                        <button type="button" class="btn btn-outline-info" 
                                                onclick="viewRule({{ rule[0] }})" 
                                                title="View Rule Details">
                                            <i class="fas fa-eye"></i>
                                        </button>
                                        <button type="button" class="btn btn-outline-primary" 
                                                onclick="editRule({{ rule[0] }})" 
                                                title="Edit Rule">
                                            <i class="fas fa-edit"></i>
                                        </button>
                                        <button type="button" class="btn btn-outline-danger" 
                                                onclick="deleteRule({{ rule[0] }})" 
                                                title="Delete Rule">
                                            <i class="fas fa-trash"></i>
                                        </button>
                                    </div>
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
                {% else %}
                <div class="text-center py-5">
                    <i class="fas fa-cogs fa-3x text-muted mb-3"></i>
                    <h5 class="text-muted">No admin rules configured</h5>
                    <p class="text-muted">Create your first advanced rule to automate email processing.</p>
                    <button type="button" class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#addRuleModal">
                        <i class="fas fa-plus"></i> Build First Rule
                    </button>
                </div>
                {% endif %}
            </div>
        </div>
    </div>
</div>

<!-- Advanced Rule Builder Modal -->
<div class="modal fade" id="addRuleModal" tabindex="-1" aria-labelledby="addRuleModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-xl">
        <div class="modal-content">
            <div class="modal-header bg-primary text-white">
                <h5 class="modal-title" id="addRuleModalLabel">
                    <i class="fas fa-brain"></i> Advanced Rule Builder
                </h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <form id="addRuleForm">
                    <!-- Rule Basic Info -->
                    <div class="row mb-4">
                        <div class="col-md-4">
                            <label for="ruleName" class="form-label fw-bold">Rule Name</label>
                            <input type="text" class="form-control" id="ruleName" name="rule_name" 
                                   placeholder="My Custom Rule" required>
                        </div>
                        <div class="col-md-4">
                            <label for="ruleType" class="form-label fw-bold">Rule Type</label>
                            <select class="form-select" id="ruleType" name="rule_type" required>
                                <option value="">Select rule type...</option>
                                <option value="advanced_rule">Advanced Multi-Condition Rule</option>
                                <option value="sender_filter">Sender Filter</option>
                                <option value="content_filter">Content Filter</option>
                                <option value="attachment_filter">Attachment Filter</option>
                                <option value="auto_escalation">Auto Escalation</option>
                                <option value="department_filter">Department Filter</option>
                            </select>
                        </div>
                        <div class="col-md-4">
                            <label for="ruleAction" class="form-label fw-bold">Action</label>
                            <select class="form-select" id="ruleAction" name="action" required>
                                <option value="">Select action...</option>
                                <option value="flag">Flag for Review</option>
                                <option value="block">Block Email</option>
                                <option value="escalate">Create Case</option>
                                <option value="notify">Send Notification</option>
                                <option value="quarantine">Quarantine</option>
                                <option value="whitelist">Add to Whitelist</option>
                            </select>
                        </div>
                    </div>

                    <!-- Logic Type Selection -->
                    <div class="row mb-4">
                        <div class="col-12">
                            <label class="form-label fw-bold">Condition Logic</label>
                            <div class="btn-group w-100" role="group" aria-label="Logic type">
                                <input type="radio" class="btn-check" name="logic_type" id="logicAnd" value="AND" checked>
                                <label class="btn btn-outline-success" for="logicAnd">
                                    <i class="fas fa-link"></i> ALL conditions must match (AND)
                                </label>

                                <input type="radio" class="btn-check" name="logic_type" id="logicOr" value="OR">
                                <label class="btn btn-outline-warning" for="logicOr">
                                    <i class="fas fa-code-branch"></i> ANY condition can match (OR)
                                </label>
                            </div>
                        </div>
                    </div>

                    <!-- Conditions Builder -->
                    <div class="card border-primary mb-4">
                        <div class="card-header bg-primary text-white">
                            <h6 class="mb-0">
                                <i class="fas fa-filter"></i> Build Conditions
                            </h6>
                        </div>
                        <div class="card-body">
                            <div id="conditionsContainer">
                                <!-- Initial condition will be added here -->
                            </div>
                            <div class="mt-3">
                                <button type="button" class="btn btn-outline-primary" onclick="addCondition()">
                                    <i class="fas fa-plus"></i> Add Condition
                                </button>
                                <button type="button" class="btn btn-outline-secondary ms-2" onclick="clearAllConditions()">
                                    <i class="fas fa-trash"></i> Clear All
                                </button>
                            </div>
                        </div>
                    </div>

                    <!-- Rule Preview -->
                    <div class="card border-info mb-3">
                        <div class="card-header bg-info text-white">
                            <h6 class="mb-0">
                                <i class="fas fa-eye"></i> Rule Preview
                            </h6>
                        </div>
                        <div class="card-body">
                            <pre id="rulePreview" class="bg-light p-3 border rounded">
{
  "rule_name": "Enter rule name...",
  "logic_type": "AND",
  "conditions": []
}
                            </pre>
                        </div>
                    </div>

                    <!-- Enable Rule -->
                    <div class="mb-3">
                        <div class="form-check form-switch">
                            <input class="form-check-input" type="checkbox" id="ruleActive" name="is_active" checked>
                            <label class="form-check-label fw-bold" for="ruleActive">
                                <i class="fas fa-power-off"></i> Enable rule immediately
                            </label>
                        </div>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                    <i class="fas fa-times"></i> Cancel
                </button>
                <button type="button" class="btn btn-success" onclick="testRule()">
                    <i class="fas fa-vial"></i> Test Rule
                </button>
                <button type="button" class="btn btn-primary" onclick="submitAdvancedRule()">
                    <i class="fas fa-save"></i> Save Rule
                </button>
            </div>
        </div>
    </div>
</div>

<!-- View All Policies Modal -->
<div class="modal fade" id="viewPoliciesModal" tabindex="-1" aria-labelledby="viewPoliciesModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-xl">
        <div class="modal-content">
            <div class="modal-header bg-success text-white">
                <h5 class="modal-title" id="viewPoliciesModalLabel">
                    <i class="fas fa-shield-alt"></i> All Security Policies
                </h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <div class="d-flex justify-content-between align-items-center mb-3">
                    <div>
                        <h6 class="mb-0">Total Policies: <span id="totalPoliciesCount">Loading...</span></h6>
                    </div>
                    <div>
                        <button class="btn btn-primary btn-sm" onclick="refreshPolicies()">
                            <i class="fas fa-sync"></i> Refresh
                        </button>
                    </div>
                </div>

                <div id="policiesLoadingIndicator" class="text-center py-4">
                    <div class="spinner-border text-primary" role="status">
                        <span class="visually-hidden">Loading policies...</span>
                    </div>
                    <p class="mt-2">Loading policies...</p>
                </div>

                <div id="policiesContainer" style="display: none;">
                    <div class="table-responsive">
                        <table class="table table-striped table-hover" id="policiesTable">
                            <thead class="table-dark">
                                <tr>
                                    <th>ID</th>
                                    <th>Policy Name</th>
                                    <th>Type</th>
                                    <th>Description</th>
                                    <th>Action</th>
                                    <th>Status</th>
                                    <th>Created</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody id="policiesTableBody">
                                <!-- Policies will be populated here -->
                            </tbody>
                        </table>
                    </div>
                </div>

                <div id="policiesErrorContainer" style="display: none;" class="alert alert-danger">
                    <h6><i class="fas fa-exclamation-triangle"></i> Error Loading Policies</h6>
                    <p id="policiesErrorMessage">An error occurred while loading policies.</p>
                    <button class="btn btn-outline-danger" onclick="refreshPolicies()">
                        <i class="fas fa-retry"></i> Try Again
                    </button>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                    <i class="fas fa-times"></i> Close
                </button>
                <button type="button" class="btn btn-primary" onclick="createNewPolicy()">
                    <i class="fas fa-plus"></i> Create New Policy
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Quick Rule Templates -->
<div class="row mt-4">
    <div class="col-12">
        <div class="card border-success">
            <div class="card-header bg-success text-white">
                <h5 class="mb-0">
                    <i class="fas fa-magic"></i>
                    Quick Rule Templates
                </h5>
            </div>
            <div class="card-body">
                <div class="row">
                    <div class="col-md-3 mb-3">
                        <div class="card h-100 border-primary">
                            <div class="card-body">
                                <h6 class="card-title text-primary">
                                    <i class="fas fa-shield-alt"></i>
                                    High-Risk Sender
                                </h6>
                                <p class="card-text small">
                                    Flag emails from external domains with attachments AND suspicious keywords.
                                </p>
                                <button class="btn btn-outline-primary btn-sm" onclick="useAdvancedTemplate('high_risk_sender')">
                                    Use Template
                                </button>
                            </div>
                        </div>
                    </div>

                    <div class="col-md-3 mb-3">
                        <div class="card h-100 border-warning">
                            <div class="card-body">
                                <h6 class="card-title text-warning">
                                    <i class="fas fa-exclamation-triangle"></i>
                                    Department Alert
                                </h6>
                                <p class="card-text small">
                                    Monitor Finance OR Legal departments for sensitive keywords.
                                </p>
                                <button class="btn btn-outline-warning btn-sm" onclick="useAdvancedTemplate('department_alert')">
                                    Use Template
                                </button>
                            </div>
                        </div>
                    </div>

                    <div class="col-md-3 mb-3">
                        <div class="card h-100 border-danger">
                            <div class="card-body">
                                <h6 class="card-title text-danger">
                                    <i class="fas fa-user-times"></i>
                                    Former Employee
                                </h6>
                                <p class="card-text small">
                                    Block emails from leavers with specific file attachments.
                                </p>
                                <button class="btn btn-outline-danger btn-sm" onclick="useAdvancedTemplate('former_employee')">
                                    Use Template
                                </button>
                            </div>
                        </div>
                    </div>

                    <div class="col-md-3 mb-3">
                        <div class="card h-100 border-info">
                            <div class="card-body">
                                <h6 class="card-title text-info">
                                    <i class="fas fa-clock"></i>
                                    After Hours Activity
                                </h6>
                                <p class="card-text small">
                                    Flag weekend emails OR after 6 PM with large attachments.
                                </p>
                                <button class="btn btn-outline-info btn-sm" onclick="useAdvancedTemplate('after_hours')">
                                    Use Template
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
// Available database fields - will be loaded from API
let availableFields = [
    'id', '_time', 'sender', 'subject', 'attachments', 'recipients', 
    'time_month', 'leaver', 'termination_date', 'bunit', 'department',
    'user_response', 'final_outcome', 'policy_name', 'justifications', 'created_at'
];

// Field types and operators mapping
const fieldOperators = {
    'text': ['contains', 'equals', 'starts_with', 'ends_with', 'not_contains', 'regex'],
    'number': ['equals', 'greater_than', 'less_than', 'between'],
    'date': ['equals', 'after', 'before', 'between'],
    'boolean': ['equals', 'is_true', 'is_false'],
    'list': ['contains', 'not_contains', 'in_list']
};

// Field type mapping with descriptions
const fieldTypes = {
    'id': 'number',
    '_time': 'date',
    'sender': 'text',
    'subject': 'text',
    'attachments': 'text',
    'recipients': 'text',
    'time_month': 'text',
    'leaver': 'boolean',
    'termination_date': 'date',
    'bunit': 'text',
    'department': 'text',
    'user_response': 'text',
    'final_outcome': 'text',
    'policy_name': 'text',
    'justifications': 'text',
    'created_at': 'date'
};

// Field descriptions for better UX
const fieldDescriptions = {
    'id': 'Email ID (numeric)',
    '_time': 'Email timestamp',
    'sender': 'Email sender address',
    'subject': 'Email subject line',
    'attachments': 'File attachments',
    'recipients': 'Email recipients',
    'time_month': 'Month of email',
    'leaver': 'Is sender a former employee',
    'termination_date': 'Employee termination date',
    'bunit': 'Business unit',
    'department': 'Department',
    'user_response': 'User response to email',
    'final_outcome': 'Processing outcome',
    'policy_name': 'Policy violation name',
    'justifications': 'Email content/justifications',
    'created_at': 'Record creation date'
};

let conditionCounter = 0;

// Load available fields from database
function loadAvailableFields() {
    fetch('/api/admin/available-fields')
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                availableFields = data.fields;
                displayAvailableFields(data.fields);
            } else {
                // Use default fields if API fails
                availableFields = Object.keys(fieldTypes);
                displayAvailableFields(availableFields);
            }
        })
        .catch(error => {
            console.error('Error loading fields:', error);
            // Use default fields
            availableFields = Object.keys(fieldTypes);
            displayAvailableFields(availableFields);
        });
}

function displayAvailableFields(fields) {
    const container = document.getElementById('availableFieldsContainer');
    const fieldGroups = {
        'Email Content': ['sender', 'subject', 'recipients', 'attachments', 'justifications'],
        'Metadata': ['id', '_time', 'time_month', 'department', 'bunit', 'created_at'],
        'User Info': ['leaver', 'termination_date', 'user_response'],
        'Processing': ['final_outcome', 'policy_name']
    };

    let html = '';
    for (const [groupName, groupFields] of Object.entries(fieldGroups)) {
        const availableInGroup = groupFields.filter(field => fields.includes(field));
        if (availableInGroup.length > 0) {
            html += `
                <div class="col-md-3 mb-3">
                    <h6 class="text-primary"><i class="fas fa-folder"></i> ${groupName}</h6>
                    <div class="d-flex flex-wrap gap-1">
                        ${availableInGroup.map(field => {
                            const description = fieldDescriptions[field] || field;
                            return `<span class="badge bg-light text-dark border" title="${description}">${field}</span>`;
                        }).join('')}
                    </div>
                </div>
            `;
        }
    }

    // Add any other fields not in groups
    const otherFields = fields.filter(field => 
        !Object.values(fieldGroups).flat().includes(field)
    );
    if (otherFields.length > 0) {
        html += `
            <div class="col-md-3 mb-3">
                <h6 class="text-secondary"><i class="fas fa-plus-circle"></i> Other Fields</h6>
                <div class="d-flex flex-wrap gap-1">
                    ${otherFields.map(field => {
                        const description = fieldDescriptions[field] || field;
                        return `<span class="badge bg-secondary" title="${description}">${field}</span>`;
                    }).join('')}
                </div>
            </div>
        `;
    }

    container.innerHTML = html;
}

function addCondition() {
    conditionCounter++;
    const conditionId = `condition_${conditionCounter}`;

    const fieldOptions = availableFields.map(field => {
        const description = fieldDescriptions[field] || field;
        return `<option value="${field}">${field} - ${description}</option>`;
    }).join('');

    const conditionHtml = `
        <div class="condition-row border rounded p-3 mb-3" id="${conditionId}" style="background: linear-gradient(135deg, #f8fafc 0%, #f1f5f9 100%);">
            <div class="row g-3 align-items-end">
                <div class="col-md-3">
                    <label class="form-label fw-bold text-primary">
                        <i class="fas fa-database"></i> Field
                    </label>
                    <select class="form-select condition-field" onchange="updateOperators('${conditionId}')">
                        <option value="">Select field...</option>
                        ${fieldOptions}
                    </select>
                </div>
                <div class="col-md-2">
                    <label class="form-label fw-bold text-success">
                        <i class="fas fa-filter"></i> Operator
                    </label>
                    <select class="form-select condition-operator">
                        <option value="">Select operator...</option>
                    </select>
                </div>
                <div class="col-md-4">
                    <label class="form-label fw-bold text-warning">
                        <i class="fas fa-edit"></i> Value
                    </label>
                    <input type="text" class="form-control condition-value" 
                           placeholder="Enter value..." onchange="updatePreview()">
                </div>
                <div class="col-md-2">
                    <label class="form-label fw-bold text-info">Case Sensitive</label>
                    <div class="form-check form-switch">
                        <input class="form-check-input condition-case-sensitive" type="checkbox">
                        <label class="form-check-label">Sensitive</label>
                    </div>
                </div>
                <div class="col-md-1">
                    <button type="button" class="btn btn-outline-danger btn-sm w-100" 
                            onclick="removeCondition('${conditionId}')" title="Remove Condition">
                        <i class="fas fa-trash"></i>
                    </button>
                </div>
            </div>
        </div>
    `;

    document.getElementById('conditionsContainer').insertAdjacentHTML('beforeend', conditionHtml);
    updatePreview();
}

function updateOperators(conditionId) {
    const row = document.getElementById(conditionId);
    const fieldSelect = row.querySelector('.condition-field');
    const operatorSelect = row.querySelector('.condition-operator');
    const field = fieldSelect.value;

    if (field) {
        const fieldType = fieldTypes[field] || 'text';
        const operators = fieldOperators[fieldType] || fieldOperators['text'];

        operatorSelect.innerHTML = '<option value="">Select operator...</option>' +
            operators.map(op => `<option value="${op}">${op.replace('_', ' ')}</option>`).join('');
    } else {
        operatorSelect.innerHTML = '<option value="">Select operator...</option>';
    }

    updatePreview();
}

function removeCondition(conditionId) {
    document.getElementById(conditionId).remove();
    updatePreview();
}

function clearAllConditions() {
    document.getElementById('conditionsContainer').innerHTML = '';
    updatePreview();
}

function updatePreview() {
    const conditions = [];
    document.querySelectorAll('.condition-row').forEach(row => {
        const field = row.querySelector('.condition-field').value;
        const operator = row.querySelector('.condition-operator').value;
        const value = row.querySelector('.condition-value').value;
        const caseSensitive = row.querySelector('.condition-case-sensitive').checked;

        if (field && operator && value) {
            conditions.push({
                field: field,
                operator: operator,
                value: value,
                case_sensitive: caseSensitive
            });
        }
    });

    const logicType = document.querySelector('input[name="logic_type"]:checked')?.value || 'AND';
    const ruleName = document.getElementById('ruleName').value || 'Enter rule name...';

    const preview = {
        rule_name: ruleName,
        logic_type: logicType,
        conditions: conditions,
        total_conditions: conditions.length,
        description: conditions.length > 0 ? 
            `This rule will trigger when ${logicType === 'AND' ? 'ALL' : 'ANY'} of the ${conditions.length} condition(s) match.` :
            'No conditions defined yet. Add conditions above.'
    };

    document.getElementById('rulePreview').textContent = JSON.stringify(preview, null, 2);
}

function testRule() {
    const conditions = [];
    document.querySelectorAll('.condition-row').forEach(row => {
        const field = row.querySelector('.condition-field').value;
        const operator = row.querySelector('.condition-operator').value;
        const value = row.querySelector('.condition-value').value;
        const caseSensitive = row.querySelector('.condition-case-sensitive').checked;

        if (field && operator && value) {
            conditions.push({ field, operator, value, case_sensitive: caseSensitive });
        }
    });

    if (conditions.length === 0) {
        alert('Please add at least one condition to test.');
        return;
    }

    const testData = {
        conditions: conditions,
        logic_type: document.querySelector('input[name="logic_type"]:checked').value
    };

    fetch('/api/admin/test-rule', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(testData)
    })
    .then(response => response.json())
    .then(result => {
        if (result.success) {
            alert(`Rule test completed!\n\nMatching emails: ${result.matching_count}\nTotal emails checked: ${result.total_count}\n\nFirst few matches:\n${result.sample_matches.join('\n')}`);
        } else {
            alert('Test failed: ' + result.error);
        }
    })
    .catch(error => {
        console.error('Test error:', error);
        alert('Test failed: ' + error.message);
    });
}

function submitAdvancedRule() {
    const form = document.getElementById('addRuleForm');
    const formData = new FormData(form);

    // Collect conditions
    const conditions = [];
    document.querySelectorAll('.condition-row').forEach(row => {
        const field = row.querySelector('.condition-field').value;
        const operator = row.querySelector('.condition-operator').value;
        const value = row.querySelector('.condition-value').value;
        const caseSensitive = row.querySelector('.condition-case-sensitive').checked;

        if (field && operator && value) {
            conditions.push({ field, operator, value, case_sensitive: caseSensitive });
        }
    });

    if (conditions.length === 0) {
        alert('Please add at least one condition.');
        return;
    }

    const ruleData = {
        rule_name: formData.get('rule_name'),
        rule_type: formData.get('rule_type'),
        action: formData.get('action'),
        logic_type: formData.get('logic_type'),
        conditions: JSON.stringify({
            rule_name: formData.get('rule_name'),
            logic_type: formData.get('logic_type'),
            conditions: conditions
        }),
        is_active: formData.get('is_active') ? true : false
    };

    fetch('/api/add-admin-rule', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(ruleData)
    })
    .then(response => response.json())
    .then(result => {
        if (result.success) {
            bootstrap.Modal.getInstance(document.getElementById('addRuleModal')).hide();
            location.reload();
        } else {
            alert('Error: ' + result.error);
        }
    })
    .catch(error => {
        console.error('Error:', error);
        alert('An error occurred while saving the rule.');
    });
}

// Advanced rule templates
const advancedTemplates = {
    high_risk_sender: {
        rule_name: 'High-Risk External Sender',
        rule_type: 'advanced_rule',
        action: 'escalate',
        logic_type: 'AND',
        conditions: [
            { field: 'sender', operator: 'not_contains', value: '@company.com', case_sensitive: false },
            { field: 'attachments', operator: 'not_equals', value: '-', case_sensitive: false },
            { field: 'subject', operator: 'contains', value: 'urgent|confidential|verify', case_sensitive: false }
        ]
    },
    department_alert: {
        rule_name: 'Sensitive Department Monitor',
        rule_type: 'advanced_rule',
        action: 'flag',
        logic_type: 'OR',
        conditions: [
            { field: 'department', operator: 'equals', value: 'Finance', case_sensitive: false },
            { field: 'department', operator: 'equals', value: 'Legal', case_sensitive: false }
        ]
    },
    former_employee: {
        rule_name: 'Former Employee Block',
        rule_type: 'advanced_rule',
        action: 'block',
        logic_type: 'AND',
        conditions: [
            { field: 'leaver', operator: 'equals', value: 'Yes', case_sensitive: false },
            { field: 'attachments', operator: 'contains', value: '.pdf|.doc|.xls', case_sensitive: false }
        ]
    },
    after_hours: {
        rule_name: 'After Hours Activity',
        rule_type: 'advanced_rule',
        action: 'flag',
        logic_type: 'OR',
        conditions: [
            { field: '_time', operator: 'regex', value: '(Sat|Sun)', case_sensitive: false },
            { field: '_time', operator: 'regex', value: '(18:|19:|20:|21:|22:|23:)', case_sensitive: false }
        ]
    }
};

function useAdvancedTemplate(templateName) {
    const template = advancedTemplates[templateName];
    if (!template) return;

    // Fill form fields
    document.getElementById('ruleName').value = template.rule_name;
    document.getElementById('ruleType').value = template.rule_type;
    document.getElementById('ruleAction').value = template.action;
    document.querySelector(`input[name="logic_type"][value="${template.logic_type}"]`).checked = true;

    // Clear existing conditions
    clearAllConditions();

    // Add template conditions
    template.conditions.forEach(condition => {
        addCondition();
        const lastCondition = document.querySelector('.condition-row:last-child');
        lastCondition.querySelector('.condition-field').value = condition.field;
        updateOperators(lastCondition.id);
        setTimeout(() => {
            lastCondition.querySelector('.condition-operator').value = condition.operator;
            lastCondition.querySelector('.condition-value').value = condition.value;
            lastCondition.querySelector('.condition-case-sensitive').checked = condition.case_sensitive;
            updatePreview();
        }, 100);
    });

    // Show modal
    new bootstrap.Modal(document.getElementById('addRuleModal')).show();
}

function toggleRule(ruleId, isActive) {
    const action = isActive ? 'enable' : 'disable';
    if (!confirm(`Are you sure you want to ${action} this rule?`)) {
        return;
    }

    fetch('/api/admin/toggle-rule', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ rule_id: ruleId, is_active: isActive })
    })
    .then(response => response.json())
    .then(result => {
        if (result.success) {
            location.reload();
        } else {
            alert('Error: ' + result.error);
        }
    })
    .catch(error => {
        console.error('Error:', error);
        alert('An error occurred while updating the rule.');
    });
}

function editRule(ruleId) {
    fetch(`/api/admin/rule/${ruleId}`)
    .then(response => response.json())
    .then(rule => {
        if (rule.error) {
            alert('Error loading rule: ' + rule.error);
            return;
        }

        // Populate form with rule data
        document.getElementById('ruleName').value = rule.rule_name || '';
        document.getElementById('ruleType').value = rule.rule_type || '';
        document.getElementById('ruleAction').value = rule.action || '';

        // Parse conditions if they exist
        try {
            const conditionsData = JSON.parse(rule.conditions || '{}');
            if (conditionsData.conditions && Array.isArray(conditionsData.conditions)) {
                clearAllConditions();
                conditionsData.conditions.forEach(condition => {
                    addCondition();
                    const lastCondition = document.querySelector('.condition-row:last-child');
                    lastCondition.querySelector('.condition-field').value = condition.field || '';
                    updateOperators(lastCondition.id);
                    setTimeout(() => {
                        lastCondition.querySelector('.condition-operator').value = condition.operator || '';
                        lastCondition.querySelector('.condition-value').value = condition.value || '';
                        lastCondition.querySelector('.condition-case-sensitive').checked = condition.case_sensitive || false;
                        updatePreview();
                    }, 100);
                });

                if (conditionsData.logic_type) {
                    document.querySelector(`input[name="logic_type"][value="${conditionsData.logic_type}"]`).checked = true;
                }
            }
        } catch (e) {
            console.error('Error parsing rule conditions:', e);
        }

        // Show modal
        new bootstrap.Modal(document.getElementById('addRuleModal')).show();
    })
    .catch(error => {
        console.error('Error:', error);
        alert('Failed to load rule details.');
    });
}

function deleteRule(ruleId) {
    if (!confirm('Are you sure you want to delete this rule? This action cannot be undone.')) {
        return;
    }

    fetch(`/api/admin/delete-rule/${ruleId}`, { method: 'DELETE' })
    .then(response => response.json())
    .then(result => {
        if (result.success) {
            location.reload();
        } else {
            alert('Error: ' + result.error);
        }
    })
    .catch(error => {
        console.error('Error:', error);
        alert('An error occurred while deleting the rule.');
    });
}

// Test rule creation functionality
function testRuleCreation() {
    const testRuleData = {
        rule_name: 'Test Rule - ' + new Date().toISOString(),
        rule_type: 'advanced_rule',
        action: 'flag',
        logic_type: 'AND',
        conditions: JSON.stringify({
            rule_name: 'Test Rule',
            logic_type: 'AND',
            conditions: [
                { field: 'sender', operator: 'contains', value: 'test', case_sensitive: false }
            ]
        }),
        is_active: true
    };

    console.log('Testing rule creation with data:', testRuleData);

    fetch('/api/add-admin-rule', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(testRuleData)
    })
    .then(response => response.json())
    .then(result => {
        console.log('Test rule creation result:', result);
        if (result.success) {
            alert(`✅ Rule creation test PASSED!\n\nRule created successfully with ID: ${result.rule_id}\nMessage: ${result.message}`);
            location.reload(); // Refresh to show the new rule
        } else {
            alert(`❌ Rule creation test FAILED!\n\nError: ${result.error}`);
        }
    })
    .catch(error => {
        console.error('Test rule creation error:', error);
        alert(`❌ Rule creation test FAILED!\n\nNetwork/System Error: ${error.message}`);
    });
}

// Policy Management Functions
function viewAllPolicies() {
    const modal = new bootstrap.Modal(document.getElementById('viewPoliciesModal'));
    modal.show();
    loadAllPolicies();
}

function loadAllPolicies() {
    // Show loading indicator
    document.getElementById('policiesLoadingIndicator').style.display = 'block';
    document.getElementById('policiesContainer').style.display = 'none';
    document.getElementById('policiesErrorContainer').style.display = 'none';

    fetch('/api/admin/policies')
        .then(response => response.json())
        .then(data => {
            console.log('Policies loaded:', data);

            if (data.success) {
                displayPolicies(data.policies);
                document.getElementById('totalPoliciesCount').textContent = data.total_count;
            } else {
                showPoliciesError(data.error || 'Failed to load policies');
            }
        })
        .catch(error => {
            console.error('Error loading policies:', error);
            showPoliciesError('Network error: ' + error.message);
        })
        .finally(() => {
            document.getElementById('policiesLoadingIndicator').style.display = 'none';
        });
}

function displayPolicies(policies) {
    const tbody = document.getElementById('policiesTableBody');

    if (policies.length === 0) {
        tbody.innerHTML = `
            <tr>
                <td colspan="8" class="text-center py-4">
                    <i class="fas fa-shield-alt fa-2x text-muted mb-2"></i>
                    <p class="text-muted mb-0">No policies found</p>
                </td>
            </tr>
        `;
    } else {
        tbody.innerHTML = policies.map(policy => {
            const statusBadge = policy.is_active 
                ? '<span class="badge bg-success"><i class="fas fa-check"></i> Active</span>'
                : '<span class="badge bg-secondary"><i class="fas fa-pause"></i> Inactive</span>';

            const typeBadge = getTypeBadge(policy.rule_type);
            const actionBadge = getActionBadge(policy.action);

            return `
                <tr>
                    <td><strong class="text-primary">#${policy.id}</strong></td>
                    <td>
                        <strong>${escapeHtml(policy.policy_name)}</strong>
                    </td>
                    <td>${typeBadge}</td>
                    <td>
                        <div class="text-break" style="max-width: 250px;">
                            <small class="text-muted">${escapeHtml(policy.description.substring(0, 100))}${policy.description.length > 100 ? '...' : ''}</small>
                        </div>
                    </td>
                    <td>${actionBadge}</td>
                    <td>${statusBadge}</td>
                    <td><small class="text-muted">${escapeHtml(policy.created_at)}</small></td>
                    <td>
                        <div class="btn-group btn-group-sm" role="group">
                            <button type="button" class="btn btn-outline-primary" onclick="editPolicy(${policy.id})" title="Edit Policy">
                                <i class="fas fa-edit"></i>
                            </button>
                            <button type="button" class="btn btn-outline-${policy.is_active ? 'warning' : 'success'}" 
                                    onclick="togglePolicy(${policy.id}, ${!policy.is_active})" 
                                    title="${policy.is_active ? 'Disable' : 'Enable'} Policy">
                                <i class="fas fa-${policy.is_active ? 'pause' : 'play'}"></i>
                            </button>
                            <button type="button" class="btn btn-outline-danger" onclick="deletePolicy(${policy.id})" title="Delete Policy">
                                <i class="fas fa-trash"></i>
                            </button>
                        </div>
                    </td>
                </tr>
            `;
        }).join('');
    }

    document.getElementById('policiesContainer').style.display = 'block';
}

function getTypeBadge(ruleType) {
    const badges = {
        'policy': '<span class="badge bg-primary"><i class="fas fa-shield-alt"></i> Policy</span>',
        'security_rule': '<span class="badge bg-danger"><i class="fas fa-lock"></i> Security</span>',
        'content_filter': '<span class="badge bg-warning text-dark"><i class="fas fa-filter"></i> Content</span>',
        'sender_filter': '<span class="badge bg-info"><i class="fas fa-user"></i> Sender</span>',
        'attachment_filter': '<span class="badge bg-secondary"><i class="fas fa-paperclip"></i> Attachment</span>',
        'advanced_rule': '<span class="badge bg-success"><i class="fas fa-brain"></i> Advanced</span>'
    };
    return badges[ruleType] || '<span class="badge bg-light text-dark">' + ruleType + '</span>';
}

function getActionBadge(action) {
    const badges = {
        'flag': '<span class="badge bg-warning text-dark"><i class="fas fa-flag"></i> Flag</span>',
        'block': '<span class="badge bg-danger"><i class="fas fa-ban"></i> Block</span>',
        'escalate': '<span class="badge bg-info"><i class="fas fa-arrow-up"></i> Escalate</span>',
        'notify': '<span class="badge bg-primary"><i class="fas fa-bell"></i> Notify</span>',
        'quarantine': '<span class="badge bg-dark"><i class="fas fa-shield-virus"></i> Quarantine</span>',
        'whitelist': '<span class="badge bg-success"><i class="fas fa-check"></i> Whitelist</span>'
    };
    return badges[action] || '<span class="badge bg-secondary">' + action + '</span>';
}

function showPoliciesError(message) {
    document.getElementById('policiesErrorMessage').textContent = message;
    document.getElementById('policiesErrorContainer').style.display = 'block';
}

function refreshPolicies() {
    loadAllPolicies();
}

function createNewPolicy() {
    // Close the policies modal and open the rule builder
    bootstrap.Modal.getInstance(document.getElementById('viewPoliciesModal')).hide();
    setTimeout(() => {
        document.getElementById('ruleType').value = 'policy';
        document.getElementById('ruleAction').value = 'flag';
        new bootstrap.Modal(document.getElementById('addRuleModal')).show();
    }, 300);
}

function editPolicy(policyId) {
    // Use existing editRule function
    editRule(policyId);
    bootstrap.Modal.getInstance(document.getElementById('viewPoliciesModal')).hide();
}

function togglePolicy(policyId, isActive) {
    // Use existing toggleRule function
    toggleRule(policyId, isActive);
}

function deletePolicy(policyId) {
    // Use existing deleteRule function
    deleteRule(policyId);
}

function escapeHtml(text) {
    const div = document.createElement('div');
    div.textContent = text;
    return div.innerHTML;
}

// Initialize
document.addEventListener('DOMContentLoaded', function() {
    loadAvailableFields();

    // Add initial condition when modal is shown
    document.getElementById('addRuleModal').addEventListener('shown.bs.modal', function() {
        if (document.querySelectorAll('.condition-row').length === 0) {
            addCondition();
        }
    });

    // Update preview when logic type changes
    document.querySelectorAll('input[name="logic_type"]').forEach(radio => {
        radio.addEventListener('change', updatePreview);
    });

    // Update preview when rule name changes
    document.getElementById('ruleName').addEventListener('input', updatePreview);

    {% if rules %}
    // Initialize DataTable
    $('#rulesTable').DataTable({
        order: [[6, 'desc']],
        pageLength: 25,
        columnDefs: [{ orderable: false, targets: [7] }]
    });
    {% endif %}
});
</script>
{% endblock %}