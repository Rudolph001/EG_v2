{% extends "base.html" %}

{% block title %}Flagged Senders - Email Guardian{% endblock %}

{% block content %}
<div class="row">
    <div class="col-12">
        <div class="d-flex justify-content-between align-items-center mb-4">
            <h1>
                <i class="fas fa-flag"></i>
                Flagged Senders Management
            </h1>
            <div>
                <button type="button" class="btn btn-danger" data-bs-toggle="modal" data-bs-target="#addFlagModal">
                    <i class="fas fa-plus"></i>
                    Add Flagged Sender
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Flagged Senders Table -->
<div class="row">
    <div class="col-12">
        <div class="card">
            <div class="card-header">
                <h5 class="mb-0">
                    <i class="fas fa-table"></i>
                    Flagged Senders List
                </h5>
            </div>
            <div class="card-body p-0">
                {% if senders %}
                <div class="table-responsive">
                    <table class="table table-striped table-hover mb-0" id="flaggedSendersTable">
                        <thead class="table-dark">
                            <tr>
                                <th>Sender Email</th>
                                <th>Domain</th>
                                <th>Reason</th>
                                <th>Flagged Date</th>
                                <th>Risk Level</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for sender in senders %}
                            <tr>
                                <td>
                                    <div class="d-flex align-items-center">
                                        <div class="me-2">
                                            <i class="fas fa-user-times text-danger"></i>
                                        </div>
                                        <div>
                                            <strong>{{ sender[1] or 'Unknown' }}</strong>
                                            {% if '@' in (sender[1] or '') %}
                                            <br><small class="text-muted">{{ sender[1].split('@')[0] }}</small>
                                            {% endif %}
                                        </div>
                                    </div>
                                </td>
                                <td>
                                    {% if '@' in (sender[1] or '') %}
                                    <span class="badge bg-info">{{ sender[1].split('@')[1] }}</span>
                                    {% else %}
                                    <span class="badge bg-secondary">Unknown</span>
                                    {% endif %}
                                </td>
                                <td>
                                    <div class="text-break" style="max-width: 300px;">
                                        {{ sender[2] or 'No reason provided' }}
                                    </div>
                                    
                                    <!-- Show reason category badge -->
                                    {% if 'Suspicious' in (sender[2] or '') %}
                                        <span class="badge bg-warning text-dark mt-1">Suspicious</span>
                                    {% elif 'Policy' in (sender[2] or '') %}
                                        <span class="badge bg-danger mt-1">Policy Violation</span>
                                    {% elif 'Spam' in (sender[2] or '') %}
                                        <span class="badge bg-secondary mt-1">Spam</span>
                                    {% elif 'Phishing' in (sender[2] or '') %}
                                        <span class="badge bg-danger mt-1">Phishing</span>
                                    {% else %}
                                        <span class="badge bg-info mt-1">Other</span>
                                    {% endif %}
                                </td>
                                <td>
                                    <small class="text-muted">
                                        {{ sender[3].strftime('%Y-%m-%d %H:%M') if sender[3] else 'N/A' }}
                                    </small>
                                </td>
                                <td>
                                    {% if 'Phishing' in (sender[2] or '') or 'Malware' in (sender[2] or '') %}
                                        <span class="badge bg-danger">High Risk</span>
                                    {% elif 'Suspicious' in (sender[2] or '') or 'Policy' in (sender[2] or '') %}
                                        <span class="badge bg-warning text-dark">Medium Risk</span>
                                    {% else %}
                                        <span class="badge bg-info">Low Risk</span>
                                    {% endif %}
                                </td>
                                <td>
                                    <div class="btn-group btn-group-sm" role="group">
                                        <button type="button" class="btn btn-outline-primary" 
                                                onclick="viewSenderHistory('{{ sender[1] }}')" 
                                                title="View Email History">
                                            <i class="fas fa-history"></i>
                                        </button>
                                        <button type="button" class="btn btn-outline-warning" 
                                                onclick="editFlag({{ sender[0] }}, '{{ sender[1] }}', '{{ sender[2] }}')" 
                                                title="Edit Flag">
                                            <i class="fas fa-edit"></i>
                                        </button>
                                        <button type="button" class="btn btn-outline-success" 
                                                onclick="removeFlag({{ sender[0] }})" 
                                                title="Remove Flag">
                                            <i class="fas fa-check"></i>
                                        </button>
                                    </div>
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
                {% else %}
                <div class="text-center py-5">
                    <i class="fas fa-flag fa-3x text-muted mb-3"></i>
                    <h5 class="text-muted">No flagged senders</h5>
                    <p class="text-muted">No senders have been flagged yet.</p>
                    <button type="button" class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#addFlagModal">
                        <i class="fas fa-plus"></i> Add First Flagged Sender
                    </button>
                </div>
                {% endif %}
            </div>
        </div>
    </div>
</div>

<!-- Statistics Cards -->
{% if senders %}
<div class="row mt-4">
    <div class="col-12">
        <div class="card border-warning">
            <div class="card-header bg-warning text-dark">
                <h5 class="mb-0">
                    <i class="fas fa-chart-pie"></i>
                    Flagging Statistics
                </h5>
            </div>
            <div class="card-body">
                <div class="row text-center">
                    {% set risk_stats = {'high': 0, 'medium': 0, 'low': 0} %}
                    {% set domain_stats = {} %}
                    
                    {% for sender in senders %}
                        {% set reason = sender[2] or '' %}
                        {% if 'Phishing' in reason or 'Malware' in reason %}
                            {% set _ = risk_stats.update({'high': risk_stats['high'] + 1}) %}
                        {% elif 'Suspicious' in reason or 'Policy' in reason %}
                            {% set _ = risk_stats.update({'medium': risk_stats['medium'] + 1}) %}
                        {% else %}
                            {% set _ = risk_stats.update({'low': risk_stats['low'] + 1}) %}
                        {% endif %}
                        
                        {% if '@' in (sender[1] or '') %}
                            {% set domain = sender[1].split('@')[1] %}
                            {% if domain in domain_stats %}
                                {% set _ = domain_stats.update({domain: domain_stats[domain] + 1}) %}
                            {% else %}
                                {% set _ = domain_stats.update({domain: 1}) %}
                            {% endif %}
                        {% endif %}
                    {% endfor %}
                    
                    <div class="col-md-3">
                        <div class="p-3">
                            <i class="fas fa-exclamation-triangle text-danger fa-2x mb-2"></i>
                            <h4 class="mb-1 text-danger">{{ risk_stats['high'] }}</h4>
                            <p class="text-muted mb-0">High Risk</p>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="p-3">
                            <i class="fas fa-exclamation-circle text-warning fa-2x mb-2"></i>
                            <h4 class="mb-1 text-warning">{{ risk_stats['medium'] }}</h4>
                            <p class="text-muted mb-0">Medium Risk</p>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="p-3">
                            <i class="fas fa-info-circle text-info fa-2x mb-2"></i>
                            <h4 class="mb-1 text-info">{{ risk_stats['low'] }}</h4>
                            <p class="text-muted mb-0">Low Risk</p>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="p-3">
                            <i class="fas fa-globe text-primary fa-2x mb-2"></i>
                            <h4 class="mb-1 text-primary">{{ domain_stats|length }}</h4>
                            <p class="text-muted mb-0">Unique Domains</p>
                        </div>
                    </div>
                </div>
                
                {% if domain_stats %}
                <hr>
                <h6>Top Flagged Domains:</h6>
                <div class="row">
                    {% for domain, count in (domain_stats.items()|list|sort(attribute=1, reverse=true))[:6] %}
                    <div class="col-md-2">
                        <div class="text-center p-2 border rounded">
                            <strong>{{ domain }}</strong>
                            <br>
                            <span class="badge bg-danger">{{ count }}</span>
                        </div>
                    </div>
                    {% endfor %}
                </div>
                {% endif %}
            </div>
        </div>
    </div>
</div>
{% endif %}

<!-- Add Flag Modal -->
<div class="modal fade" id="addFlagModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Add Flagged Sender</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form id="addFlagForm">
                    <div class="mb-3">
                        <label for="newSenderEmail" class="form-label">Sender Email</label>
                        <input type="email" class="form-control" id="newSenderEmail" name="sender" 
                               required placeholder="example@domain.com">
                    </div>
                    <div class="mb-3">
                        <label for="newFlagReason" class="form-label">Reason for Flagging</label>
                        <select class="form-select" id="newFlagReason" name="reason" required>
                            <option value="">Select a reason...</option>
                            <option value="Suspicious Activity">Suspicious Activity</option>
                            <option value="Policy Violation">Policy Violation</option>
                            <option value="Spam">Spam</option>
                            <option value="Phishing Attempt">Phishing Attempt</option>
                            <option value="Malware Distribution">Malware Distribution</option>
                            <option value="Inappropriate Content">Inappropriate Content</option>
                            <option value="Other">Other</option>
                        </select>
                    </div>
                    <div class="mb-3">
                        <label for="newAdditionalNotes" class="form-label">Additional Details</label>
                        <textarea class="form-control" id="newAdditionalNotes" name="additional_notes" 
                                  rows="3" placeholder="Provide additional context..."></textarea>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-danger" onclick="submitNewFlag()">
                    <i class="fas fa-flag"></i> Flag Sender
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Edit Flag Modal -->
<div class="modal fade" id="editFlagModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Edit Flagged Sender</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form id="editFlagForm">
                    <input type="hidden" id="editFlagId" name="flag_id">
                    <div class="mb-3">
                        <label for="editSenderEmail" class="form-label">Sender Email</label>
                        <input type="email" class="form-control" id="editSenderEmail" name="sender" readonly>
                    </div>
                    <div class="mb-3">
                        <label for="editFlagReason" class="form-label">Reason for Flagging</label>
                        <textarea class="form-control" id="editFlagReason" name="reason" 
                                  rows="3" required></textarea>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-warning" onclick="submitEditFlag()">
                    <i class="fas fa-save"></i> Update Flag
                </button>
            </div>
        </div>
    </div>
</div>

<script>
function submitNewFlag() {
    const formData = new FormData(document.getElementById('addFlagForm'));
    const reason = formData.get('reason');
    const notes = formData.get('additional_notes');
    const fullReason = notes ? `${reason}: ${notes}` : reason;
    
    const data = {
        sender: formData.get('sender'),
        reason: fullReason
    };
    
    fetch('/api/flag-sender', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify(data)
    })
    .then(response => response.json())
    .then(result => {
        if (result.success) {
            bootstrap.Modal.getInstance(document.getElementById('addFlagModal')).hide();
            location.reload();
        } else {
            alert('Error: ' + result.error);
        }
    })
    .catch(error => {
        console.error('Error:', error);
        alert('An error occurred while flagging the sender.');
    });
}

function editFlag(flagId, sender, reason) {
    document.getElementById('editFlagId').value = flagId;
    document.getElementById('editSenderEmail').value = sender;
    document.getElementById('editFlagReason').value = reason;
    new bootstrap.Modal(document.getElementById('editFlagModal')).show();
}

function submitEditFlag() {
    // Implementation would need an API endpoint for updating flags
    alert('Edit functionality would be implemented with an update API endpoint');
}

function removeFlag(flagId) {
    if (!confirm('Are you sure you want to remove this flag? This action cannot be undone.')) {
        return;
    }
    
    // Implementation would need an API endpoint for removing flags
    alert('Remove functionality would be implemented with a delete API endpoint');
}

function viewSenderHistory(senderEmail) {
    // Redirect to emails page filtered by this sender
    window.location.href = `/emails?search=${encodeURIComponent(senderEmail)}`;
}

// Initialize DataTable if we have senders
{% if senders %}
$(document).ready(function() {
    $('#flaggedSendersTable').DataTable({
        order: [[3, 'desc']],
        pageLength: 25,
        columnDefs: [
            { orderable: false, targets: [5] }
        ]
    });
});
{% endif %}
</script>
{% endblock %}
