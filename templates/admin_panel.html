{% extends "base.html" %}

{% block title %}Admin Panel - Email Guardian{% endblock %}

{% block content %}
<div class="container-fluid">
    <div class="row mb-4">
        <div class="col-12">
            <div class="card shadow-lg border-0">
                <div class="card-header bg-dark text-white py-4">
                    <h1 class="h3 mb-0 text-center">
                        <i class="fas fa-cogs me-3"></i>
                        ADMIN CONTROL PANEL
                        <small class="d-block mt-2 text-light">System Configuration & Management</small>
                    </h1>
                </div>
            </div>
        </div>
    </div>

    <!-- Quick Stats Dashboard -->
    <div class="row mb-5">
        <div class="col-md-2">
            <div class="card bg-primary text-white shadow">
                <div class="card-body text-center py-4">
                    <i class="fas fa-ban fa-3x mb-3"></i>
                    <h5>Exclusion Rules</h5>
                    <h2 id="exclusionCount">{{ stats.exclusion_rules or 0 }}</h2>
                </div>
            </div>
        </div>
        <div class="col-md-2">
            <div class="card bg-success text-white shadow">
                <div class="card-body text-center py-4">
                    <i class="fas fa-check-circle fa-3x mb-3"></i>
                    <h5>Whitelist Rules</h5>
                    <h2 id="whitelistCount">{{ stats.whitelist_rules or 0 }}</h2>
                </div>
            </div>
        </div>
        <div class="col-md-2">
            <div class="card bg-warning text-white shadow">
                <div class="card-body text-center py-4">
                    <i class="fas fa-shield-alt fa-3x mb-3"></i>
                    <h5>Security Rules</h5>
                    <h2 id="securityCount">{{ stats.security_rules or 0 }}</h2>
                </div>
            </div>
        </div>
        <div class="col-md-2">
            <div class="card bg-danger text-white shadow">
                <div class="card-body text-center py-4">
                    <i class="fas fa-exclamation-triangle fa-3x mb-3"></i>
                    <h5>Risk Keywords</h5>
                    <h2 id="riskKeywordCount">{{ stats.risk_keywords or 0 }}</h2>
                </div>
            </div>
        </div>
        <div class="col-md-2">
            <div class="card bg-info text-white shadow">
                <div class="card-body text-center py-4">
                    <i class="fas fa-times-circle fa-3x mb-3"></i>
                    <h5>Exclude Keywords</h5>
                    <h2 id="excludeKeywordCount">{{ stats.exclude_keywords or 0 }}</h2>
                </div>
            </div>
        </div>
        <div class="col-md-2">
            <div class="card bg-secondary text-white shadow">
                <div class="card-body text-center py-4">
                    <i class="fas fa-robot fa-3x mb-3"></i>
                    <h5>ML Models</h5>
                    <h2 id="mlModelCount">{{ stats.ml_models or 1 }}</h2>
                </div>
            </div>
        </div>
    </div>

    <!-- Simple Grid Layout for Admin Sections -->
    <div class="row g-4">
        <!-- Exclusion Rules Section -->
        <div class="col-lg-6">
            <div class="card h-100 shadow">
                <div class="card-header bg-primary text-white">
                    <h4 class="mb-0">
                        <i class="fas fa-ban me-2"></i>
                        EXCLUSION RULES
                    </h4>
                </div>
                <div class="card-body">
                    <p class="text-muted">Manage email exclusion rules and patterns.</p>
                    <div class="d-grid">
                        <button class="btn btn-primary btn-lg" onclick="showRuleModal('exclusion')">
                            <i class="fas fa-plus me-2"></i>
                            Add New Exclusion Rule
                        </button>
                    </div>
                    <div class="mt-3">
                        <div class="table-responsive">
                            <table class="table table-sm" id="exclusionRulesTable">
                                <thead class="table-dark">
                                    <tr>
                                        <th>Rule Name</th>
                                        <th>Status</th>
                                        <th>Actions</th>
                                    </tr>
                                </thead>
                                <tbody id="exclusionRulesBody">
                                    <!-- Dynamic content -->
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Whitelist Management Section -->
        <div class="col-lg-6">
            <div class="card h-100 shadow">
                <div class="card-header bg-success text-white">
                    <h4 class="mb-0">
                        <i class="fas fa-check-circle me-2"></i>
                        WHITELIST MANAGEMENT
                    </h4>
                </div>
                <div class="card-body">
                    <p class="text-muted">Manage trusted senders and domains.</p>
                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label class="form-label fw-bold">Add Trusted Sender</label>
                            <div class="input-group">
                                <input type="email" class="form-control" id="newSender" placeholder="email@domain.com">
                                <button class="btn btn-success" onclick="addWhitelistItem('sender')">
                                    <i class="fas fa-plus"></i>
                                </button>
                            </div>
                        </div>
                        <div class="col-md-6 mb-3">
                            <label class="form-label fw-bold">Add Trusted Domain</label>
                            <div class="input-group">
                                <input type="text" class="form-control" id="newDomain" placeholder="company.com">
                                <button class="btn btn-success" onclick="addWhitelistItem('domain')">
                                    <i class="fas fa-plus"></i>
                                </button>
                            </div>
                        </div>
                    </div>
                    <div class="row">
                        <div class="col-md-6">
                            <h6 class="fw-bold">Trusted Senders</h6>
                            <div id="whitelistSenders" class="border rounded p-2" style="height: 150px; overflow-y: auto;">
                                <!-- Dynamic content -->
                            </div>
                        </div>
                        <div class="col-md-6">
                            <h6 class="fw-bold">Trusted Domains</h6>
                            <div id="whitelistDomains" class="border rounded p-2" style="height: 150px; overflow-y: auto;">
                                <!-- Dynamic content -->
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Security Rules Section -->
        <div class="col-lg-6">
            <div class="card h-100 shadow">
                <div class="card-header bg-warning text-dark">
                    <h4 class="mb-0">
                        <i class="fas fa-shield-alt me-2"></i>
                        SECURITY RULES
                    </h4>
                </div>
                <div class="card-body">
                    <p class="text-muted">Configure security threat detection rules.</p>
                    <div class="d-grid">
                        <button class="btn btn-warning btn-lg" onclick="showRuleModal('security')">
                            <i class="fas fa-plus me-2"></i>
                            Add Security Rule
                        </button>
                    </div>
                    <div class="mt-3">
                        <div class="table-responsive">
                            <table class="table table-sm" id="securityRulesTable">
                                <thead class="table-dark">
                                    <tr>
                                        <th>Rule Name</th>
                                        <th>Risk Level</th>
                                        <th>Actions</th>
                                    </tr>
                                </thead>
                                <tbody id="securityRulesBody">
                                    <!-- Dynamic content -->
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Keyword Management Section -->
        <div class="col-lg-6">
            <div class="card h-100 shadow">
                <div class="card-header bg-info text-white">
                    <h4 class="mb-0">
                        <i class="fas fa-tags me-2"></i>
                        KEYWORD MANAGEMENT
                    </h4>
                </div>
                <div class="card-body">
                    <div class="row">
                        <div class="col-md-6">
                            <div class="card border-danger">
                                <div class="card-header bg-danger text-white">
                                    <h6 class="mb-0">Risk Keywords</h6>
                                </div>
                                <div class="card-body">
                                    <div class="input-group mb-2">
                                        <input type="text" class="form-control" id="newRiskKeyword" placeholder="Add risk keyword">
                                        <button class="btn btn-danger" onclick="addKeyword('risk')">
                                            <i class="fas fa-plus"></i>
                                        </button>
                                    </div>
                                    <div id="riskKeywords" class="keyword-container" style="height: 150px;">
                                        <!-- Dynamic content -->
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="card border-secondary">
                                <div class="card-header bg-secondary text-white">
                                    <h6 class="mb-0">Exclusion Keywords</h6>
                                </div>
                                <div class="card-body">
                                    <div class="input-group mb-2">
                                        <input type="text" class="form-control" id="newExcludeKeyword" placeholder="Add exclusion keyword">
                                        <button class="btn btn-secondary" onclick="addKeyword('exclude')">
                                            <i class="fas fa-plus"></i>
                                        </button>
                                    </div>
                                    <div id="excludeKeywords" class="keyword-container" style="height: 150px;">
                                        <!-- Dynamic content -->
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- ML Settings Section -->
        <div class="col-lg-6">
            <div class="card h-100 shadow">
                <div class="card-header bg-dark text-white">
                    <h4 class="mb-0">
                        <i class="fas fa-robot me-2"></i>
                        MACHINE LEARNING
                    </h4>
                </div>
                <div class="card-body">
                    <div class="row">
                        <div class="col-md-6">
                            <label class="form-label fw-bold">Risk Threshold</label>
                            <input type="range" class="form-range" id="riskThreshold" min="0" max="100" value="70">
                            <div class="text-center">
                                <span id="riskThresholdValue" class="badge bg-primary">70</span>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <label class="form-label fw-bold">Confidence Level</label>
                            <input type="range" class="form-range" id="confidenceThreshold" min="0" max="100" value="85">
                            <div class="text-center">
                                <span id="confidenceThresholdValue" class="badge bg-success">85</span>
                            </div>
                        </div>
                    </div>
                    <hr>
                    <div class="d-grid gap-2">
                        <button class="btn btn-primary" onclick="trainModel()">
                            <i class="fas fa-brain me-2"></i>
                            Train Basic Model
                        </button>
                        <button class="btn btn-success" onclick="trainAdvancedModels()">
                            <i class="fas fa-robot me-2"></i>
                            Train Advanced Models
                        </button>
                        <button class="btn btn-outline-secondary" onclick="saveMLSettings()">
                            <i class="fas fa-save me-2"></i>
                            Save Settings
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <!-- Database Management Section -->
        <div class="col-lg-6">
            <div class="card h-100 shadow border-danger">
                <div class="card-header bg-danger text-white">
                    <h4 class="mb-0">
                        <i class="fas fa-database me-2"></i>
                        DATABASE MANAGEMENT
                    </h4>
                </div>
                <div class="card-body">
                    <div class="alert alert-warning">
                        <i class="fas fa-exclamation-triangle me-2"></i>
                        <strong>Warning:</strong> These operations permanently delete data!
                    </div>

                    <div class="row">
                        <div class="col-md-6 mb-2">
                            <button class="btn btn-outline-danger w-100" onclick="clearEmails()">
                                <i class="fas fa-envelope me-2"></i>
                                Clear All Emails
                            </button>
                        </div>
                        <div class="col-md-6 mb-2">
                            <button class="btn btn-outline-warning w-100" onclick="clearCases()">
                                <i class="fas fa-gavel me-2"></i>
                                Clear All Cases
                            </button>
                        </div>
                        <div class="col-md-6 mb-2">
                            <button class="btn btn-outline-info w-100" onclick="clearFlaggedSenders()">
                                <i class="fas fa-user-times me-2"></i>
                                Clear Flagged Senders
                            </button>
                        </div>
                        <div class="col-md-6 mb-2">
                            <button class="btn btn-danger w-100" onclick="clearAllData()">
                                <i class="fas fa-nuclear me-2"></i>
                                Reset Everything
                            </button>
                        </div>
                    </div>

                    <hr>

                    <div class="row text-center">
                        <div class="col-3">
                            <div class="h5 text-primary" id="emailCount">-</div>
                            <small>Emails</small>
                        </div>
                        <div class="col-3">
                            <div class="h5 text-warning" id="caseCount">-</div>
                            <small>Cases</small>
                        </div>
                        <div class="col-3">
                            <div class="h5 text-info" id="flaggedCount">-</div>
                            <small>Flagged</small>
                        </div>
                        <div class="col-3">
                            <div class="h5 text-success" id="rulesCount">-</div>
                            <small>Rules</small>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Rule Modal -->
<div class="modal fade" id="ruleModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header bg-primary text-white">
                <h5 class="modal-title" id="ruleModalTitle">Add Rule</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form id="ruleForm">
                    <input type="hidden" id="ruleType" name="rule_type">
                    <input type="hidden" id="ruleId" name="rule_id">

                    <div class="mb-3">
                        <label class="form-label fw-bold">Rule Name</label>
                        <input type="text" class="form-control" id="ruleName" name="rule_name" required>
                    </div>

                    <div class="mb-3">
                        <label class="form-label fw-bold">Logic Type</label>
                        <select class="form-select" id="ruleLogic" name="logic_type" required>
                            <option value="AND">AND (All conditions must match)</option>
                            <option value="OR">OR (Any condition can match)</option>
                        </select>
                    </div>

                    <div class="mb-3">
                        <label class="form-label fw-bold">Conditions</label>
                        <div id="conditionsContainer">
                            <!-- Dynamic conditions will be added here -->
                        </div>
                        <button type="button" class="btn btn-outline-primary btn-sm" onclick="addCondition()">
                            <i class="fas fa-plus"></i> Add Condition
                        </button>
                    </div>

                    <div class="mb-3" id="riskLevelContainer" style="display: none;">
                        <label class="form-label fw-bold">Risk Level</label>
                        <select class="form-select" id="riskLevel" name="risk_level">
                            <option value="low">Low</option>
                            <option value="medium">Medium</option>
                            <option value="high">High</option>
                            <option value="critical">Critical</option>
                        </select>
                    </div>

                    <div class="mb-3">
                        <div class="form-check">
                            <input class="form-check-input" type="checkbox" id="ruleActive" name="is_active" checked>
                            <label class="form-check-label fw-bold" for="ruleActive">
                                Enable rule immediately
                            </label>
                        </div>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-primary" onclick="saveRule()">
                    <i class="fas fa-save"></i> Save Rule
                </button>
            </div>
        </div>
    </div>
</div>

<style>
.keyword-container {
    overflow-y: auto;
    border: 1px solid #dee2e6;
    border-radius: 0.375rem;
    padding: 0.5rem;
    background-color: #f8f9fa;
}

.keyword-tag {
    display: inline-block;
    background-color: #e9ecef;
    border: 1px solid #adb5bd;
    border-radius: 0.25rem;
    padding: 0.25rem 0.5rem;
    margin: 0.125rem;
    font-size: 0.875rem;
}

.keyword-tag .remove-keyword {
    margin-left: 0.5rem;
    color: #dc3545;
    cursor: pointer;
}

.condition-row {
    border: 1px solid #dee2e6;
    border-radius: 0.375rem;
    padding: 1rem;
    margin-bottom: 0.5rem;
    background-color: #f8f9fa;
}

.whitelist-item {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 0.25rem 0.5rem;
    margin-bottom: 0.25rem;
    background-color: #e9ecef;
    border-radius: 0.25rem;
    font-size: 0.875rem;
}

.whitelist-item .remove-item {
    color: #dc3545;
    cursor: pointer;
}

.card {
    transition: transform 0.2s ease;
}

.card:hover {
    transform: translateY(-2px);
}
</style>

<script>
let conditionCounter = 0;
let currentRuleType = '';

// Initialize page
document.addEventListener('DOMContentLoaded', function() {
    loadRules();
    loadKeywords();
    loadWhitelist();
    loadMLSettings();
    refreshDatabaseStats();

    // Setup threshold value displays
    document.getElementById('riskThreshold').addEventListener('input', function() {
        document.getElementById('riskThresholdValue').textContent = this.value;
    });

    document.getElementById('confidenceThreshold').addEventListener('input', function() {
        document.getElementById('confidenceThresholdValue').textContent = this.value;
    });
});

function showRuleModal(ruleType) {
    currentRuleType = ruleType;
    document.getElementById('ruleType').value = ruleType;
    document.getElementById('ruleModalTitle').textContent = `Add ${ruleType.charAt(0).toUpperCase() + ruleType.slice(1)} Rule`;

    // Show/hide risk level for security rules
    if (ruleType === 'security') {
        document.getElementById('riskLevelContainer').style.display = 'block';
    } else {
        document.getElementById('riskLevelContainer').style.display = 'none';
    }

    // Clear form
    document.getElementById('ruleForm').reset();
    document.getElementById('conditionsContainer').innerHTML = '';
    conditionCounter = 0;
    addCondition();

    new bootstrap.Modal(document.getElementById('ruleModal')).show();
}

function addCondition() {
    const container = document.getElementById('conditionsContainer');
    const conditionId = `condition_${conditionCounter++}`;

    const conditionHtml = `
        <div class="condition-row" id="${conditionId}">
            <div class="row">
                <div class="col-md-3">
                    <label class="form-label">Field</label>
                    <select class="form-select condition-field" onchange="updateOperators('${conditionId}')">
                        <option value="sender">Sender</option>
                        <option value="subject">Subject</option>
                        <option value="domain">Domain</option>
                        <option value="attachment">Attachment</option>
                        <option value="department">Department</option>
                        <option value="recipient">Recipient</option>
                    </select>
                </div>
                <div class="col-md-3">
                    <label class="form-label">Operator</label>
                    <select class="form-select condition-operator">
                        <option value="contains">Contains</option>
                        <option value="equals">Equals</option>
                        <option value="starts_with">Starts With</option>
                        <option value="ends_with">Ends With</option>
                        <option value="regex">Regex Match</option>
                    </select>
                </div>
                <div class="col-md-5">
                    <label class="form-label">Value</label>
                    <input type="text" class="form-control condition-value" placeholder="Enter value">
                </div>
                <div class="col-md-1 d-flex align-items-end">
                    <button type="button" class="btn btn-outline-danger btn-sm" onclick="removeCondition('${conditionId}')">
                        <i class="fas fa-trash"></i>
                    </button>
                </div>
            </div>
        </div>
    `;

    container.insertAdjacentHTML('beforeend', conditionHtml);
}

function removeCondition(conditionId) {
    document.getElementById(conditionId).remove();
}

function updateOperators(conditionId) {
    const field = document.querySelector(`#${conditionId} .condition-field`).value;
    const operatorSelect = document.querySelector(`#${conditionId} .condition-operator`);

    // Reset operators
    operatorSelect.innerHTML = `
        <option value="contains">Contains</option>
        <option value="equals">Equals</option>
        <option value="starts_with">Starts With</option>
        <option value="ends_with">Ends With</option>
        <option value="regex">Regex Match</option>
    `;

    // Add field-specific operators
    if (field === 'attachment') {
        operatorSelect.innerHTML += `
            <option value="has_extension">Has Extension</option>
            <option value="file_size_gt">File Size Greater Than</option>
            <option value="file_size_lt">File Size Less Than</option>
        `;
    }
}

function saveRule() {
    const form = document.getElementById('ruleForm');
    const formData = new FormData(form);

    // Collect conditions
    const conditions = [];
    document.querySelectorAll('.condition-row').forEach(row => {
        const field = row.querySelector('.condition-field').value;
        const operator = row.querySelector('.condition-operator').value;
        const value = row.querySelector('.condition-value').value;

        if (field && operator && value) {
            conditions.push({ field, operator, value });
        }
    });

    const ruleData = {
        rule_type: formData.get('rule_type'),
        rule_name: formData.get('rule_name'),
        logic_type: formData.get('logic_type'),
        conditions: JSON.stringify(conditions),
        risk_level: formData.get('risk_level'),
        is_active: formData.get('is_active') ? true : false
    };

    fetch('/api/admin/save-rule', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify(ruleData)
    })
    .then(response => response.json())
    .then(result => {
        if (result.success) {
            bootstrap.Modal.getInstance(document.getElementById('ruleModal')).hide();
            loadRules();
            showAlert('Rule saved successfully', 'success');
        } else {
            showAlert('Error: ' + result.error, 'danger');
        }
    })
    .catch(error => {
        console.error('Error:', error);
        showAlert('An error occurred while saving the rule.', 'danger');
    });
}

function addKeyword(type) {
    const inputId = type === 'risk' ? 'newRiskKeyword' : 'newExcludeKeyword';
    const keyword = document.getElementById(inputId).value.trim();

    if (!keyword) return;

    fetch('/api/admin/add-keyword', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify({ type: type, keyword: keyword })
    })
    .then(response => response.json())
    .then(result => {
        if (result.success) {
            document.getElementById(inputId).value = '';
            loadKeywords();
            showAlert('Keyword added successfully', 'success');
        } else {
            showAlert('Error: ' + result.error, 'danger');
        }
    });
}

function removeKeyword(type, keyword) {
    fetch('/api/admin/remove-keyword', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify({ type: type, keyword: keyword })
    })
    .then(response => response.json())
    .then(result => {
        if (result.success) {
            loadKeywords();
            showAlert('Keyword removed successfully', 'success');
        } else {
            showAlert('Error: ' + result.error, 'danger');
        }
    });
}

function addWhitelistItem(type) {
    const inputId = type === 'sender' ? 'newSender' : 'newDomain';
    const value = document.getElementById(inputId).value.trim();

    if (!value) return;

    fetch('/api/admin/add-whitelist', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify({ type: type, value: value })
    })
    .then(response => response.json())
    .then(result => {
        if (result.success) {
            document.getElementById(inputId).value = '';
            loadWhitelist();
            showAlert('Whitelist item added successfully', 'success');
        } else {
            showAlert('Error: ' + result.error, 'danger');
        }
    });
}

function removeWhitelistItem(type, value) {
    fetch('/api/admin/remove-whitelist', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify({ type: type, value: value })
    })
    .then(response => response.json())
    .then(result => {
        if (result.success) {
            loadWhitelist();
            showAlert('Whitelist item removed successfully', 'success');
        } else {
            showAlert('Error: ' + result.error, 'danger');
        }
    });
}

function saveMLSettings() {
    const settings = {
        risk_threshold: document.getElementById('riskThreshold').value,
        confidence_threshold: document.getElementById('confidenceThreshold').value,
        retrain_frequency: 'weekly',
        enable_ml_override: true,
        enable_auto_escalation: true
    };

    fetch('/api/admin/save-ml-settings', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify(settings)
    })
    .then(response => response.json())
    .then(result => {
        if (result.success) {
            showAlert('ML settings saved successfully', 'success');
        } else {
            showAlert('Error: ' + result.error, 'danger');
        }
    });
}

function trainModel() {
    fetch('/api/train-model', {
        method: 'POST'
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            showAlert(`Model trained successfully! Accuracy: ${(data.accuracy * 100).toFixed(1)}%`, 'success');
        } else {
            showAlert('Error training model: ' + data.error, 'danger');
        }
    })
    .catch(error => {
        console.error('Error:', error);
        showAlert('Error training model', 'danger');
    });
}

function trainAdvancedModels() {
    const button = event.target;
    button.disabled = true;
    button.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Training...';

    fetch('/api/train-advanced-models', {
        method: 'POST'
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            const results = data.results;
            showAlert(`Advanced models trained successfully! Accuracy: ${(results.ensemble_accuracy * 100).toFixed(1)}%`, 'success');
        } else {
            showAlert('Error training advanced models: ' + data.error, 'danger');
        }
    })
    .catch(error => {
        console.error('Error:', error);
        showAlert('Error training advanced models', 'danger');
    })
    .finally(() => {
        button.disabled = false;
        button.innerHTML = '<i class="fas fa-robot me-2"></i> Train Advanced Models';
    });
}

function loadRules() {
    // Load rules for all types
    ['exclusion', 'whitelist', 'security'].forEach(type => {
        fetch(`/api/admin/rules/${type}`)
        .then(response => response.json())
        .then(rules => {
            const tbody = document.getElementById(`${type}RulesBody`);
            tbody.innerHTML = '';

            rules.forEach(rule => {
                const row = createRuleRow(rule, type);
                tbody.appendChild(row);
            });
        });
    });
}

function createRuleRow(rule, type) {
    const row = document.createElement('tr');
    row.innerHTML = `
        <td>${rule.rule_name}</td>
        <td>
            <span class="badge bg-${rule.is_active ? 'success' : 'secondary'}">
                ${rule.is_active ? 'Active' : 'Inactive'}
            </span>
        </td>
        <td>
            <div class="btn-group btn-group-sm">
                <button class="btn btn-outline-primary" onclick="editRule(${rule.id})">
                    <i class="fas fa-edit"></i>
                </button>
                <button class="btn btn-outline-danger" onclick="deleteRule(${rule.id})">
                    <i class="fas fa-trash"></i>
                </button>
            </div>
        </td>
    `;
    return row;
}

function loadKeywords() {
    ['risk', 'exclude'].forEach(type => {
        fetch(`/api/admin/keywords/${type}`)
        .then(response => response.json())
        .then(keywords => {
            const container = document.getElementById(`${type}Keywords`);
            container.innerHTML = '';

            keywords.forEach(keyword => {
                const tag = document.createElement('div');
                tag.className = 'keyword-tag';
                tag.innerHTML = `
                    ${keyword}
                    <span class="remove-keyword" onclick="removeKeyword('${type}', '${keyword}')">
                        <i class="fas fa-times"></i>
                    </span>
                `;
                container.appendChild(tag);
            });
        });
    });
}

function loadWhitelist() {
    ['sender', 'domain'].forEach(type => {
        fetch(`/api/admin/whitelist/${type}`)
        .then(response => response.json())
        .then(items => {
            const container = document.getElementById(`whitelist${type.charAt(0).toUpperCase() + type.slice(1)}s`);
            container.innerHTML = '';

            items.forEach(item => {
                const element = document.createElement('div');
                element.className = 'whitelist-item';
                element.innerHTML = `
                    <span>${item}</span>
                    <span class="remove-item" onclick="removeWhitelistItem('${type}', '${item}')">
                        <i class="fas fa-times"></i>
                    </span>
                `;
                container.appendChild(element);
            });
        });
    });
}

function loadMLSettings() {
    fetch('/api/admin/ml-settings')
    .then(response => response.json())
    .then(settings => {
        document.getElementById('riskThreshold').value = settings.risk_threshold || 70;
        document.getElementById('confidenceThreshold').value = settings.confidence_threshold || 85;

        document.getElementById('riskThresholdValue').textContent = settings.risk_threshold || 70;
        document.getElementById('confidenceThresholdValue').textContent = settings.confidence_threshold || 85;
    });
}

function editRule(ruleId) {
    showAlert('Edit rule functionality coming soon', 'info');
}

function deleteRule(ruleId) {
    if (!confirm('Are you sure you want to delete this rule?')) {
        return;
    }

    fetch(`/api/admin/delete-rule/${ruleId}`, {
        method: 'DELETE'
    })
    .then(response => response.json())
    .then(result => {
        if (result.success) {
            loadRules();
            showAlert('Rule deleted successfully', 'success');
        } else {
            showAlert('Error: ' + result.error, 'danger');
        }
    });
}

// Database Management Functions
function clearEmails() {
    if (!confirm('Are you sure you want to delete ALL email records? This action cannot be undone.')) {
        return;
    }

    if (prompt('Type "DELETE" to confirm:') !== 'DELETE') {
        return;
    }

    fetch('/api/admin/clear-emails', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        }
    })
    .then(response => response.json())
    .then(result => {
        if (result.success) {
            showAlert(`Successfully deleted ${result.deleted_count} email records`, 'success');
            refreshDatabaseStats();
        } else {
            showAlert('Error: ' + result.error, 'danger');
        }
    })
    .catch(error => {
        console.error('Error:', error);
        showAlert('Failed to clear email data', 'danger');
    });
}

function clearCases() {
    if (!confirm('Are you sure you want to delete ALL case records? This action cannot be undone.')) {
        return;
    }

    fetch('/api/admin/clear-cases', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        }
    })
    .then(response => response.json())
    .then(result => {
        if (result.success) {
            showAlert(`Successfully deleted ${result.deleted_count} case records`, 'success');
            refreshDatabaseStats();
        } else {
            showAlert('Error: ' + result.error, 'danger');
        }
    })
    .catch(error => {
        console.error('Error:', error);
        showAlert('Failed to clear case data', 'danger');
    });
}

function clearFlaggedSenders() {
    if (!confirm('Are you sure you want to delete ALL flagged sender records? This action cannot be undone.')) {
        return;
    }

    fetch('/api/admin/clear-flagged-senders', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        }
    })
    .then(response => response.json())
    .then(result => {
        if (result.success) {
            showAlert(`Successfully deleted ${result.deleted_count} flagged sender records`, 'success');
            refreshDatabaseStats();
        } else {
            showAlert('Error: ' + result.error, 'danger');
        }
    })
    .catch(error => {
        console.error('Error:', error);
        showAlert('Failed to clear flagged senders', 'danger');
    });
}

function clearAllData() {
    if (!confirm('⚠️ DANGER: This will delete ALL data including emails, cases, and flagged senders. This action cannot be undone.')) {
        return;
    }

    const confirmation = prompt('Type "RESET DATABASE" to confirm complete data deletion:');
    if (confirmation !== 'RESET DATABASE') {
        showAlert('Operation cancelled - confirmation text did not match', 'info');
        return;
    }

    fetch('/api/admin/clear-all-data', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        }
    })
    .then(response => response.json())
    .then(result => {
        if (result.success) {
            showAlert(`Database reset complete. Deleted: ${result.summary}`, 'warning');
            refreshDatabaseStats();
        } else {
            showAlert('Error: ' + result.error, 'danger');
        }
    })
    .catch(error => {
        console.error('Error:', error);
        showAlert('Failed to reset database', 'danger');
    });
}

function refreshDatabaseStats() {
    fetch('/api/admin/database-stats')
    .then(response => response.json())
    .then(stats => {
        document.getElementById('emailCount').textContent = stats.emails || 0;
        document.getElementById('caseCount').textContent = stats.cases || 0;
        document.getElementById('flaggedCount').textContent = stats.flagged_senders || 0;
        document.getElementById('rulesCount').textContent = stats.admin_rules || 0;
    })
    .catch(error => {
        console.error('Error loading database stats:', error);
    });
}

function showAlert(message, type) {
    const alertDiv = document.createElement('div');
    alertDiv.className = `alert alert-${type} alert-dismissible fade show position-fixed`;
    alertDiv.style.cssText = 'top: 20px; right: 20px; z-index: 9999; min-width: 300px;';
    alertDiv.innerHTML = `
        ${message}
        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
    `;

    document.body.appendChild(alertDiv);

    // Auto-dismiss after 5 seconds
    setTimeout(() => {
        alertDiv.remove();
    }, 5000);
}
</script>
{% endblock %}