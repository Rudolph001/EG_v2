{% extends "base.html" %}

{% block title %}Admin Rules - Email Guardian{% endblock %}

{% block content %}
<div class="row">
    <div class="col-12">
        <div class="d-flex justify-content-between align-items-center mb-4">
            <h1>
                <i class="fas fa-cogs"></i>
                Admin Rules Configuration
            </h1>
            <div>
                <button type="button" class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#addRuleModal">
                    <i class="fas fa-plus"></i>
                    Add New Rule
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Rules Table -->
<div class="row">
    <div class="col-12">
        <div class="card">
            <div class="card-header">
                <h5 class="mb-0">
                    <i class="fas fa-table"></i>
                    Active Admin Rules
                </h5>
            </div>
            <div class="card-body p-0">
                {% if rules %}
                <div class="table-responsive">
                    <table class="table table-striped table-hover mb-0" id="rulesTable">
                        <thead class="table-dark">
                            <tr>
                                <th>Rule ID</th>
                                <th>Rule Type</th>
                                <th>Conditions</th>
                                <th>Action</th>
                                <th>Status</th>
                                <th>Created</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for rule in rules %}
                            <tr>
                                <td>
                                    <strong class="text-primary">#{{ rule[0] }}</strong>
                                </td>
                                <td>
                                    {% if rule[1] == 'sender_filter' %}
                                        <span class="badge bg-info">
                                            <i class="fas fa-user"></i> Sender Filter
                                        </span>
                                    {% elif rule[1] == 'content_filter' %}
                                        <span class="badge bg-warning text-dark">
                                            <i class="fas fa-filter"></i> Content Filter
                                        </span>
                                    {% elif rule[1] == 'attachment_filter' %}
                                        <span class="badge bg-danger">
                                            <i class="fas fa-paperclip"></i> Attachment Filter
                                        </span>
                                    {% elif rule[1] == 'auto_escalation' %}
                                        <span class="badge bg-success">
                                            <i class="fas fa-arrow-up"></i> Auto Escalation
                                        </span>
                                    {% else %}
                                        <span class="badge bg-secondary">{{ rule[1] or 'Unknown' }}</span>
                                    {% endif %}
                                </td>
                                <td>
                                    <div class="text-break" style="max-width: 300px;">
                                        <code class="small">{{ rule[2] or 'No conditions defined' }}</code>
                                    </div>
                                </td>
                                <td>
                                    {% if rule[3] == 'block' %}
                                        <span class="badge bg-danger">
                                            <i class="fas fa-ban"></i> Block
                                        </span>
                                    {% elif rule[3] == 'flag' %}
                                        <span class="badge bg-warning text-dark">
                                            <i class="fas fa-flag"></i> Flag
                                        </span>
                                    {% elif rule[3] == 'escalate' %}
                                        <span class="badge bg-info">
                                            <i class="fas fa-exclamation-triangle"></i> Escalate
                                        </span>
                                    {% elif rule[3] == 'notify' %}
                                        <span class="badge bg-primary">
                                            <i class="fas fa-bell"></i> Notify
                                        </span>
                                    {% else %}
                                        <span class="badge bg-secondary">{{ rule[3] or 'None' }}</span>
                                    {% endif %}
                                </td>
                                <td>
                                    {% if rule[4] %}
                                        <span class="badge bg-success">
                                            <i class="fas fa-check"></i> Active
                                        </span>
                                    {% else %}
                                        <span class="badge bg-secondary">
                                            <i class="fas fa-pause"></i> Disabled
                                        </span>
                                    {% endif %}
                                </td>
                                <td>
                                    <small class="text-muted">
                                        {{ rule[5].strftime('%Y-%m-%d %H:%M') if rule[5] else 'N/A' }}
                                    </small>
                                </td>
                                <td>
                                    <div class="btn-group btn-group-sm" role="group">
                                        {% if rule[4] %}
                                        <button type="button" class="btn btn-outline-warning" 
                                                onclick="toggleRule({{ rule[0] }}, false)" 
                                                title="Disable Rule">
                                            <i class="fas fa-pause"></i>
                                        </button>
                                        {% else %}
                                        <button type="button" class="btn btn-outline-success" 
                                                onclick="toggleRule({{ rule[0] }}, true)" 
                                                title="Enable Rule">
                                            <i class="fas fa-play"></i>
                                        </button>
                                        {% endif %}
                                        
                                        <button type="button" class="btn btn-outline-primary" 
                                                onclick="editRule({{ rule[0] }})" 
                                                title="Edit Rule">
                                            <i class="fas fa-edit"></i>
                                        </button>
                                        <button type="button" class="btn btn-outline-danger" 
                                                onclick="deleteRule({{ rule[0] }})" 
                                                title="Delete Rule">
                                            <i class="fas fa-trash"></i>
                                        </button>
                                    </div>
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
                {% else %}
                <div class="text-center py-5">
                    <i class="fas fa-cogs fa-3x text-muted mb-3"></i>
                    <h5 class="text-muted">No admin rules configured</h5>
                    <p class="text-muted">Create your first admin rule to automate email processing.</p>
                    <button type="button" class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#addRuleModal">
                        <i class="fas fa-plus"></i> Create First Rule
                    </button>
                </div>
                {% endif %}
            </div>
        </div>
    </div>
</div>

<!-- Rule Templates -->
<div class="row mt-4">
    <div class="col-12">
        <div class="card border-info">
            <div class="card-header bg-info text-white">
                <h5 class="mb-0">
                    <i class="fas fa-lightbulb"></i>
                    Rule Templates
                </h5>
            </div>
            <div class="card-body">
                <div class="row">
                    <div class="col-md-6 mb-3">
                        <div class="card h-100">
                            <div class="card-body">
                                <h6 class="card-title">
                                    <i class="fas fa-shield-alt text-danger"></i>
                                    Suspicious Attachment Filter
                                </h6>
                                <p class="card-text small">
                                    Automatically flag emails with potentially dangerous attachments (.exe, .zip, .bat files).
                                </p>
                                <button class="btn btn-outline-primary btn-sm" onclick="useTemplate('attachment_filter')">
                                    Use Template
                                </button>
                            </div>
                        </div>
                    </div>
                    
                    <div class="col-md-6 mb-3">
                        <div class="card h-100">
                            <div class="card-body">
                                <h6 class="card-title">
                                    <i class="fas fa-user-times text-warning"></i>
                                    External Sender Alert
                                </h6>
                                <p class="card-text small">
                                    Flag emails from external domains not in the company whitelist.
                                </p>
                                <button class="btn btn-outline-primary btn-sm" onclick="useTemplate('external_sender')">
                                    Use Template
                                </button>
                            </div>
                        </div>
                    </div>
                    
                    <div class="col-md-6 mb-3">
                        <div class="card h-100">
                            <div class="card-body">
                                <h6 class="card-title">
                                    <i class="fas fa-exclamation-triangle text-info"></i>
                                    High Volume Sender
                                </h6>
                                <p class="card-text small">
                                    Escalate when a sender exceeds 50 emails per day to detect potential spam.
                                </p>
                                <button class="btn btn-outline-primary btn-sm" onclick="useTemplate('volume_check')">
                                    Use Template
                                </button>
                            </div>
                        </div>
                    </div>
                    
                    <div class="col-md-6 mb-3">
                        <div class="card h-100">
                            <div class="card-body">
                                <h6 class="card-title">
                                    <i class="fas fa-search text-success"></i>
                                    Keyword Detection
                                </h6>
                                <p class="card-text small">
                                    Flag emails containing suspicious keywords like "urgent", "confidential", "password".
                                </p>
                                <button class="btn btn-outline-primary btn-sm" onclick="useTemplate('keyword_filter')">
                                    Use Template
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Add Rule Modal -->
<div class="modal fade" id="addRuleModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Add New Admin Rule</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form id="addRuleForm">
                    <div class="row">
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="ruleType" class="form-label">Rule Type</label>
                                <select class="form-select" id="ruleType" name="rule_type" required onchange="updateConditionsPlaceholder()">
                                    <option value="">Select rule type...</option>
                                    <option value="sender_filter">Sender Filter</option>
                                    <option value="content_filter">Content Filter</option>
                                    <option value="attachment_filter">Attachment Filter</option>
                                    <option value="auto_escalation">Auto Escalation</option>
                                    <option value="time_based">Time-based Rule</option>
                                    <option value="department_filter">Department Filter</option>
                                </select>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="ruleAction" class="form-label">Action</label>
                                <select class="form-select" id="ruleAction" name="action" required>
                                    <option value="">Select action...</option>
                                    <option value="flag">Flag for Review</option>
                                    <option value="block">Block Email</option>
                                    <option value="escalate">Create Case</option>
                                    <option value="notify">Send Notification</option>
                                    <option value="quarantine">Quarantine</option>
                                </select>
                            </div>
                        </div>
                    </div>
                    
                    <div class="mb-3">
                        <label for="ruleConditions" class="form-label">Rule Conditions (JSON format)</label>
                        <textarea class="form-control font-monospace" id="ruleConditions" name="conditions" 
                                  rows="4" required placeholder="Enter rule conditions in JSON format..."></textarea>
                        <div class="form-text">
                            <small class="text-muted">
                                Example: {"sender_domain": "*.suspicious-domain.com", "attachment_types": [".exe", ".zip"]}
                            </small>
                        </div>
                    </div>
                    
                    <div class="mb-3">
                        <div class="form-check">
                            <input class="form-check-input" type="checkbox" id="ruleActive" name="is_active" checked>
                            <label class="form-check-label" for="ruleActive">
                                Enable rule immediately
                            </label>
                        </div>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-primary" onclick="submitRule()">
                    <i class="fas fa-plus"></i> Add Rule
                </button>
            </div>
        </div>
    </div>
</div>

<script>
// Rule templates
const ruleTemplates = {
    attachment_filter: {
        rule_type: 'attachment_filter',
        action: 'flag',
        conditions: JSON.stringify({
            "attachment_extensions": [".exe", ".bat", ".scr", ".zip", ".rar"],
            "description": "Flag emails with potentially dangerous attachments"
        }, null, 2)
    },
    external_sender: {
        rule_type: 'sender_filter',
        action: 'flag',
        conditions: JSON.stringify({
            "sender_domain_not_in": ["company.com", "internal.org"],
            "description": "Flag emails from external domains"
        }, null, 2)
    },
    volume_check: {
        rule_type: 'auto_escalation',
        action: 'escalate',
        conditions: JSON.stringify({
            "emails_per_day": 50,
            "time_window": "24h",
            "description": "Escalate high-volume senders"
        }, null, 2)
    },
    keyword_filter: {
        rule_type: 'content_filter',
        action: 'flag',
        conditions: JSON.stringify({
            "keywords": ["urgent", "confidential", "password", "verify account", "click here"],
            "case_sensitive": false,
            "description": "Flag emails with suspicious keywords"
        }, null, 2)
    }
};

function useTemplate(templateName) {
    const template = ruleTemplates[templateName];
    if (template) {
        document.getElementById('ruleType').value = template.rule_type;
        document.getElementById('ruleAction').value = template.action;
        document.getElementById('ruleConditions').value = template.conditions;
        new bootstrap.Modal(document.getElementById('addRuleModal')).show();
    }
}

function updateConditionsPlaceholder() {
    const ruleType = document.getElementById('ruleType').value;
    const conditionsTextarea = document.getElementById('ruleConditions');
    
    const placeholders = {
        'sender_filter': '{"sender_domain": "example.com", "sender_pattern": "*@suspicious.com"}',
        'content_filter': '{"keywords": ["urgent", "verify"], "subject_pattern": "*URGENT*"}',
        'attachment_filter': '{"extensions": [".exe", ".zip"], "max_size_mb": 10}',
        'auto_escalation': '{"threshold": 10, "time_window": "1h"}',
        'time_based': '{"time_range": "18:00-06:00", "days": ["saturday", "sunday"]}',
        'department_filter': '{"departments": ["finance", "hr"], "action_type": "review"}'
    };
    
    conditionsTextarea.placeholder = placeholders[ruleType] || 'Enter rule conditions in JSON format...';
}

function submitRule() {
    const formData = new FormData(document.getElementById('addRuleForm'));
    const data = {
        rule_type: formData.get('rule_type'),
        conditions: formData.get('conditions'),
        action: formData.get('action'),
        is_active: formData.get('is_active') ? true : false
    };
    
    // Validate JSON
    try {
        JSON.parse(data.conditions);
    } catch (e) {
        alert('Invalid JSON format in conditions. Please check your syntax.');
        return;
    }
    
    fetch('/api/add-admin-rule', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify(data)
    })
    .then(response => response.json())
    .then(result => {
        if (result.success) {
            bootstrap.Modal.getInstance(document.getElementById('addRuleModal')).hide();
            location.reload();
        } else {
            alert('Error: ' + result.error);
        }
    })
    .catch(error => {
        console.error('Error:', error);
        alert('An error occurred while adding the rule.');
    });
}

function toggleRule(ruleId, isActive) {
    const action = isActive ? 'enable' : 'disable';
    if (!confirm(`Are you sure you want to ${action} this rule?`)) {
        return;
    }
    
    // Implementation would need an API endpoint for toggling rules
    alert(`Rule ${action} functionality would be implemented with an update API endpoint`);
}

function editRule(ruleId) {
    // Implementation would need an API endpoint for getting rule details
    alert('Edit rule functionality would be implemented with rule update endpoints');
}

function deleteRule(ruleId) {
    if (!confirm('Are you sure you want to delete this rule? This action cannot be undone.')) {
        return;
    }
    
    // Implementation would need an API endpoint for deleting rules
    alert('Delete rule functionality would be implemented with a delete API endpoint');
}

// Initialize DataTable if we have rules
{% if rules %}
$(document).ready(function() {
    $('#rulesTable').DataTable({
        order: [[5, 'desc']],
        pageLength: 25,
        columnDefs: [
            { orderable: false, targets: [6] }
        ]
    });
});
{% endif %}
</script>
{% endblock %}
