{% extends "base.html" %}

{% block title %}Admin Panel - Email Guardian{% endblock %}

{% block content %}
<div class="container-fluid py-4">
    <!-- Header -->
    <div class="row mb-3">
        <div class="col-12">
            <div class="text-center">
                <h2 class="fw-bold text-dark mb-2">
                    <i class="fas fa-cogs text-primary me-2"></i>
                    Admin Control Panel
                </h2>
                <p class="text-muted mb-0">System Configuration & Database Management</p>
            </div>
        </div>
    </div>

    <!-- Quick Stats Cards -->
    <div class="row mb-3 g-3">
        <div class="col-lg-2 col-md-4 col-sm-6">
            <div class="card bg-primary text-white shadow-sm">
                <div class="card-body text-center py-3">
                    <i class="fas fa-envelope fa-lg mb-2"></i>
                    <h5 class="mb-1" id="emailCount">{{ stats.emails or 0 }}</h5>
                    <small class="fw-bold">Total Emails</small>
                </div>
            </div>
        </div>
        <div class="col-lg-2 col-md-4 col-sm-6">
            <div class="card bg-warning text-dark shadow-sm">
                <div class="card-body text-center py-3">
                    <i class="fas fa-gavel fa-lg mb-2"></i>
                    <h5 class="mb-1" id="caseCount">{{ stats.cases or 0 }}</h5>
                    <small class="fw-bold">Active Cases</small>
                </div>
            </div>
        </div>
        <div class="col-lg-2 col-md-4 col-sm-6">
            <div class="card bg-danger text-white shadow-sm">
                <div class="card-body text-center py-3">
                    <i class="fas fa-user-times fa-lg mb-2"></i>
                    <h5 class="mb-1" id="flaggedCount">{{ stats.flagged_senders or 0 }}</h5>
                    <small class="fw-bold">Flagged Senders</small>
                </div>
            </div>
        </div>
        <div class="col-lg-2 col-md-4 col-sm-6">
            <div class="card bg-success text-white shadow-sm">
                <div class="card-body text-center py-3">
                    <i class="fas fa-shield-alt fa-lg mb-2"></i>
                    <h5 class="mb-1" id="rulesCount">{{ stats.admin_rules or 0 }}</h5>
                    <small class="fw-bold">Security Rules</small>
                </div>
            </div>
        </div>
        <div class="col-lg-2 col-md-4 col-sm-6">
            <div class="card bg-info text-white shadow-sm">
                <div class="card-body text-center py-3">
                    <i class="fas fa-robot fa-lg mb-2"></i>
                    <h5 class="mb-1">1</h5>
                    <small class="fw-bold">ML Models</small>
                </div>
            </div>
        </div>
        <div class="col-lg-2 col-md-4 col-sm-6">
            <div class="card bg-secondary text-white shadow-sm">
                <div class="card-body text-center py-3">
                    <i class="fas fa-database fa-lg mb-2"></i>
                    <h5 class="mb-1">Active</h5>
                    <small class="fw-bold">Database</small>
                </div>
            </div>
        </div>
    </div>

    <!-- Main Admin Sections -->
    <div class="row g-3">
        <!-- Machine Learning Section -->
        <div class="col-lg-6">
            <div class="card shadow border-0 h-100">
                <div class="card-header bg-gradient text-white py-2" style="background: linear-gradient(45deg, #667eea 0%, #764ba2 100%);">
                    <h6 class="mb-0 text-center fw-bold">
                        <i class="fas fa-robot me-2"></i>
                        Machine Learning Controls
                    </h6>
                </div>
                <div class="card-body p-3">
                    <div class="row mb-3">
                        <div class="col-md-6">
                            <label class="form-label fw-bold small">Risk Detection Threshold</label>
                            <input type="range" class="form-range" id="riskThreshold" min="0" max="100" value="70">
                            <div class="text-center mt-1">
                                <span id="riskThresholdValue" class="badge bg-primary px-2 py-1">70%</span>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <label class="form-label fw-bold small">Confidence Level</label>
                            <input type="range" class="form-range" id="confidenceThreshold" min="0" max="100" value="85">
                            <div class="text-center mt-1">
                                <span id="confidenceThresholdValue" class="badge bg-success px-2 py-1">85%</span>
                            </div>
                        </div>
                    </div>

                    <div class="d-grid gap-2">
                        <button class="btn btn-primary py-2" onclick="trainModel()">
                            <i class="fas fa-brain me-2"></i>
                            Train Basic Model
                        </button>
                        <button class="btn btn-success py-2" onclick="trainAdvancedModels()">
                            <i class="fas fa-robot me-2"></i>
                            Train Advanced Models
                        </button>
                        <button class="btn btn-outline-secondary py-2" onclick="saveMLSettings()">
                            <i class="fas fa-save me-2"></i>
                            Save ML Settings
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <!-- Database Management Section -->
        <div class="col-lg-6">
            <div class="card shadow border-danger h-100">
                <div class="card-header bg-danger text-white py-2">
                    <h6 class="mb-0 text-center fw-bold">
                        <i class="fas fa-database me-2"></i>
                        Database Cleanup
                    </h6>
                </div>
                <div class="card-body p-3">
                    <div class="alert alert-warning border-warning border-2 mb-3 p-2">
                        <i class="fas fa-exclamation-triangle me-2"></i>
                        <strong>WARNING:</strong> These operations permanently delete data!
                    </div>

                    <div class="d-grid gap-2">
                        <button class="btn btn-outline-primary btn-sm py-2" onclick="clearEmails()">
                            <i class="fas fa-envelope me-2"></i>
                            Clear All Emails
                        </button>

                        <button class="btn btn-outline-warning btn-sm py-2" onclick="clearCases()">
                            <i class="fas fa-gavel me-2"></i>
                            Clear All Cases
                        </button>

                        <button class="btn btn-outline-info btn-sm py-2" onclick="clearFlaggedSenders()">
                            <i class="fas fa-user-times me-2"></i>
                            Clear Flagged Senders
                        </button>

                        <button class="btn btn-danger btn-sm py-2" onclick="clearAllData()">
                            <i class="fas fa-nuclear me-2"></i>
                            Reset Entire Database
                        </button>
                    </div>

                    <hr class="my-3">

                    <!-- Database Stats -->
                    <div class="row text-center">
                        <div class="col-3">
                            <div class="h6 text-primary fw-bold" id="emailCountDetail">-</div>
                            <small class="text-muted">Emails</small>
                        </div>
                        <div class="col-3">
                            <div class="h6 text-warning fw-bold" id="caseCountDetail">-</div>
                            <small class="text-muted">Cases</small>
                        </div>
                        <div class="col-3">
                            <div class="h6 text-info fw-bold" id="flaggedCountDetail">-</div>
                            <small class="text-muted">Flagged</small>
                        </div>
                        <div class="col-3">
                            <div class="h6 text-success fw-bold" id="rulesCountDetail">-</div>
                            <small class="text-muted">Rules</small>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Security Rules Management -->
        <div class="col-lg-6">
            <div class="card shadow border-0 h-100">
                <div class="card-header text-white py-2" style="background: linear-gradient(45deg, #f093fb 0%, #f5576c 100%);">
                    <h6 class="mb-0 text-center fw-bold">
                        <i class="fas fa-shield-alt me-2"></i>
                        Security Rules
                    </h6>
                </div>
                <div class="card-body p-3">
                    <p class="text-muted small mb-3">Configure security threat detection and filtering rules for incoming emails.</p>

                    <div class="d-grid gap-2 mb-3">
                        <button class="btn btn-primary btn-sm py-2" onclick="showRuleModal('security')">
                            <i class="fas fa-plus me-2"></i>
                            Add New Security Rule
                        </button>

                        <button class="btn btn-outline-secondary btn-sm py-2" onclick="viewAllRules()">
                            <i class="fas fa-list me-2"></i>
                            View All Rules
                        </button>
                    </div>

                    <!-- Simple Rules List -->
                    <div class="table-responsive">
                        <table class="table table-striped" id="securityRulesTable">
                            <thead class="table-dark">
                                <tr>
                                    <th>Rule Name</th>
                                    <th>Status</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody id="securityRulesBody">
                                <tr>
                                    <td colspan="3" class="text-center text-muted">No rules configured</td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>

        <!-- Policy Management Section -->
        <div class="col-lg-6">
            <div class="card shadow border-0 h-100">
                <div class="card-header text-white py-2" style="background: linear-gradient(45deg, #ff6b6b 0%, #ee5a24 100%);">
                    <h6 class="mb-0 text-center fw-bold">
                        <i class="fas fa-gavel me-2"></i>
                        Policy Management
                    </h6>
                </div>
                <div class="card-body p-3">
                    <p class="text-muted small mb-3">Create and manage email security policies with custom rules and violation detection.</p>

                    <div class="d-grid gap-2 mb-3">
                        <button class="btn btn-primary btn-sm py-2" onclick="showPolicyModal()">
                            <i class="fas fa-plus me-2"></i>
                            Create New Policy
                        </button>

                        <button class="btn btn-outline-secondary btn-sm py-2" onclick="viewAllPolicies()">
                            <i class="fas fa-list me-2"></i>
                            View All Policies
                        </button>

                        <button class="btn btn-outline-info btn-sm py-2" onclick="loadPolicyViolationsData()">
                            <i class="fas fa-chart-bar me-2"></i>
                            View Violations Report
                        </button>
                    </div>

                    <!-- Policy Violations Summary -->
                    <div id="policyViolationsContainer" class="table-responsive">
                        <table class="table table-striped table-sm">
                            <thead class="table-dark">
                                <tr>
                                    <th>Policy Name</th>
                                    <th>Status</th>
                                    <th>Violations</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody id="policyViolationsBody">
                                <tr>
                                    <td colspan="4" class="text-center text-muted">Loading policies...</td>
                                </tr>
                            </tbody>
                        </table>
                    </div>

                    <!-- Existing Policies List -->
                    <div class="mt-4">
                        <h6>Existing Policies</h6>
                        <div class="table-responsive">
                            <table class="table table-striped table-sm">
                                <thead class="table-light">
                                    <tr>
                                        <th>Name</th>
                                        <th>Severity</th>
                                        <th>Status</th>
                                        <th>Actions</th>
                                    </tr>
                                </thead>
                                <tbody id="existingPoliciesBody">
                                    <tr>
                                        <td colspan="4" class="text-center text-muted">Loading policies...</td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Email Filtering Settings -->
        <div class="col-lg-6">
            <div class="card shadow border-0 h-100">
                <div class="card-header text-white py-2" style="background: linear-gradient(45deg, #4facfe 0%, #00f2fe 100%);">
                    <h6 class="mb-0 text-center fw-bold">
                        <i class="fas fa-filter me-2"></i>
                        Email Filtering
                    </h6>
                </div>
                <div class="card-body p-3">
                    <div class="row g-2">
                        <!-- Whitelist Management -->
                        <div class="col-md-6">
                            <div class="card border-success">
                                <div class="card-header bg-success text-white py-1">
                                    <small class="mb-0 fw-bold">
                                        <i class="fas fa-check-circle me-1"></i>
                                        Trusted Senders
                                    </small>
                                </div>
                                <div class="card-body p-2">
                                    <div class="input-group mb-2">
                                        <input type="email" class="form-control form-control-sm" id="newSender" placeholder="email@domain.com">
                                        <button class="btn btn-success btn-sm" onclick="addWhitelistItem('sender')">
                                            <i class="fas fa-plus"></i>
                                        </button>
                                    </div>
                                    <div id="whitelistSenders" class="border rounded p-2" style="height: 80px; overflow-y: auto; background-color: #f8f9fa;">
                                        <small class="text-muted">No trusted senders added</small>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Domain Management -->
                        <div class="col-md-6">
                            <div class="card border-info">
                                <div class="card-header bg-info text-white py-1">
                                    <small class="mb-0 fw-bold">
                                        <i class="fas fa-globe me-1"></i>
                                        Trusted Domains
                                    </small>
                                </div>
                                <div class="card-body p-2">
                                    <div class="input-group mb-2">
                                        <input type="text" class="form-control form-control-sm" id="newDomain" placeholder="company.com">
                                        <button class="btn btn-info btn-sm" onclick="addWhitelistItem('domain')">
                                            <i class="fas fa-plus"></i>
                                        </button>
                                    </div>
                                    <div id="whitelistDomains" class="border rounded p-2" style="height: 80px; overflow-y: auto; background-color: #f8f9fa;">
                                        <small class="text-muted">No trusted domains added</small>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Risk Keywords -->
                        <div class="col-md-6">
                            <div class="card border-danger">
                                <div class="card-header bg-danger text-white py-1">
                                    <small class="mb-0 fw-bold">
                                        <i class="fas fa-exclamation-triangle me-1"></i>
                                        Risk Keywords
                                    </small>
                                </div>
                                <div class="card-body p-2">
                                    <div class="input-group mb-2">
                                        <input type="text" class="form-control form-control-sm" id="newRiskKeyword" placeholder="suspicious keyword">
                                        <button class="btn btn-danger btn-sm" onclick="addKeyword('risk')">
                                            <i class="fas fa-plus"></i>
                                        </button>
                                    </div>
                                    <div id="riskKeywords" class="border rounded p-2" style="height: 80px; overflow-y: auto; background-color: #f8f9fa;">
                                        <small class="text-muted">No risk keywords added</small>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Exclusion Keywords -->
                        <div class="col-md-6">
                            <div class="card border-secondary">
                                <div class="card-header bg-secondary text-white py-1">
                                    <small class="mb-0 fw-bold">
                                        <i class="fas fa-times-circle me-1"></i>
                                        Exclusion Keywords
                                    </small>
                                </div>
                                <div class="card-body p-2">
                                    <div class="input-group mb-2">
                                        <input type="text" class="form-control form-control-sm" id="newExcludeKeyword" placeholder="exclude keyword">
                                        <button class="btn btn-secondary btn-sm" onclick="addKeyword('exclude')">
                                            <i class="fas fa-plus"></i>
                                        </button>
                                    </div>
                                    <div id="excludeKeywords" class="border rounded p-2" style="height: 80px; overflow-y: auto; background-color: #f8f9fa;">
                                        <small class="text-muted">No exclusion keywords added</small>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Policy Modal -->
<div class="modal fade" id="policyModal" tabindex="-1">
    <div class="modal-dialog modal-xl">
        <div class="modal-content">
            <div class="modal-header bg-danger text-white">
                <h5 class="modal-title" id="policyModalTitle">Create New Policy</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form id="policyForm">
                    <input type="hidden" id="policyId" name="policy_id">

                    <div class="row mb-3">
                        <div class="col-md-8">
                            <label class="form-label fw-bold">Policy Name</label>
                            <input type="text" class="form-control" id="policyName" name="policy_name" required placeholder="e.g., External Email Monitoring">
                        </div>
                        <div class="col-md-4">
                            <label class="form-label fw-bold">Severity Level</label>
                            <select class="form-select" id="policySeverity" name="severity" required>
                                <option value="low">Low</option>
                                <option value="medium" selected>Medium</option>
                                <option value="high">High</option>
                                <option value="critical">Critical</option>
                            </select>
                        </div>
                    </div>

                    <div class="mb-3">
                        <label class="form-label fw-bold">Description</label>
                        <textarea class="form-control" id="policyDescription" name="description" rows="3" placeholder="Describe what this policy monitors for..."></textarea>
                    </div>

                    <div class="row mb-3">
                        <div class="col-md-6">
                            <label class="form-label fw-bold">Keywords (comma-separated)</label>
                            <input type="text" class="form-control" id="policyKeywords" name="keywords" placeholder="urgent, confidential, password">
                        </div>
                        <div class="col-md-6">
                            <label class="form-label fw-bold">Action</label>
                            <select class="form-select" id="policyAction" name="action">
                                <option value="flag">Flag for Review</option>
                                <option value="escalate">Create Case</option>
                                <option value="block">Block Email</option>
                                <option value="notify">Send Notification</option>
                            </select>
                        </div>
                    </div>

                    <div class="mb-3">
                        <label class="form-label fw-bold">Rules (JSON format)</label>
                        <textarea class="form-control font-monospace" id="policyRules" name="rules" rows="6" placeholder='{"sender_domain": "*external.com", "has_attachments": true}'></textarea>
                        <div class="form-text">
                            <small class="text-muted">Define specific conditions in JSON format</small>
                        </div>
                    </div>

                    <div class="mb-3">
                        <div class="form-check">
                            <input class="form-check-input" type="checkbox" id="policyActive" name="is_active" checked>
                            <label class="form-check-label fw-bold" for="policyActive">
                                Enable policy immediately
                            </label>
                        </div>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-danger" onclick="savePolicy()">
                    <i class="fas fa-save"></i> Save Policy
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Rule Modal -->
<div class="modal fade" id="ruleModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header bg-primary text-white">
                <h5 class="modal-title" id="ruleModalTitle">Add Security Rule</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form id="ruleForm">
                    <input type="hidden" id="ruleType" name="rule_type" value="security">
                    <input type="hidden" id="ruleId" name="rule_id">

                    <div class="mb-3">
                        <label class="form-label fw-bold">Rule Name</label>
                        <input type="text" class="form-control" id="ruleName" name="rule_name" required placeholder="e.g., Block Phishing Attempts">
                    </div>

                    <div class="mb-3">
                        <label class="form-label fw-bold">Logic Type</label>
                        <select class="form-select" id="ruleLogic" name="logic_type" required>
                            <option value="AND">AND (All conditions must match)</option>
                            <option value="OR">OR (Any condition can match)</option>
                        </select>
                    </div>

                    <div class="mb-3">
                        <label class="form-label fw-bold">Risk Level</label>
                        <select class="form-select" id="riskLevel" name="risk_level">
                            <option value="low">Low Risk</option>
                            <option value="medium" selected>Medium Risk</option>
                            <option value="high">High Risk</option>
                            <option value="critical">Critical Risk</option>
                        </select>
                    </div>

                    <div class="mb-3">
                        <label class="form-label fw-bold">Conditions</label>
                        <div id="conditionsContainer">
                            <!-- Dynamic conditions will be added here -->
                        </div>
                        <button type="button" class="btn btn-outline-primary btn-sm mt-2" onclick="addCondition()">
                            <i class="fas fa-plus"></i> Add Condition
                        </button>
                    </div>

                    <div class="mb-3">
                        <div class="form-check">
                            <input class="form-check-input" type="checkbox" id="ruleActive" name="is_active" checked>
                            <label class="form-check-label fw-bold" for="ruleActive">
                                Enable rule immediately
                            </label>
                        </div>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-primary" onclick="saveRule()">
                    <i class="fas fa-save"></i> Save Rule
                </button>
            </div>
        </div>
    </div>
</div>

<script>
let conditionCounter = 0;

// Initialize page
document.addEventListener('DOMContentLoaded', function() {
    refreshDatabaseStats();
    loadKeywords();
    loadWhitelist();
    loadMLSettings();
    loadSecurityRules();
    loadPolicies();
    loadPolicyViolationsData();

    // Setup threshold value displays
    document.getElementById('riskThreshold').addEventListener('input', function() {
        document.getElementById('riskThresholdValue').textContent = this.value + '%';
    });

    document.getElementById('confidenceThreshold').addEventListener('input', function() {
        document.getElementById('confidenceThresholdValue').textContent = this.value + '%';
    });
});

// ML Functions
function trainModel() {
    const button = event.target;
    button.disabled = true;
    button.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Training...';

    fetch('/api/train-model', {
        method: 'POST'
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            showAlert(`Model trained successfully! Accuracy: ${(data.accuracy * 100).toFixed(1)}%`, 'success');
        } else {
            showAlert('Error training model: ' + data.error, 'danger');
        }
    })
    .catch(error => {
        console.error('Error:', error);
        showAlert('Error training model', 'danger');
    })
    .finally(() => {
        button.disabled = false;
        button.innerHTML = '<i class="fas fa-brain me-2"></i> TRAIN BASIC MODEL';
    });
}

function trainAdvancedModels() {
    const button = event.target;
    button.disabled = true;
    button.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Training Advanced...';

    fetch('/api/train-advanced-models', {
        method: 'POST'
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            const results = data.results;
            showAlert(`Advanced models trained! Accuracy: ${(results.ensemble_accuracy * 100).toFixed(1)}%`, 'success');
        } else {
            showAlert('Error training advanced models: ' + data.error, 'danger');
        }
    })
    .catch(error => {
        console.error('Error:', error);
        showAlert('Error training advanced models', 'danger');
    })
    .finally(() => {
        button.disabled = false;
        button.innerHTML = '<i class="fas fa-robot me-2"></i> TRAIN ADVANCED MODELS';
    });
}

function saveMLSettings() {
    const settings = {
        risk_threshold: document.getElementById('riskThreshold').value,
        confidence_threshold: document.getElementById('confidenceThreshold').value
    };

    fetch('/api/admin/save-ml-settings', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify(settings)
    })
    .then(response => response.json())
    .then(result => {
        if (result.success) {
            showAlert('ML settings saved successfully', 'success');
        } else {
            showAlert('Error: ' + result.error, 'danger');
        }
    });
}

// Database Management Functions
function clearEmails() {
    if (!confirm('Are you sure you want to delete ALL email records? This action cannot be undone.')) {
        return;
    }

    if (prompt('Type "DELETE" to confirm:') !== 'DELETE') {
        return;
    }

    fetch('/api/admin/clear-emails', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        }
    })
    .then(response => response.json())
    .then(result => {
        if (result.success) {
            showAlert(`Successfully deleted ${result.deleted_count} email records`, 'success');
            refreshDatabaseStats();
        } else {
            showAlert('Error: ' + result.error, 'danger');
        }
    })
    .catch(error => {
        console.error('Error:', error);
        showAlert('Failed to clear email data', 'danger');
    });
}

function clearCases() {
    if (!confirm('Are you sure you want to delete ALL case records? This action cannot be undone.')) {
        return;
    }

    fetch('/api/admin/clear-cases', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        }
    })
    .then(response => response.json())
    .then(result => {
        if (result.success) {
            showAlert(`Successfully deleted ${result.deleted_count} case records`, 'success');
            refreshDatabaseStats();
        } else {
            showAlert('Error: ' + result.error, 'danger');
        }
    })
    .catch(error => {
        console.error('Error:', error);
        showAlert('Failed to clear case data', 'danger');
    });
}

function clearFlaggedSenders() {
    if (!confirm('Are you sure you want to delete ALL flagged sender records? This action cannot be undone.')) {
        return;
    }

    fetch('/api/admin/clear-flagged-senders', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        }
    })
    .then(response => response.json())
    .then(result => {
        if (result.success) {
            showAlert(`Successfully deleted ${result.deleted_count} flagged sender records`, 'success');
            refreshDatabaseStats();
        } else {
            showAlert('Error: ' + result.error, 'danger');
        }
    })
    .catch(error => {
        console.error('Error:', error);
        showAlert('Failed to clear flagged senders', 'danger');
    });
}

function clearAllData() {
    if (!confirm('⚠️ DANGER: This will delete ALL data including emails, cases, and flagged senders. This action cannot be undone.')) {
        return;
    }

    const confirmation = prompt('Type "RESET DATABASE" to confirm complete data deletion:');
    if (confirmation !== 'RESET DATABASE') {
        showAlert('Operation cancelled - confirmation text did not match', 'info');
        return;
    }

    fetch('/api/admin/clear-all-data', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        }
    })
    .then(response => response.json())
    .then(result => {
        if (result.success) {
            showAlert(`Database reset complete. Deleted: ${result.summary}`, 'warning');
            refreshDatabaseStats();
        } else {
            showAlert('Error: ' + result.error, 'danger');
        }
    })
    .catch(error => {
        console.error('Error:', error);
        showAlert('Failed to reset database', 'danger');
    });
}

// Keyword Management
function addKeyword(type) {
    const inputId = type === 'risk' ? 'newRiskKeyword' : 'newExcludeKeyword';
    const keyword = document.getElementById(inputId).value.trim();

    if (!keyword) return;

    fetch('/api/admin/add-keyword', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify({ type: type, keyword: keyword })
    })
    .then(response => response.json())
    .then(result => {
        if (result.success) {
            document.getElementById(inputId).value = '';
            loadKeywords();
            showAlert('Keyword added successfully', 'success');
        } else {
            showAlert('Error: ' + result.error, 'danger');
        }
    });
}

function removeKeyword(type, keyword) {
    fetch('/api/admin/remove-keyword', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify({ type: type, keyword: keyword })
    })
    .then(response => response.json())
    .then(result => {
        if (result.success) {
            loadKeywords();
            showAlert('Keyword removed successfully', 'success');
        } else {
            showAlert('Error: ' + result.error, 'danger');
        }
    });
}

// Whitelist Management
function addWhitelistItem(type) {
    const inputId = type === 'sender' ? 'newSender' : 'newDomain';
    const value = document.getElementById(inputId).value.trim();

    if (!value) return;

    fetch('/api/admin/add-whitelist', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify({ type: type, value: value })
    })
    .then(response => response.json())
    .then(result => {
        if (result.success) {
            document.getElementById(inputId).value = '';
            loadWhitelist();
            showAlert('Whitelist item added successfully', 'success');
        } else {
            showAlert('Error: ' + result.error, 'danger');
        }
    });
}

function removeWhitelistItem(type, value) {
    fetch('/api/admin/remove-whitelist', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify({ type: type, value: value })
    })
    .then(response => response.json())
    .then(result => {
        if (result.success) {
            loadWhitelist();
            showAlert('Whitelist item removed successfully', 'success');
        } else {
            showAlert('Error: ' + result.error, 'danger');
        }
    });
}

// Rule Management
function showRuleModal() {
    // Clear form
    document.getElementById('ruleForm').reset();
    document.getElementById('conditionsContainer').innerHTML = '';
    conditionCounter = 0;
    addCondition();

    new bootstrap.Modal(document.getElementById('ruleModal')).show();
}

function addCondition() {
    const container = document.getElementById('conditionsContainer');
    const conditionId = `condition_${conditionCounter++}`;

    const conditionHtml = `
        <div class="condition-row border rounded p-3 mb-3 bg-light" id="${conditionId}">
            <div class="row g-2">
                <div class="col-md-3">
                    <label class="form-label fw-bold">Field</label>
                    <select class="form-select condition-field">
                        <option value="sender">Sender</option>
                        <option value="subject">Subject</option>
                        <option value="domain">Domain</option>
                        <option value="attachment">Attachment</option>
                        <option value="department">Department</option>
                        <option value="recipient">Recipient</option>
                    </select>
                </div>
                <div class="col-md-3">
                    <label class="form-label fw-bold">Operator</label>
                    <select class="form-select condition-operator">
                        <option value="contains">Contains</option>
                        <option value="equals">Equals</option>
                        <option value="starts_with">Starts With</option>
                        <option value="ends_with">Ends With</option>
                        <option value="regex">Regex Match</option>
                    </select>
                </div>
                <div class="col-md-5">
                    <label class="form-label fw-bold">Value</label>
                    <input type="text" class="form-control condition-value" placeholder="Enter value">
                </div>
                <div class="col-md-1 d-flex align-items-end">
                    <button type="button" class="btn btn-outline-danger btn-sm" onclick="removeCondition('${conditionId}')">
                        <i class="fas fa-trash"></i>
                    </button>
                </div>
            </div>
        </div>
    `;

    container.insertAdjacentHTML('beforeend', conditionHtml);
}

function removeCondition(conditionId) {
    document.getElementById(conditionId).remove();
}

function saveRule() {
    const form = document.getElementById('ruleForm');
    const formData = new FormData(form);

    // Collect conditions
    const conditions = [];
    document.querySelectorAll('.condition-row').forEach(row => {
        const field = row.querySelector('.condition-field').value;
        const operator = row.querySelector('.condition-operator').value;
        const value = row.querySelector('.condition-value').value;

        if (field && operator && value) {
            conditions.push({ field, operator, value });
        }
    });

    const ruleData = {
        rule_type: 'security',
        rule_name: formData.get('rule_name'),
        logic_type: formData.get('logic_type'),
        conditions: JSON.stringify(conditions),
        risk_level: formData.get('risk_level'),
        is_active: formData.get('is_active') ? true : false
    };

    fetch('/api/admin/save-rule', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify(ruleData)
    })
    .then(response => response.json())
    .then(result => {
        if (result.success) {
            bootstrap.Modal.getInstance(document.getElementById('ruleModal')).hide();
            loadSecurityRules();
            showAlert('Rule saved successfully', 'success');
        } else {
            showAlert('Error: ' + result.error, 'danger');
        }
    })
    .catch(error => {
        console.error('Error:', error);
        showAlert('An error occurred while saving the rule.', 'danger');
    });
}

function viewAllRules() {
    window.open('/admin-rules', '_blank');
}

// Load Functions
function refreshDatabaseStats() {
    fetch('/api/admin/database-stats')
    .then(response => response.json())
    .then(stats => {
        document.getElementById('emailCount').textContent = stats.emails || 0;
        document.getElementById('caseCount').textContent = stats.cases || 0;
        document.getElementById('flaggedCount').textContent = stats.flagged_senders || 0;
        document.getElementById('rulesCount').textContent = stats.admin_rules || 0;

        // Update detail counts
        document.getElementById('emailCountDetail').textContent = stats.emails || 0;
        document.getElementById('caseCountDetail').textContent = stats.cases || 0;
        document.getElementById('flaggedCountDetail').textContent = stats.flagged_senders || 0;
        document.getElementById('rulesCountDetail').textContent = stats.admin_rules || 0;
    })
    .catch(error => {
        console.error('Error loading database stats:', error);
    });
}

function loadKeywords() {
    ['risk', 'exclude'].forEach(type => {
        fetch(`/api/admin/keywords/${type}`)
        .then(response => response.json())
        .then(keywords => {
            const container = document.getElementById(`${type}Keywords`);
            container.innerHTML = '';

            if (keywords.length === 0) {
                container.innerHTML = `<small class="text-muted">No ${type} keywords added</small>`;
                return;
            }

            keywords.forEach(keyword => {
                const tag = document.createElement('span');
                tag.className = 'badge bg-light text-dark border me-1 mb-1';
                tag.innerHTML = `
                    ${keyword}
                    <i class="fas fa-times ms-1 text-danger" style="cursor: pointer;" onclick="removeKeyword('${type}', '${keyword}')"></i>
                `;
                container.appendChild(tag);
            });
        });
    });
}

function loadWhitelist() {
    ['sender', 'domain'].forEach(type => {
        fetch(`/api/admin/whitelist/${type}`)
        .then(response => response.json())
        .then(items => {
            const container = document.getElementById(`whitelist${type.charAt(0).toUpperCase() + type.slice(1)}s`);
            container.innerHTML = '';

            if (items.length === 0) {
                container.innerHTML = `<small class="text-muted">No trusted ${type}s added</small>`;
                return;
            }

            items.forEach(item => {
                const element = document.createElement('div');
                element.className = 'd-flex justify-content-between align-items-center p-1 mb-1 bg-white border rounded';
                element.innerHTML = `
                    <small>${item}</small>
                    <i class="fas fa-times text-danger" style="cursor: pointer;" onclick="removeWhitelistItem('${type}', '${item}')"></i>
                `;
                container.appendChild(element);
            });
        });
    });
}

function loadMLSettings() {
    fetch('/api/admin/ml-settings')
    .then(response => response.json())
    .then(settings => {
        document.getElementById('riskThreshold').value = settings.risk_threshold || 70;
        document.getElementById('confidenceThreshold').value = settings.confidence_threshold || 85;

        document.getElementById('riskThresholdValue').textContent = (settings.risk_threshold || 70) + '%';
        document.getElementById('confidenceThresholdValue').textContent = (settings.confidence_threshold || 85) + '%';
    })
    .catch(error => {
        console.error('Error loading ML settings:', error);
    });
}

function loadSecurityRules() {
    fetch('/api/admin/rules/security')
    .then(response => response.json())
    .then(rules => {
        const tbody = document.getElementById('securityRulesBody');
        tbody.innerHTML = '';

        if (rules.length === 0) {
            tbody.innerHTML = '<tr><td colspan="3" class="text-center text-muted">No rules configured</td></tr>';
            return;
        }

        rules.forEach(rule => {
            const row = document.createElement('tr');
            row.innerHTML = `
                <td>${rule.rule_name}</td>
                <td>
                    <span class="badge bg-${rule.is_active ? 'success' : 'secondary'}">
                        ${rule.is_active ? 'Active' : 'Inactive'}
                    </span>
                </td>
                <td>
                    <div class="btn-group btn-group-sm">
                        <button class="btn btn-outline-danger btn-sm" onclick="deleteRule(${rule.id})">
                            <i class="fas fa-trash"></i>
                        </button>
                    </div>
                </td>
            `;
            tbody.appendChild(row);
        });
    })
    .catch(error => {
        console.error('Error loading security rules:', error);
    });
}

function deleteRule(ruleId) {
    if (!confirm('Are you sure you want to delete this rule?')) {
        return;
    }

    fetch(`/api/admin/delete-rule/${ruleId}`, {
        method: 'DELETE'
    })
    .then(response => response.json())
    .then(result => {
        if (result.success) {
            loadSecurityRules();
            showAlert('Rule deleted successfully', 'success');
        } else {
            showAlert('Error: ' + result.error, 'danger');
        }
    });
}

// Policy Management Functions
function showPolicyModal() {
    // Clear form
    document.getElementById('policyForm').reset();
    document.getElementById('policyId').value = '';
    document.getElementById('policyModalTitle').textContent = 'Create New Policy';

    // Clear any validation errors
    document.querySelectorAll('.is-invalid').forEach(el => el.classList.remove('is-invalid'));
    document.querySelectorAll('.invalid-feedback').forEach(el => el.remove());

    new bootstrap.Modal(document.getElementById('policyModal')).show();
}

function savePolicy() {
    const form = document.getElementById('policyForm');

    // Clear previous validation errors
    document.querySelectorAll('.is-invalid').forEach(el => el.classList.remove('is-invalid'));
    document.querySelectorAll('.invalid-feedback').forEach(el => el.remove());

    // Get form values
    const policyName = document.getElementById('policyName').value.trim();
    const policyDescription = document.getElementById('policyDescription').value.trim();
    const policySeverity = document.getElementById('policySeverity').value;
    const policyKeywords = document.getElementById('policyKeywords').value.trim();
    const policyAction = document.getElementById('policyAction').value;
    const policyRules = document.getElementById('policyRules').value.trim();
    const policyActive = document.getElementById('policyActive').checked;
    const policyId = document.getElementById('policyId').value;

    // Validate required fields
    let hasErrors = false;

    if (!policyName) {
        addValidationError('policyName', 'Policy name is required');
        hasErrors = true;
    }

    if (!policyDescription) {
        addValidationError('policyDescription', 'Description is required');
        hasErrors = true;
    }

    // Validate JSON if rules provided
    if (policyRules) {
        try {
            JSON.parse(policyRules);
        } catch (e) {
            addValidationError('policyRules', 'Invalid JSON format. Please check your syntax.');
            hasErrors = true;
        }
    }

    if (hasErrors) {
        return;
    }

    const policyData = {
        policy_id: policyId || null,
        policy_name: policyName,
        description: policyDescription,
        severity: policySeverity,
        keywords: policyKeywords,
        rules: policyRules,
        action: policyAction,
        is_active: policyActive
    };

    // Show saving indicator
    const saveButton = document.querySelector('#policyModal .btn-danger');
    const originalText = saveButton.innerHTML;
    saveButton.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Saving...';
    saveButton.disabled = true;

    fetch('/api/admin/save-policy', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify(policyData)
    })
    .then(response => response.json())
    .then(result => {
        if (result.success) {
            bootstrap.Modal.getInstance(document.getElementById('policyModal')).hide();
            loadPolicies();
            loadPolicyViolationsData();
            showAlert('Policy saved successfully', 'success');
        } else {
            showAlert('Error: ' + result.error, 'danger');
        }
    })
    .catch(error => {
        console.error('Error:', error);
        showAlert('An error occurred while saving the policy.', 'danger');
    })
    .finally(() => {
        saveButton.innerHTML = originalText;
        saveButton.disabled = false;
    });
}

function addValidationError(fieldId, message) {
    const field = document.getElementById(fieldId);
    field.classList.add('is-invalid');

    const feedback = document.createElement('div');
    feedback.className = 'invalid-feedback';
    feedback.textContent = message;
    field.parentNode.appendChild(feedback);
}

function editPolicy(policyId) {
    fetch(`/api/admin/policy/${policyId}`)
    .then(response => response.json())
    .then(policy => {
        if (policy.error) {
            showAlert('Error: ' + policy.error, 'danger');
            return;
        }

        // Populate form
        document.getElementById('policyId').value = policy.id;
        document.getElementById('policyName').value = policy.policy_name;
        document.getElementById('policyDescription').value = policy.description;
        document.getElementById('policySeverity').value = policy.severity;
        document.getElementById('policyKeywords').value = policy.keywords;
        document.getElementById('policyRules').value = policy.rules;
        document.getElementById('policyAction').value = policy.action;
        document.getElementById('policyActive').checked = policy.is_active;

        document.getElementById('policyModalTitle').textContent = 'Edit Policy';
        new bootstrap.Modal(document.getElementById('policyModal')).show();
    })
    .catch(error => {
        console.error('Error:', error);
        showAlert('Failed to load policy details', 'danger');
    });
}

function deletePolicy(policyId) {
    if (!confirm('Are you sure you want to delete this policy? This action cannot be undone.')) {
        return;
    }

    fetch(`/api/admin/delete-policy/${policyId}`, {
        method: 'DELETE'
    })
    .then(response => response.json())
    .then(result => {
        if (result.success) {
            loadPolicies();
            loadPolicyViolationsData();
            showAlert('Policy deleted successfully', 'success');
        } else {
            showAlert('Error: ' + result.error, 'danger');
        }
    })
    .catch(error => {
        console.error('Error:', error);
        showAlert('Failed to delete policy', 'danger');
    });
}

function togglePolicyViolation(policyName, isActive) {
    fetch('/api/admin/toggle-policy-violation', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify({
            policy_name: policyName,
            is_active: isActive
        })
    })
    .then(response => response.json())
    .then(result => {
        if (result.success) {
            loadPolicyViolationsData();
            showAlert(result.message, 'success');
        } else {
            showAlert('Error: ' + result.error, 'danger');
        }
    });
}

function viewAllPolicies() {
    window.open('/admin-rules', '_blank');
}

function loadPolicies() {
    fetch('/api/admin/policies')
    .then(response => response.json())
    .then(policies => {
        console.log('Loaded policies:', policies.length);

        const tbody = document.getElementById('existingPoliciesBody');
        tbody.innerHTML = '';

        if (policies.length === 0) {
            tbody.innerHTML = '<tr><td colspan="4" class="text-center text-muted">No policies configured</td></tr>';
            return;
        }

        policies.forEach(policy => {
            const row = document.createElement('tr');
            row.innerHTML = `
                <td>
                    <strong>${policy.policy_name}</strong>
                    <br><small class="text-muted">${policy.description || 'No description'}</small>
                </td>
                <td>
                    <span class="badge bg-${getSeverityColor(policy.severity)}">${policy.severity}</span>
                </td>
                <td>
                    <span class="badge bg-${policy.is_active ? 'success' : 'secondary'}">
                        ${policy.is_active ? 'Active' : 'Inactive'}
                    </span>
                </td>
                <td>
                    <div class="btn-group btn-group-sm">
                        <button class="btn btn-primary btn-sm" onclick="editPolicy(${policy.id})" title="Edit Policy">
                            <i class="fas fa-edit"></i> Edit
                        </button>
                        <button class="btn btn-outline-danger btn-sm" onclick="deletePolicy(${policy.id})" title="Delete Policy">
                            <i class="fas fa-trash"></i>
                        </button>
                    </div>
                </td>
            `;
            tbody.appendChild(row);
        });
    })
    .catch(error => {
        console.error('Error loading policies:', error);
        const tbody = document.getElementById('existingPoliciesBody');
        tbody.innerHTML = '<tr><td colspan="4" class="text-center text-danger">Failed to load policies</td></tr>';
    });
}

function getSeverityColor(severity) {
    switch(severity) {
        case 'low': return 'success';
        case 'medium': return 'warning';
        case 'high': return 'danger';
        case 'critical': return 'dark';
        default: return 'secondary';
    }
}

function loadPolicyViolationsData() {
    fetch('/api/admin/policy-violations-data')
    .then(response => response.json())
    .then(violations => {
        const tbody = document.getElementById('policyViolationsBody');
        tbody.innerHTML = '';

        if (violations.error) {
            tbody.innerHTML = `<tr><td colspan="4" class="text-center text-danger">${violations.error}</td></tr>`;
            return;
        }

        if (violations.length === 0) {
            tbody.innerHTML = '<tr><td colspan="4" class="text-center text-muted">No policy violations found</td></tr>';
            return;
        }

        violations.forEach(violation => {
            const row = document.createElement('tr');
            row.innerHTML = `
                <td>
                    <strong>${violation.policy_name}</strong>
                    <br><small class="text-muted">${violation.percentage}% of violations</small>
                </td>
                <td>
                    <span class="badge bg-success">Active</span>
                </td>
                <td>
                    <span class="badge bg-warning">${violation.count}</span>
                </td>
                <td>
                    <div class="btn-group btn-group-sm">
                        <button class="btn btn-outline-primary btn-sm" onclick="editPolicyByName('${violation.policy_name}')" title="Edit Policy">
                            <i class="fas fa-edit"></i>
                        </button>
                        <button class="btn btn-outline-success btn-sm" onclick="togglePolicyViolation('${violation.policy_name}', true)" title="Enable Detection">
                            <i class="fas fa-play"></i>
                        </button>
                        <button class="btn btn-outline-warning btn-sm" onclick="togglePolicyViolation('${violation.policy_name}', false)" title="Disable Detection">
                            <i class="fas fa-pause"></i>
                        </button>
                    </div>
                </td>
            `;
            tbody.appendChild(row);
        });
    })
    .catch(error => {
        console.error('Error loading policy violations:', error);
        const tbody = document.getElementById('policyViolationsBody');
        tbody.innerHTML = '<tr><td colspan="4" class="text-center text-danger">Failed to load violations data</td></tr>';
    });
}

function editPolicyByName(policyName) {
    // First, find the policy by name from the loaded policies
    fetch('/api/admin/policies')
    .then(response => response.json())
    .then(policies => {
        const policy = policies.find(p => p.policy_name === policyName);

        if (policy) {
            // Use the existing editPolicy function
            editPolicy(policy.id);
        } else {
            // Create a new policy with the policy name pre-filled
            document.getElementById('policyForm').reset();
            document.getElementById('policyId').value = '';
            document.getElementById('policyName').value = policyName;
            document.getElementById('policyDescription').value = `Policy for ${policyName} violations`;
            document.getElementById('policyModalTitle').textContent = 'Create Policy for ' + policyName;

            new bootstrap.Modal(document.getElementById('policyModal')).show();
        }
    })
    .catch(error => {
        console.error('Error finding policy:', error);
        showAlert('Failed to load policy for editing', 'danger');
    });
}

function showAlert(message, type) {
    const alertDiv = document.createElement('div');
    alertDiv.className = `alert alert-${type} alert-dismissible fade show position-fixed`;
    alertDiv.style.cssText = 'top: 20px; right: 20px; z-index: 9999; min-width: 300px;';
    alertDiv.innerHTML = `
        ${message}
        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
    `;

    document.body.appendChild(alertDiv);

    // Auto-dismiss after 5 seconds
    setTimeout(() => {
        if (alertDiv.parentNode) {
            alertDiv.remove();
        }
    }, 5000);
}
</script>
{% endblock %}