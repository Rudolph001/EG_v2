
{% extends "base.html" %}

{% block title %}Admin Panel - Email Guardian{% endblock %}

{% block content %}
<div class="container-fluid py-4">
    <!-- Header -->
    <div class="row mb-5">
        <div class="col-12">
            <div class="text-center">
                <h1 class="display-4 fw-bold text-dark mb-3">
                    <i class="fas fa-cogs text-primary me-3"></i>
                    ADMIN CONTROL PANEL
                </h1>
                <p class="lead text-muted">System Configuration & Database Management</p>
            </div>
        </div>
    </div>

    <!-- Quick Stats Cards -->
    <div class="row mb-5 g-4">
        <div class="col-lg-2 col-md-4">
            <div class="card bg-primary text-white h-100 shadow">
                <div class="card-body text-center py-4">
                    <i class="fas fa-envelope fa-3x mb-3"></i>
                    <h3 class="mb-0" id="emailCount">{{ stats.emails or 0 }}</h3>
                    <p class="mb-0 fw-bold">Total Emails</p>
                </div>
            </div>
        </div>
        <div class="col-lg-2 col-md-4">
            <div class="card bg-warning text-dark h-100 shadow">
                <div class="card-body text-center py-4">
                    <i class="fas fa-gavel fa-3x mb-3"></i>
                    <h3 class="mb-0" id="caseCount">{{ stats.cases or 0 }}</h3>
                    <p class="mb-0 fw-bold">Active Cases</p>
                </div>
            </div>
        </div>
        <div class="col-lg-2 col-md-4">
            <div class="card bg-danger text-white h-100 shadow">
                <div class="card-body text-center py-4">
                    <i class="fas fa-user-times fa-3x mb-3"></i>
                    <h3 class="mb-0" id="flaggedCount">{{ stats.flagged_senders or 0 }}</h3>
                    <p class="mb-0 fw-bold">Flagged Senders</p>
                </div>
            </div>
        </div>
        <div class="col-lg-2 col-md-4">
            <div class="card bg-success text-white h-100 shadow">
                <div class="card-body text-center py-4">
                    <i class="fas fa-shield-alt fa-3x mb-3"></i>
                    <h3 class="mb-0" id="rulesCount">{{ stats.admin_rules or 0 }}</h3>
                    <p class="mb-0 fw-bold">Security Rules</p>
                </div>
            </div>
        </div>
        <div class="col-lg-2 col-md-4">
            <div class="card bg-info text-white h-100 shadow">
                <div class="card-body text-center py-4">
                    <i class="fas fa-robot fa-3x mb-3"></i>
                    <h3 class="mb-0">1</h3>
                    <p class="mb-0 fw-bold">ML Models</p>
                </div>
            </div>
        </div>
        <div class="col-lg-2 col-md-4">
            <div class="card bg-secondary text-white h-100 shadow">
                <div class="card-body text-center py-4">
                    <i class="fas fa-database fa-3x mb-3"></i>
                    <h3 class="mb-0">Active</h3>
                    <p class="mb-0 fw-bold">Database</p>
                </div>
            </div>
        </div>
    </div>

    <!-- Main Admin Sections -->
    <div class="row g-4">
        <!-- Machine Learning Section -->
        <div class="col-lg-6">
            <div class="card shadow-lg border-0 h-100">
                <div class="card-header bg-gradient text-white py-4" style="background: linear-gradient(45deg, #667eea 0%, #764ba2 100%);">
                    <h3 class="mb-0 text-center">
                        <i class="fas fa-robot me-2"></i>
                        MACHINE LEARNING CONTROLS
                    </h3>
                </div>
                <div class="card-body p-4">
                    <div class="row mb-4">
                        <div class="col-md-6">
                            <label class="form-label fw-bold fs-6">Risk Detection Threshold</label>
                            <input type="range" class="form-range" id="riskThreshold" min="0" max="100" value="70">
                            <div class="text-center mt-2">
                                <span id="riskThresholdValue" class="badge bg-primary fs-6 px-3 py-2">70%</span>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <label class="form-label fw-bold fs-6">Confidence Level</label>
                            <input type="range" class="form-range" id="confidenceThreshold" min="0" max="100" value="85">
                            <div class="text-center mt-2">
                                <span id="confidenceThresholdValue" class="badge bg-success fs-6 px-3 py-2">85%</span>
                            </div>
                        </div>
                    </div>
                    
                    <div class="d-grid gap-3">
                        <button class="btn btn-primary btn-lg py-3" onclick="trainModel()">
                            <i class="fas fa-brain me-2"></i>
                            TRAIN BASIC MODEL
                        </button>
                        <button class="btn btn-success btn-lg py-3" onclick="trainAdvancedModels()">
                            <i class="fas fa-robot me-2"></i>
                            TRAIN ADVANCED MODELS
                        </button>
                        <button class="btn btn-outline-secondary btn-lg py-3" onclick="saveMLSettings()">
                            <i class="fas fa-save me-2"></i>
                            SAVE ML SETTINGS
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <!-- Database Management Section -->
        <div class="col-lg-6">
            <div class="card shadow-lg border-danger h-100">
                <div class="card-header bg-danger text-white py-4">
                    <h3 class="mb-0 text-center">
                        <i class="fas fa-database me-2"></i>
                        DATABASE CLEANUP
                    </h3>
                </div>
                <div class="card-body p-4">
                    <div class="alert alert-warning border-warning border-3 mb-4">
                        <i class="fas fa-exclamation-triangle me-2 fs-4"></i>
                        <strong class="fs-5">WARNING:</strong> These operations permanently delete data and cannot be undone!
                    </div>

                    <div class="d-grid gap-3">
                        <button class="btn btn-outline-primary btn-lg py-3" onclick="clearEmails()">
                            <i class="fas fa-envelope me-2"></i>
                            CLEAR ALL EMAILS
                        </button>
                        
                        <button class="btn btn-outline-warning btn-lg py-3" onclick="clearCases()">
                            <i class="fas fa-gavel me-2"></i>
                            CLEAR ALL CASES
                        </button>
                        
                        <button class="btn btn-outline-info btn-lg py-3" onclick="clearFlaggedSenders()">
                            <i class="fas fa-user-times me-2"></i>
                            CLEAR FLAGGED SENDERS
                        </button>
                        
                        <button class="btn btn-danger btn-lg py-3" onclick="clearAllData()">
                            <i class="fas fa-nuclear me-2"></i>
                            RESET ENTIRE DATABASE
                        </button>
                    </div>

                    <hr class="my-4">

                    <!-- Database Stats -->
                    <div class="row text-center">
                        <div class="col-3">
                            <div class="h4 text-primary fw-bold" id="emailCountDetail">-</div>
                            <small class="text-muted fw-bold">Emails</small>
                        </div>
                        <div class="col-3">
                            <div class="h4 text-warning fw-bold" id="caseCountDetail">-</div>
                            <small class="text-muted fw-bold">Cases</small>
                        </div>
                        <div class="col-3">
                            <div class="h4 text-info fw-bold" id="flaggedCountDetail">-</div>
                            <small class="text-muted fw-bold">Flagged</small>
                        </div>
                        <div class="col-3">
                            <div class="h4 text-success fw-bold" id="rulesCountDetail">-</div>
                            <small class="text-muted fw-bold">Rules</small>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Security Rules Management -->
        <div class="col-lg-6">
            <div class="card shadow-lg border-0 h-100">
                <div class="card-header text-white py-4" style="background: linear-gradient(45deg, #f093fb 0%, #f5576c 100%);">
                    <h3 class="mb-0 text-center">
                        <i class="fas fa-shield-alt me-2"></i>
                        SECURITY RULES
                    </h3>
                </div>
                <div class="card-body p-4">
                    <p class="text-muted fs-5 mb-4">Configure security threat detection and filtering rules for incoming emails.</p>
                    
                    <div class="d-grid gap-3 mb-4">
                        <button class="btn btn-primary btn-lg py-3" onclick="showRuleModal('security')">
                            <i class="fas fa-plus me-2"></i>
                            ADD NEW SECURITY RULE
                        </button>
                        
                        <button class="btn btn-outline-secondary btn-lg py-3" onclick="viewAllRules()">
                            <i class="fas fa-list me-2"></i>
                            VIEW ALL RULES
                        </button>
                    </div>

                    <!-- Simple Rules List -->
                    <div class="table-responsive">
                        <table class="table table-striped" id="securityRulesTable">
                            <thead class="table-dark">
                                <tr>
                                    <th>Rule Name</th>
                                    <th>Status</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody id="securityRulesBody">
                                <tr>
                                    <td colspan="3" class="text-center text-muted">No rules configured</td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>

        <!-- Email Filtering Settings -->
        <div class="col-lg-6">
            <div class="card shadow-lg border-0 h-100">
                <div class="card-header text-white py-4" style="background: linear-gradient(45deg, #4facfe 0%, #00f2fe 100%);">
                    <h3 class="mb-0 text-center">
                        <i class="fas fa-filter me-2"></i>
                        EMAIL FILTERING
                    </h3>
                </div>
                <div class="card-body p-4">
                    <div class="row g-3">
                        <!-- Whitelist Management -->
                        <div class="col-md-6">
                            <div class="card border-success">
                                <div class="card-header bg-success text-white">
                                    <h6 class="mb-0">
                                        <i class="fas fa-check-circle me-1"></i>
                                        TRUSTED SENDERS
                                    </h6>
                                </div>
                                <div class="card-body">
                                    <div class="input-group mb-3">
                                        <input type="email" class="form-control" id="newSender" placeholder="email@domain.com">
                                        <button class="btn btn-success" onclick="addWhitelistItem('sender')">
                                            <i class="fas fa-plus"></i>
                                        </button>
                                    </div>
                                    <div id="whitelistSenders" class="border rounded p-2" style="height: 120px; overflow-y: auto; background-color: #f8f9fa;">
                                        <small class="text-muted">No trusted senders added</small>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Domain Management -->
                        <div class="col-md-6">
                            <div class="card border-info">
                                <div class="card-header bg-info text-white">
                                    <h6 class="mb-0">
                                        <i class="fas fa-globe me-1"></i>
                                        TRUSTED DOMAINS
                                    </h6>
                                </div>
                                <div class="card-body">
                                    <div class="input-group mb-3">
                                        <input type="text" class="form-control" id="newDomain" placeholder="company.com">
                                        <button class="btn btn-info" onclick="addWhitelistItem('domain')">
                                            <i class="fas fa-plus"></i>
                                        </button>
                                    </div>
                                    <div id="whitelistDomains" class="border rounded p-2" style="height: 120px; overflow-y: auto; background-color: #f8f9fa;">
                                        <small class="text-muted">No trusted domains added</small>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Risk Keywords -->
                        <div class="col-md-6">
                            <div class="card border-danger">
                                <div class="card-header bg-danger text-white">
                                    <h6 class="mb-0">
                                        <i class="fas fa-exclamation-triangle me-1"></i>
                                        RISK KEYWORDS
                                    </h6>
                                </div>
                                <div class="card-body">
                                    <div class="input-group mb-3">
                                        <input type="text" class="form-control" id="newRiskKeyword" placeholder="suspicious keyword">
                                        <button class="btn btn-danger" onclick="addKeyword('risk')">
                                            <i class="fas fa-plus"></i>
                                        </button>
                                    </div>
                                    <div id="riskKeywords" class="border rounded p-2" style="height: 120px; overflow-y: auto; background-color: #f8f9fa;">
                                        <small class="text-muted">No risk keywords added</small>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Exclusion Keywords -->
                        <div class="col-md-6">
                            <div class="card border-secondary">
                                <div class="card-header bg-secondary text-white">
                                    <h6 class="mb-0">
                                        <i class="fas fa-times-circle me-1"></i>
                                        EXCLUSION KEYWORDS
                                    </h6>
                                </div>
                                <div class="card-body">
                                    <div class="input-group mb-3">
                                        <input type="text" class="form-control" id="newExcludeKeyword" placeholder="exclude keyword">
                                        <button class="btn btn-secondary" onclick="addKeyword('exclude')">
                                            <i class="fas fa-plus"></i>
                                        </button>
                                    </div>
                                    <div id="excludeKeywords" class="border rounded p-2" style="height: 120px; overflow-y: auto; background-color: #f8f9fa;">
                                        <small class="text-muted">No exclusion keywords added</small>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Rule Modal -->
<div class="modal fade" id="ruleModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header bg-primary text-white">
                <h5 class="modal-title" id="ruleModalTitle">Add Security Rule</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form id="ruleForm">
                    <input type="hidden" id="ruleType" name="rule_type" value="security">
                    <input type="hidden" id="ruleId" name="rule_id">

                    <div class="mb-3">
                        <label class="form-label fw-bold">Rule Name</label>
                        <input type="text" class="form-control" id="ruleName" name="rule_name" required placeholder="e.g., Block Phishing Attempts">
                    </div>

                    <div class="mb-3">
                        <label class="form-label fw-bold">Logic Type</label>
                        <select class="form-select" id="ruleLogic" name="logic_type" required>
                            <option value="AND">AND (All conditions must match)</option>
                            <option value="OR">OR (Any condition can match)</option>
                        </select>
                    </div>

                    <div class="mb-3">
                        <label class="form-label fw-bold">Risk Level</label>
                        <select class="form-select" id="riskLevel" name="risk_level">
                            <option value="low">Low Risk</option>
                            <option value="medium" selected>Medium Risk</option>
                            <option value="high">High Risk</option>
                            <option value="critical">Critical Risk</option>
                        </select>
                    </div>

                    <div class="mb-3">
                        <label class="form-label fw-bold">Conditions</label>
                        <div id="conditionsContainer">
                            <!-- Dynamic conditions will be added here -->
                        </div>
                        <button type="button" class="btn btn-outline-primary btn-sm mt-2" onclick="addCondition()">
                            <i class="fas fa-plus"></i> Add Condition
                        </button>
                    </div>

                    <div class="mb-3">
                        <div class="form-check">
                            <input class="form-check-input" type="checkbox" id="ruleActive" name="is_active" checked>
                            <label class="form-check-label fw-bold" for="ruleActive">
                                Enable rule immediately
                            </label>
                        </div>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-primary" onclick="saveRule()">
                    <i class="fas fa-save"></i> Save Rule
                </button>
            </div>
        </div>
    </div>
</div>

<script>
let conditionCounter = 0;

// Initialize page
document.addEventListener('DOMContentLoaded', function() {
    refreshDatabaseStats();
    loadKeywords();
    loadWhitelist();
    loadMLSettings();
    loadSecurityRules();

    // Setup threshold value displays
    document.getElementById('riskThreshold').addEventListener('input', function() {
        document.getElementById('riskThresholdValue').textContent = this.value + '%';
    });

    document.getElementById('confidenceThreshold').addEventListener('input', function() {
        document.getElementById('confidenceThresholdValue').textContent = this.value + '%';
    });
});

// ML Functions
function trainModel() {
    const button = event.target;
    button.disabled = true;
    button.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Training...';

    fetch('/api/train-model', {
        method: 'POST'
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            showAlert(`Model trained successfully! Accuracy: ${(data.accuracy * 100).toFixed(1)}%`, 'success');
        } else {
            showAlert('Error training model: ' + data.error, 'danger');
        }
    })
    .catch(error => {
        console.error('Error:', error);
        showAlert('Error training model', 'danger');
    })
    .finally(() => {
        button.disabled = false;
        button.innerHTML = '<i class="fas fa-brain me-2"></i> TRAIN BASIC MODEL';
    });
}

function trainAdvancedModels() {
    const button = event.target;
    button.disabled = true;
    button.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Training Advanced...';

    fetch('/api/train-advanced-models', {
        method: 'POST'
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            const results = data.results;
            showAlert(`Advanced models trained! Accuracy: ${(results.ensemble_accuracy * 100).toFixed(1)}%`, 'success');
        } else {
            showAlert('Error training advanced models: ' + data.error, 'danger');
        }
    })
    .catch(error => {
        console.error('Error:', error);
        showAlert('Error training advanced models', 'danger');
    })
    .finally(() => {
        button.disabled = false;
        button.innerHTML = '<i class="fas fa-robot me-2"></i> TRAIN ADVANCED MODELS';
    });
}

function saveMLSettings() {
    const settings = {
        risk_threshold: document.getElementById('riskThreshold').value,
        confidence_threshold: document.getElementById('confidenceThreshold').value
    };

    fetch('/api/admin/save-ml-settings', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify(settings)
    })
    .then(response => response.json())
    .then(result => {
        if (result.success) {
            showAlert('ML settings saved successfully', 'success');
        } else {
            showAlert('Error: ' + result.error, 'danger');
        }
    });
}

// Database Management Functions
function clearEmails() {
    if (!confirm('Are you sure you want to delete ALL email records? This action cannot be undone.')) {
        return;
    }

    if (prompt('Type "DELETE" to confirm:') !== 'DELETE') {
        return;
    }

    fetch('/api/admin/clear-emails', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        }
    })
    .then(response => response.json())
    .then(result => {
        if (result.success) {
            showAlert(`Successfully deleted ${result.deleted_count} email records`, 'success');
            refreshDatabaseStats();
        } else {
            showAlert('Error: ' + result.error, 'danger');
        }
    })
    .catch(error => {
        console.error('Error:', error);
        showAlert('Failed to clear email data', 'danger');
    });
}

function clearCases() {
    if (!confirm('Are you sure you want to delete ALL case records? This action cannot be undone.')) {
        return;
    }

    fetch('/api/admin/clear-cases', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        }
    })
    .then(response => response.json())
    .then(result => {
        if (result.success) {
            showAlert(`Successfully deleted ${result.deleted_count} case records`, 'success');
            refreshDatabaseStats();
        } else {
            showAlert('Error: ' + result.error, 'danger');
        }
    })
    .catch(error => {
        console.error('Error:', error);
        showAlert('Failed to clear case data', 'danger');
    });
}

function clearFlaggedSenders() {
    if (!confirm('Are you sure you want to delete ALL flagged sender records? This action cannot be undone.')) {
        return;
    }

    fetch('/api/admin/clear-flagged-senders', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        }
    })
    .then(response => response.json())
    .then(result => {
        if (result.success) {
            showAlert(`Successfully deleted ${result.deleted_count} flagged sender records`, 'success');
            refreshDatabaseStats();
        } else {
            showAlert('Error: ' + result.error, 'danger');
        }
    })
    .catch(error => {
        console.error('Error:', error);
        showAlert('Failed to clear flagged senders', 'danger');
    });
}

function clearAllData() {
    if (!confirm('⚠️ DANGER: This will delete ALL data including emails, cases, and flagged senders. This action cannot be undone.')) {
        return;
    }

    const confirmation = prompt('Type "RESET DATABASE" to confirm complete data deletion:');
    if (confirmation !== 'RESET DATABASE') {
        showAlert('Operation cancelled - confirmation text did not match', 'info');
        return;
    }

    fetch('/api/admin/clear-all-data', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        }
    })
    .then(response => response.json())
    .then(result => {
        if (result.success) {
            showAlert(`Database reset complete. Deleted: ${result.summary}`, 'warning');
            refreshDatabaseStats();
        } else {
            showAlert('Error: ' + result.error, 'danger');
        }
    })
    .catch(error => {
        console.error('Error:', error);
        showAlert('Failed to reset database', 'danger');
    });
}

// Keyword Management
function addKeyword(type) {
    const inputId = type === 'risk' ? 'newRiskKeyword' : 'newExcludeKeyword';
    const keyword = document.getElementById(inputId).value.trim();

    if (!keyword) return;

    fetch('/api/admin/add-keyword', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify({ type: type, keyword: keyword })
    })
    .then(response => response.json())
    .then(result => {
        if (result.success) {
            document.getElementById(inputId).value = '';
            loadKeywords();
            showAlert('Keyword added successfully', 'success');
        } else {
            showAlert('Error: ' + result.error, 'danger');
        }
    });
}

function removeKeyword(type, keyword) {
    fetch('/api/admin/remove-keyword', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify({ type: type, keyword: keyword })
    })
    .then(response => response.json())
    .then(result => {
        if (result.success) {
            loadKeywords();
            showAlert('Keyword removed successfully', 'success');
        } else {
            showAlert('Error: ' + result.error, 'danger');
        }
    });
}

// Whitelist Management
function addWhitelistItem(type) {
    const inputId = type === 'sender' ? 'newSender' : 'newDomain';
    const value = document.getElementById(inputId).value.trim();

    if (!value) return;

    fetch('/api/admin/add-whitelist', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify({ type: type, value: value })
    })
    .then(response => response.json())
    .then(result => {
        if (result.success) {
            document.getElementById(inputId).value = '';
            loadWhitelist();
            showAlert('Whitelist item added successfully', 'success');
        } else {
            showAlert('Error: ' + result.error, 'danger');
        }
    });
}

function removeWhitelistItem(type, value) {
    fetch('/api/admin/remove-whitelist', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify({ type: type, value: value })
    })
    .then(response => response.json())
    .then(result => {
        if (result.success) {
            loadWhitelist();
            showAlert('Whitelist item removed successfully', 'success');
        } else {
            showAlert('Error: ' + result.error, 'danger');
        }
    });
}

// Rule Management
function showRuleModal() {
    // Clear form
    document.getElementById('ruleForm').reset();
    document.getElementById('conditionsContainer').innerHTML = '';
    conditionCounter = 0;
    addCondition();

    new bootstrap.Modal(document.getElementById('ruleModal')).show();
}

function addCondition() {
    const container = document.getElementById('conditionsContainer');
    const conditionId = `condition_${conditionCounter++}`;

    const conditionHtml = `
        <div class="condition-row border rounded p-3 mb-3 bg-light" id="${conditionId}">
            <div class="row g-2">
                <div class="col-md-3">
                    <label class="form-label fw-bold">Field</label>
                    <select class="form-select condition-field">
                        <option value="sender">Sender</option>
                        <option value="subject">Subject</option>
                        <option value="domain">Domain</option>
                        <option value="attachment">Attachment</option>
                        <option value="department">Department</option>
                        <option value="recipient">Recipient</option>
                    </select>
                </div>
                <div class="col-md-3">
                    <label class="form-label fw-bold">Operator</label>
                    <select class="form-select condition-operator">
                        <option value="contains">Contains</option>
                        <option value="equals">Equals</option>
                        <option value="starts_with">Starts With</option>
                        <option value="ends_with">Ends With</option>
                        <option value="regex">Regex Match</option>
                    </select>
                </div>
                <div class="col-md-5">
                    <label class="form-label fw-bold">Value</label>
                    <input type="text" class="form-control condition-value" placeholder="Enter value">
                </div>
                <div class="col-md-1 d-flex align-items-end">
                    <button type="button" class="btn btn-outline-danger btn-sm" onclick="removeCondition('${conditionId}')">
                        <i class="fas fa-trash"></i>
                    </button>
                </div>
            </div>
        </div>
    `;

    container.insertAdjacentHTML('beforeend', conditionHtml);
}

function removeCondition(conditionId) {
    document.getElementById(conditionId).remove();
}

function saveRule() {
    const form = document.getElementById('ruleForm');
    const formData = new FormData(form);

    // Collect conditions
    const conditions = [];
    document.querySelectorAll('.condition-row').forEach(row => {
        const field = row.querySelector('.condition-field').value;
        const operator = row.querySelector('.condition-operator').value;
        const value = row.querySelector('.condition-value').value;

        if (field && operator && value) {
            conditions.push({ field, operator, value });
        }
    });

    const ruleData = {
        rule_type: 'security',
        rule_name: formData.get('rule_name'),
        logic_type: formData.get('logic_type'),
        conditions: JSON.stringify(conditions),
        risk_level: formData.get('risk_level'),
        is_active: formData.get('is_active') ? true : false
    };

    fetch('/api/admin/save-rule', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify(ruleData)
    })
    .then(response => response.json())
    .then(result => {
        if (result.success) {
            bootstrap.Modal.getInstance(document.getElementById('ruleModal')).hide();
            loadSecurityRules();
            showAlert('Rule saved successfully', 'success');
        } else {
            showAlert('Error: ' + result.error, 'danger');
        }
    })
    .catch(error => {
        console.error('Error:', error);
        showAlert('An error occurred while saving the rule.', 'danger');
    });
}

function viewAllRules() {
    window.open('/admin-rules', '_blank');
}

// Load Functions
function refreshDatabaseStats() {
    fetch('/api/admin/database-stats')
    .then(response => response.json())
    .then(stats => {
        document.getElementById('emailCount').textContent = stats.emails || 0;
        document.getElementById('caseCount').textContent = stats.cases || 0;
        document.getElementById('flaggedCount').textContent = stats.flagged_senders || 0;
        document.getElementById('rulesCount').textContent = stats.admin_rules || 0;
        
        // Update detail counts
        document.getElementById('emailCountDetail').textContent = stats.emails || 0;
        document.getElementById('caseCountDetail').textContent = stats.cases || 0;
        document.getElementById('flaggedCountDetail').textContent = stats.flagged_senders || 0;
        document.getElementById('rulesCountDetail').textContent = stats.admin_rules || 0;
    })
    .catch(error => {
        console.error('Error loading database stats:', error);
    });
}

function loadKeywords() {
    ['risk', 'exclude'].forEach(type => {
        fetch(`/api/admin/keywords/${type}`)
        .then(response => response.json())
        .then(keywords => {
            const container = document.getElementById(`${type}Keywords`);
            container.innerHTML = '';

            if (keywords.length === 0) {
                container.innerHTML = `<small class="text-muted">No ${type} keywords added</small>`;
                return;
            }

            keywords.forEach(keyword => {
                const tag = document.createElement('span');
                tag.className = 'badge bg-light text-dark border me-1 mb-1';
                tag.innerHTML = `
                    ${keyword}
                    <i class="fas fa-times ms-1 text-danger" style="cursor: pointer;" onclick="removeKeyword('${type}', '${keyword}')"></i>
                `;
                container.appendChild(tag);
            });
        });
    });
}

function loadWhitelist() {
    ['sender', 'domain'].forEach(type => {
        fetch(`/api/admin/whitelist/${type}`)
        .then(response => response.json())
        .then(items => {
            const container = document.getElementById(`whitelist${type.charAt(0).toUpperCase() + type.slice(1)}s`);
            container.innerHTML = '';

            if (items.length === 0) {
                container.innerHTML = `<small class="text-muted">No trusted ${type}s added</small>`;
                return;
            }

            items.forEach(item => {
                const element = document.createElement('div');
                element.className = 'd-flex justify-content-between align-items-center p-1 mb-1 bg-white border rounded';
                element.innerHTML = `
                    <small>${item}</small>
                    <i class="fas fa-times text-danger" style="cursor: pointer;" onclick="removeWhitelistItem('${type}', '${item}')"></i>
                `;
                container.appendChild(element);
            });
        });
    });
}

function loadMLSettings() {
    fetch('/api/admin/ml-settings')
    .then(response => response.json())
    .then(settings => {
        document.getElementById('riskThreshold').value = settings.risk_threshold || 70;
        document.getElementById('confidenceThreshold').value = settings.confidence_threshold || 85;

        document.getElementById('riskThresholdValue').textContent = (settings.risk_threshold || 70) + '%';
        document.getElementById('confidenceThresholdValue').textContent = (settings.confidence_threshold || 85) + '%';
    })
    .catch(error => {
        console.error('Error loading ML settings:', error);
    });
}

function loadSecurityRules() {
    fetch('/api/admin/rules/security')
    .then(response => response.json())
    .then(rules => {
        const tbody = document.getElementById('securityRulesBody');
        tbody.innerHTML = '';

        if (rules.length === 0) {
            tbody.innerHTML = '<tr><td colspan="3" class="text-center text-muted">No rules configured</td></tr>';
            return;
        }

        rules.forEach(rule => {
            const row = document.createElement('tr');
            row.innerHTML = `
                <td>${rule.rule_name}</td>
                <td>
                    <span class="badge bg-${rule.is_active ? 'success' : 'secondary'}">
                        ${rule.is_active ? 'Active' : 'Inactive'}
                    </span>
                </td>
                <td>
                    <div class="btn-group btn-group-sm">
                        <button class="btn btn-outline-danger btn-sm" onclick="deleteRule(${rule.id})">
                            <i class="fas fa-trash"></i>
                        </button>
                    </div>
                </td>
            `;
            tbody.appendChild(row);
        });
    })
    .catch(error => {
        console.error('Error loading security rules:', error);
    });
}

function deleteRule(ruleId) {
    if (!confirm('Are you sure you want to delete this rule?')) {
        return;
    }

    fetch(`/api/admin/delete-rule/${ruleId}`, {
        method: 'DELETE'
    })
    .then(response => response.json())
    .then(result => {
        if (result.success) {
            loadSecurityRules();
            showAlert('Rule deleted successfully', 'success');
        } else {
            showAlert('Error: ' + result.error, 'danger');
        }
    });
}

function showAlert(message, type) {
    const alertDiv = document.createElement('div');
    alertDiv.className = `alert alert-${type} alert-dismissible fade show position-fixed`;
    alertDiv.style.cssText = 'top: 20px; right: 20px; z-index: 9999; min-width: 300px;';
    alertDiv.innerHTML = `
        ${message}
        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
    `;

    document.body.appendChild(alertDiv);

    // Auto-dismiss after 5 seconds
    setTimeout(() => {
        if (alertDiv.parentNode) {
            alertDiv.remove();
        }
    }, 5000);
}
</script>
{% endblock %}
