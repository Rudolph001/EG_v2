
{% extends "base.html" %}

{% block title %}Main Dashboard - Email Guardian{% endblock %}

{% block content %}

<script src="{{ url_for('static', filename='js/dashboard.js') }}"></script>
<div class="row">
    <div class="col-12">
        <h1 class="mb-4">
            <i class="fas fa-tachometer-alt"></i>
            Main Dashboard
            <small class="text-muted">Active Email Monitoring</small>
        </h1>
    </div>
</div>

<!-- Key Metrics Cards -->
<div class="row mb-4">
    <div class="col-md-3">
        <div class="card bg-primary text-white">
            <div class="card-body">
                <div class="d-flex justify-content-between">
                    <div>
                        <h5 class="card-title">Total Emails</h5>
                        <h2 class="mb-0 stats-total-emails">{{ "{:,}".format(stats.total_emails) }}</h2>
                    </div>
                    <div class="align-self-center">
                        <i class="fas fa-envelope fa-2x"></i>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <div class="col-md-3">
        <a href="{{ url_for('cases') }}" class="text-decoration-none">
            <div class="card bg-warning text-dark card-clickable">
                <div class="card-body">
                    <div class="d-flex justify-content-between">
                        <div>
                            <h5 class="card-title">Active Cases</h5>
                            <h2 class="mb-0 stats-active-cases">{{ stats.active_cases }}</h2>
                        </div>
                        <div class="align-self-center">
                            <i class="fas fa-exclamation-triangle fa-2x"></i>
                        </div>
                    </div>
                </div>
            </div>
        </a>
    </div>
    
    <div class="col-md-3">
        <a href="{{ url_for('flagged_senders') }}" class="text-decoration-none">
            <div class="card bg-danger text-white card-clickable">
                <div class="card-body">
                    <div class="d-flex justify-content-between">
                        <div>
                            <h5 class="card-title">Flagged Senders</h5>
                            <h2 class="mb-0 stats-flagged-senders">{{ stats.flagged_senders }}</h2>
                        </div>
                        <div class="align-self-center">
                            <i class="fas fa-flag fa-2x"></i>
                        </div>
                    </div>
                </div>
            </div>
        </a>
    </div>
    
    <div class="col-md-3">
        <div class="card bg-success text-white">
            <div class="card-body">
                <div class="d-flex justify-content-between">
                    <div>
                        <h5 class="card-title">Today's Emails</h5>
                        <h2 class="mb-0 stats-todays-emails">{{ stats.todays_emails }}</h2>
                    </div>
                    <div class="align-self-center">
                        <i class="fas fa-calendar-day fa-2x"></i>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Second Row of KPI Cards -->
<div class="row mb-4">
    <div class="col-md-3">
        <a href="{{ url_for('excluded_whitelisted') }}" class="text-decoration-none">
            <div class="card bg-secondary text-white card-clickable">
                <div class="card-body">
                    <div class="d-flex justify-content-between">
                        <div>
                            <h5 class="card-title">Excluded/Whitelisted</h5>
                            <h2 class="mb-0 stats-excluded-whitelisted">{{ stats.get('excluded_whitelisted', 0) }}</h2>
                        </div>
                        <div class="align-self-center">
                            <i class="fas fa-filter fa-2x"></i>
                        </div>
                    </div>
                </div>
            </div>
        </a>
    </div>
    
    <div class="col-md-3">
        <a href="{{ url_for('cleared_emails') }}" class="text-decoration-none">
            <div class="card bg-success text-white card-clickable">
                <div class="card-body">
                    <div class="d-flex justify-content-between">
                        <div>
                            <h5 class="card-title">Cleared</h5>
                            <h2 class="mb-0 stats-cleared">{{ stats.get('cleared', 0) }}</h2>
                        </div>
                        <div class="align-self-center">
                            <i class="fas fa-check fa-2x"></i>
                        </div>
                    </div>
                </div>
            </div>
        </a>
    </div>
    
    <div class="col-md-6">
        <!-- Space for future KPI cards -->
    </div>
</div>

<!-- Advanced Search and Filters -->
<div class="row mb-4">
    <div class="col-12">
        <div class="card">
            <div class="card-header">
                <h5 class="mb-0">
                    <i class="fas fa-filter"></i>
                    Advanced Search & Filters
                    <button class="btn btn-sm btn-outline-secondary ms-2" type="button" data-bs-toggle="collapse" data-bs-target="#advancedFilters">
                        <i class="fas fa-chevron-down"></i> More Filters
                    </button>
                </h5>
            </div>
            <div class="card-body">
                <form method="GET" class="row g-3">
                    <!-- Primary Filters -->
                    <div class="col-md-4">
                        <label for="search" class="form-label">Search</label>
                        <input type="text" class="form-control" id="search" name="search" 
                               value="{{ search }}" placeholder="Search all fields...">
                        <small class="form-text text-muted">Search sender, subject, justifications, recipients</small>
                    </div>
                    <div class="col-md-3">
                        <label for="sender" class="form-label">Sender</label>
                        <input type="text" class="form-control" id="sender" name="sender" 
                               value="{{ sender }}" placeholder="Filter by sender...">
                    </div>
                    <div class="col-md-3">
                        <label for="department" class="form-label">Department</label>
                        <select class="form-select" id="department" name="department">
                            <option value="">All Departments</option>
                            {% for dept in departments %}
                            <option value="{{ dept[0] }}" {% if department == dept[0] %}selected{% endif %}>
                                {{ dept[0] }}
                            </option>
                            {% endfor %}
                        </select>
                    </div>
                    <div class="col-md-2">
                        <label class="form-label">&nbsp;</label>
                        <div class="d-grid">
                            <button type="submit" class="btn btn-primary">
                                <i class="fas fa-search"></i> Search
                            </button>
                        </div>
                    </div>

                    <!-- Advanced Filters (Collapsible) -->
                    <div class="collapse" id="advancedFilters">
                        <hr>
                        <div class="row g-3">
                            <div class="col-md-3">
                                <label for="risk_level" class="form-label">Risk Level</label>
                                <select class="form-select" id="risk_level" name="risk_level">
                                    <option value="">All Risk Levels</option>
                                    {% for risk in risk_levels %}
                                    <option value="{{ risk[0] }}" {% if risk_level == risk[0] %}selected{% endif %}>
                                        {{ risk[0] }}
                                    </option>
                                    {% endfor %}
                                </select>
                            </div>
                            <div class="col-md-3">
                                <label for="policy" class="form-label">Policy</label>
                                <select class="form-select" id="policy" name="policy">
                                    <option value="">All Policies</option>
                                    {% for pol in policies %}
                                    <option value="{{ pol[0] }}" {% if policy == pol[0] %}selected{% endif %}>
                                        {{ pol[0] }}
                                    </option>
                                    {% endfor %}
                                </select>
                            </div>
                            <div class="col-md-3">
                                <label for="status" class="form-label">Status</label>
                                <select class="form-select" id="status" name="status">
                                    <option value="">All Statuses</option>
                                    {% for stat in statuses %}
                                    <option value="{{ stat[0] }}" {% if status == stat[0] %}selected{% endif %}>
                                        {{ stat[0] }}
                                    </option>
                                    {% endfor %}
                                </select>
                            </div>
                            <div class="col-md-3">
                                <label for="sort_by" class="form-label">Sort By</label>
                                <select class="form-select" id="sort_by" name="sort_by">
                                    <option value="_time" {% if sort_by == '_time' %}selected{% endif %}>Date</option>
                                    <option value="sender" {% if sort_by == 'sender' %}selected{% endif %}>Sender</option>
                                    <option value="subject" {% if sort_by == 'subject' %}selected{% endif %}>Subject</option>
                                    <option value="department" {% if sort_by == 'department' %}selected{% endif %}>Department</option>
                                    <option value="final_outcome" {% if sort_by == 'final_outcome' %}selected{% endif %}>Status</option>
                                </select>
                            </div>
                            <div class="col-md-3">
                                <label for="date_from" class="form-label">Date From</label>
                                <input type="date" class="form-control" id="date_from" name="date_from" value="{{ date_from }}">
                            </div>
                            <div class="col-md-3">
                                <label for="date_to" class="form-label">Date To</label>
                                <input type="date" class="form-control" id="date_to" name="date_to" value="{{ date_to }}">
                            </div>
                            <div class="col-md-3">
                                <label for="sort_order" class="form-label">Order</label>
                                <select class="form-select" id="sort_order" name="sort_order">
                                    <option value="DESC" {% if sort_order == 'DESC' %}selected{% endif %}>Newest First</option>
                                    <option value="ASC" {% if sort_order == 'ASC' %}selected{% endif %}>Oldest First</option>
                                </select>
                            </div>
                            <div class="col-md-3 d-flex align-items-end">
                                <div class="btn-group w-100" role="group">
                                    <a href="{{ url_for('dashboard') }}" class="btn btn-outline-secondary">
                                        <i class="fas fa-times"></i> Clear All
                                    </a>
                                    <button type="submit" class="btn btn-success">
                                        <i class="fas fa-filter"></i> Apply Filters
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>

<!-- Email List -->
<div class="row">
    <div class="col-12">
        <div class="card">
            <div class="card-header">
                <h5 class="mb-0">
                    <i class="fas fa-envelope"></i>
                    Active Emails ({{ total }} total)
                </h5>
            </div>
            <div class="card-body">
                {% if emails %}
                <div class="table-responsive">
                    <table class="table table-striped table-hover data-table">
                        <thead>
                            <tr>
                                <th>Date</th>
                                <th>Sender</th>
                                <th>Subject</th>
                                <th>Department</th>
                                <th>Risk Assessment</th>
                                <th>ML Insights</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for email in emails %}
                            <tr data-email-id="{{ email[0] }}">
                                <td>
                                    <small>{{ email[1].strftime('%Y-%m-%d %H:%M') if email[1] else 'N/A' }}</small>
                                </td>
                                <td>
                                    <strong>{{ email[2] or 'Unknown' }}</strong>
                                    {% if email[7] %}
                                    <span class="badge bg-warning text-dark ms-2">
                                        <i class="fas fa-user-times"></i> Leaver
                                    </span>
                                    {% endif %}
                                    {% if email[2] in flagged_senders %}
                                    <span class="badge bg-danger ms-2">Flagged</span>
                                    {% endif %}
                                </td>
                                <td>
                                    <span class="text-truncate d-inline-block" style="max-width: 300px;" 
                                          title="{{ email[3] }}">
                                        {{ email[3] or 'No Subject' }}
                                    </span>
                                    {% if email[4] %}
                                    <br><small class="text-muted">
                                        <i class="fas fa-paperclip"></i> {{ email[4] }}
                                    </small>
                                    {% endif %}
                                </td>
                                <td>
                                    <span class="badge bg-info">{{ email[10] or 'Unknown' }}</span>
                                </td>
                                <td>
                                    {% if email[16] == 'High Risk' %}
                                    <span class="badge bg-danger">{{ email[16] }}</span>
                                    {% elif email[16] == 'Medium Risk' %}
                                    <span class="badge bg-warning">{{ email[16] }}</span>
                                    {% else %}
                                    <span class="badge bg-success">{{ email[16] }}</span>
                                    {% endif %}
                                </td>
                                <td>
                                    <button class="btn btn-outline-info btn-sm" onclick="showMLInsights({{ email[0] }})">
                                        <i class="fas fa-robot"></i> ML Analysis
                                    </button>
                                </td>
                                <td>
                                    <div class="btn-group" role="group">
                                        <button class="btn btn-primary btn-sm" onclick="showEmailDetails({{ email[0] }})">
                                            <i class="fas fa-eye"></i>
                                        </button>
                                        <button class="btn btn-warning btn-sm" onclick="moveToCase({{ email[0] }})" title="Move to Case Management">
                                            <i class="fas fa-briefcase"></i>
                                        </button>
                                        <button class="btn btn-danger btn-sm" data-action="flag-sender" data-sender="{{ email[2] }}">
                                            <i class="fas fa-flag"></i>
                                        </button>
                                    </div>
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
                
                <!-- Pagination -->
                {% if has_prev or has_next %}
                <nav aria-label="Email pagination">
                    <ul class="pagination justify-content-center">
                        {% if has_prev %}
                        <li class="page-item">
                            <a class="page-link" href="?page={{ page - 1 }}&search={{ search }}&department={{ department }}&risk_level={{ risk_level }}">Previous</a>
                        </li>
                        {% endif %}
                        <li class="page-item active">
                            <span class="page-link">Page {{ page }}</span>
                        </li>
                        {% if has_next %}
                        <li class="page-item">
                            <a class="page-link" href="?page={{ page + 1 }}&search={{ search }}&department={{ department }}&risk_level={{ risk_level }}">Next</a>
                        </li>
                        {% endif %}
                    </ul>
                </nav>
                {% endif %}
                
                {% else %}
                <div class="text-center text-muted py-5">
                    <i class="fas fa-inbox fa-3x mb-3"></i>
                    <h5>No emails found</h5>
                    <p>Try adjusting your filters or import email data.</p>
                </div>
                {% endif %}
            </div>
        </div>
    </div>
</div>

<!-- Flag Sender Modal -->
<div class="modal fade" id="flagSenderModal" tabindex="-1" aria-labelledby="flagSenderModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="flagSenderModalLabel">Flag Sender</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <form id="flagSenderForm">
                    <div class="mb-3">
                        <label for="flagSenderEmail" class="form-label">Sender Email</label>
                        <input type="email" class="form-control" id="flagSenderEmail" name="sender" readonly>
                    </div>
                    <div class="mb-3">
                        <label for="flagReason" class="form-label">Reason for Flagging</label>
                        <select class="form-select" id="flagReason" name="reason" required>
                            <option value="">Select a reason...</option>
                            <option value="Suspicious Activity">Suspicious Activity</option>
                            <option value="Policy Violation">Policy Violation</option>
                            <option value="Security Concern">Security Concern</option>
                            <option value="Spam/Phishing">Spam/Phishing</option>
                            <option value="Other">Other</option>
                        </select>
                    </div>
                    <div class="mb-3">
                        <label for="flagCustomReason" class="form-label">Additional Details (Optional)</label>
                        <textarea class="form-control" id="flagCustomReason" name="custom_reason" rows="3" placeholder="Provide additional details..."></textarea>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-danger" onclick="submitFlagSender()">Flag Sender</button>
            </div>
        </div>
    </div>
</div>

<!-- Email Details Modal -->
<div class="modal fade" id="emailDetailsModal" tabindex="-1" aria-labelledby="emailDetailsModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="emailDetailsModalLabel">Email Details</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body" id="emailDetailsContent">
                <!-- Content loaded dynamically -->
            </div>
        </div>
    </div>
</div>

<!-- ML Insights Modal -->
<div class="modal fade" id="mlInsightsModal" tabindex="-1" aria-labelledby="mlInsightsModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="mlInsightsModalLabel">ML Analysis & Insights</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body" id="mlInsightsContent">
                <!-- Content loaded dynamically -->
            </div>
        </div>
    </div>
</div>

<script>
function showEmailDetails(emailId) {
    fetch(`/api/email-details/${emailId}`)
        .then(response => response.json())
        .then(data => {
            document.getElementById('emailDetailsContent').innerHTML = `
                <div class="row">
                    <div class="col-md-6">
                        <h6>Basic Information</h6>
                        <table class="table table-sm">
                            <tr><td><strong>Sender:</strong></td><td>${data.sender || 'N/A'}</td></tr>
                            <tr><td><strong>Subject:</strong></td><td>${data.subject || 'N/A'}</td></tr>
                            <tr><td><strong>Date:</strong></td><td>${data._time || 'N/A'}</td></tr>
                            <tr><td><strong>Department:</strong></td><td>${data.department || 'N/A'}</td></tr>
                            <tr><td><strong>Leaver Status:</strong></td><td>${data.leaver ? '<span class="badge bg-warning text-dark"><i class="fas fa-user-times"></i> Leaver</span>' : '<span class="badge bg-success">Active Employee</span>'}</td></tr>
                            ${data.termination_date ? `<tr><td><strong>Termination Date:</strong></td><td>${data.termination_date}</td></tr>` : ''}
                        </table>
                    </div>
                    <div class="col-md-6">
                        <h6>Risk Assessment</h6>
                        <table class="table table-sm">
                            <tr><td><strong>Status:</strong></td><td><span class="badge bg-info">${data.final_outcome || 'Pending'}</span></td></tr>
                            <tr><td><strong>Policy:</strong></td><td>${data.policy_name || 'N/A'}</td></tr>
                            <tr><td><strong>Attachments:</strong></td><td>${data.attachments || 'None'}</td></tr>
                            <tr><td><strong>Recipients:</strong></td><td>${data.recipients || 'N/A'}</td></tr>
                        </table>
                    </div>
                </div>
                ${data.justifications ? `
                    <div class="mt-3">
                        <h6>Justifications</h6>
                        <div class="alert alert-info">${data.justifications}</div>
                    </div>
                ` : ''}
                <div class="mt-3 text-end">
                    <button class="btn btn-warning" onclick="updateEmailStatus(${emailId}, 'escalated')">Escalate</button>
                    <button class="btn btn-secondary" onclick="updateEmailStatus(${emailId}, 'excluded')">Exclude</button>
                    <button class="btn btn-success" onclick="updateEmailStatus(${emailId}, 'cleared')">Clear</button>
                </div>
            `;
            new bootstrap.Modal(document.getElementById('emailDetailsModal')).show();
        })
        .catch(error => {
            console.error('Error loading email details:', error);
            window.EmailGuardian.showNotification('Failed to load email details', 'error');
        });
}

function showMLInsights(emailId) {
    fetch(`/api/ml-insights/${emailId}`)
        .then(response => response.json())
        .then(data => {
            document.getElementById('mlInsightsContent').innerHTML = `
                <div class="row">
                    <div class="col-md-6">
                        <h6>Classification Results</h6>
                        <div class="card">
                            <div class="card-body">
                                <h5 class="card-title">${data.classification || 'Unknown'}</h5>
                                <div class="progress mb-2">
                                    <div class="progress-bar" style="width: ${(data.confidence || 0) * 100}%">
                                        ${((data.confidence || 0) * 100).toFixed(1)}% Confidence
                                    </div>
                                </div>
                                <p class="card-text">${data.explanation || 'No explanation available'}</p>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-6">
                        <h6>Risk Factors</h6>
                        <ul class="list-group">
                            ${(data.risk_factors || []).map(factor => `
                                <li class="list-group-item d-flex justify-content-between align-items-center">
                                    ${factor.name}
                                    <span class="badge bg-${factor.severity === 'high' ? 'danger' : factor.severity === 'medium' ? 'warning' : 'info'}">
                                        ${factor.severity}
                                    </span>
                                </li>
                            `).join('')}
                        </ul>
                    </div>
                </div>
                <div class="mt-3">
                    <h6>Recommendations</h6>
                    <div class="alert alert-info">
                        ${data.recommendations || 'No specific recommendations available.'}
                    </div>
                </div>
            `;
            new bootstrap.Modal(document.getElementById('mlInsightsModal')).show();
        })
        .catch(error => {
            console.error('Error loading ML insights:', error);
            window.EmailGuardian.showNotification('Failed to load ML insights', 'error');
        });
}

function updateEmailStatus(emailId, status) {
    fetch(`/api/update-email-status/${emailId}`, {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify({status: status})
    })
    .then(response => response.json())
    .then(result => {
        if (result.success) {
            window.EmailGuardian.showNotification(result.message, 'success');
            setTimeout(() => location.reload(), 1000);
        } else {
            window.EmailGuardian.showNotification(result.error, 'error');
        }
    })
    .catch(error => {
        console.error('Error updating email status:', error);
        window.EmailGuardian.showNotification('Failed to update email status', 'error');
    });
}

function moveToCase(emailId) {
    if (confirm('Move this email to Case Management? It will be removed from the main dashboard.')) {
        fetch(`/api/move-to-case-management/${emailId}`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            }
        })
        .then(response => response.json())
        .then(result => {
            if (result.success) {
                window.EmailGuardian.showNotification(result.message, 'success');
                // Remove the row from the table
                const row = document.querySelector(`tr[data-email-id="${emailId}"]`);
                if (row) {
                    row.style.transition = 'opacity 0.3s';
                    row.style.opacity = '0';
                    setTimeout(() => {
                        row.remove();
                        // Update total count if displayed
                        updateTotalCount();
                    }, 300);
                }
            } else {
                window.EmailGuardian.showNotification(result.error, 'error');
            }
        })
        .catch(error => {
            console.error('Error moving email to case management:', error);
            window.EmailGuardian.showNotification('Failed to move email to case management', 'error');
        });
    }
}

function updateTotalCount() {
    const totalElement = document.querySelector('.card-header h5');
    if (totalElement) {
        const currentText = totalElement.textContent;
        const match = currentText.match(/\((\d+) total\)/);
        if (match) {
            const currentTotal = parseInt(match[1]);
            const newTotal = currentTotal - 1;
            totalElement.textContent = currentText.replace(/\(\d+ total\)/, `(${newTotal} total)`);
        }
    }
}

// Flag sender submit function
function submitFlagSender() {
    const form = document.getElementById('flagSenderForm');
    const formData = new FormData(form);
    
    let reason = formData.get('reason');
    const customReason = formData.get('custom_reason');
    
    if (customReason) {
        reason = reason === 'Other' ? customReason : `${reason}: ${customReason}`;
    }
    
    fetch('/api/flag-sender', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify({
            sender: formData.get('sender'),
            reason: reason
        })
    })
    .then(response => response.json())
    .then(result => {
        if (result.success) {
            window.EmailGuardian.showNotification(result.message, 'success');
            bootstrap.Modal.getInstance(document.getElementById('flagSenderModal')).hide();
            form.reset();
            // Reload page to update flagged status
            setTimeout(() => location.reload(), 1000);
        } else {
            window.EmailGuardian.showNotification(result.error, 'error');
        }
    })
    .catch(error => {
        console.error('Error flagging sender:', error);
        window.EmailGuardian.showNotification('Failed to flag sender', 'error');
    });
}

// Initialize the flag sender functionality specifically for this page
document.addEventListener('DOMContentLoaded', function() {
    console.log('Main dashboard loaded, setting up flag sender handlers');
    
    // Add event listener for flag sender buttons
    document.addEventListener('click', function(e) {
        if (e.target.closest('[data-action="flag-sender"]')) {
            e.preventDefault();
            const button = e.target.closest('[data-action="flag-sender"]');
            const sender = button.dataset.sender;
            console.log('Flag sender clicked for:', sender);
            
            // Show the modal
            const modal = new bootstrap.Modal(document.getElementById('flagSenderModal'));
            document.getElementById('flagSenderEmail').value = sender;
            modal.show();
        }
    });
});
</script>
{% endblock %}
