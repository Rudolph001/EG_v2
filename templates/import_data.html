{% extends "base.html" %}

{% block title %}Data Import - Email Guardian{% endblock %}

{% block content %}
<div class="row">
    <div class="col-12">
        <h1 class="mb-4">
            <i class="fas fa-upload"></i>
            Data Import Center
        </h1>
        <p class="lead text-muted">
            Import email data in bulk using CSV files. The system supports high-volume imports of 10,000+ records per day.
        </p>
    </div>
</div>

<!-- Upload Section -->
<div class="row mb-4">
    <div class="col-12">
        <div class="card border-primary">
            <div class="card-header bg-primary text-white">
                <h5 class="mb-0">
                    <i class="fas fa-file-csv"></i>
                    CSV File Upload
                </h5>
            </div>
            <div class="card-body">
                <form id="csvUploadForm" enctype="multipart/form-data">
                    <div class="row">
                        <div class="col-md-8">
                            <div class="mb-3">
                                <label for="csvFile" class="form-label">Select CSV File</label>
                                <input type="file" class="form-control" id="csvFile" name="file" 
                                       accept=".csv" required>
                                <div class="form-text">
                                    <i class="fas fa-info-circle"></i>
                                    Supported format: CSV files with email data columns
                                </div>
                            </div>
                        </div>
                        <div class="col-md-4">
                            <label class="form-label">&nbsp;</label>
                            <div class="d-grid">
                                <button type="submit" class="btn btn-primary btn-lg" id="uploadBtn">
                                    <i class="fas fa-cloud-upload-alt"></i>
                                    Upload & Import
                                </button>
                            </div>
                        </div>
                    </div>
                </form>

                <!-- Progress Bar (hidden initially) -->
                <div id="uploadProgress" class="mt-3" style="display: none;">
                    <div class="progress">
                        <div class="progress-bar progress-bar-striped progress-bar-animated" 
                             role="progressbar" style="width: 0%" id="progressBar">
                            <span id="progressText">0%</span>
                        </div>
                    </div>
                </div>

                <!-- Upload Results -->
                <div id="uploadResults" class="mt-3" style="display: none;">
                    <!-- Results will be displayed here -->
                </div>
            </div>
        </div>
    </div>
</div>

<!-- CSV Format Requirements -->
<div class="row mb-4">
    <div class="col-12">
        <div class="card border-warning">
            <div class="card-header bg-warning text-dark">
                <h5 class="mb-0">
                    <i class="fas fa-exclamation-triangle"></i>
                    CSV Format Requirements
                </h5>
            </div>
            <div class="card-body">
                <div class="row">
                    <div class="col-md-6">
                        <h6>Required Columns:</h6>
                        <ul class="list-group list-group-flush">
                            <li class="list-group-item bg-transparent">
                                <code>_time</code> - Email timestamp (YYYY-MM-DD HH:MM:SS)
                            </li>
                            <li class="list-group-item bg-transparent">
                                <code>sender</code> - Email sender address
                            </li>
                            <li class="list-group-item bg-transparent">
                                <code>subject</code> - Email subject line
                            </li>
                            <li class="list-group-item bg-transparent">
                                <code>recipients</code> - Email recipients (comma-separated)
                            </li>
                        </ul>
                    </div>
                    <div class="col-md-6">
                        <h6>Optional Columns:</h6>
                        <ul class="list-group list-group-flush">
                            <li class="list-group-item bg-transparent">
                                <code>attachments</code> - Attachment names
                            </li>
                            <li class="list-group-item bg-transparent">
                                <code>department</code> - Sender department
                            </li>
                            <li class="list-group-item bg-transparent">
                                <code>bunit</code> - Business unit
                            </li>
                            <li class="list-group-item bg-transparent">
                                <code>final_outcome</code> - Classification result
                            </li>
                        </ul>
                    </div>
                </div>
                <div class="alert alert-info mt-3 mb-0">
                    <i class="fas fa-info-circle"></i>
                    DuckDB can automatically detect column types and handle missing values. 
                    Ensure your timestamp format is consistent (YYYY-MM-DD HH:MM:SS).
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Sample CSV Download -->
<div class="row mb-4">
    <div class="col-md-6">
        <div class="card border-info">
            <div class="card-header bg-info text-white">
                <h5 class="mb-0">
                    <i class="fas fa-download"></i>
                    Sample Template
                </h5>
            </div>
            <div class="card-body">
                <p>Download a sample CSV template with the correct format:</p>
                <button class="btn btn-outline-info" onclick="downloadSampleCSV()">
                    <i class="fas fa-file-download"></i>
                    Download Sample CSV
                </button>
            </div>
        </div>
    </div>

    <div class="col-md-6">
        <div class="card border-success">
            <div class="card-header bg-success text-white">
                <h5 class="mb-0">
                    <i class="fas fa-rocket"></i>
                    Performance Stats
                </h5>
            </div>
            <div class="card-body">
                <div class="row text-center">
                    <div class="col-6">
                        <h4 class="text-success">10K+</h4>
                        <small>Records/Day</small>
                    </div>
                    <div class="col-6">
                        <h4 class="text-success">&lt;5s</h4>
                        <small>Processing Time</small>
                    </div>
                </div>
                <p class="small text-muted mt-2 mb-0">
                    Powered by DuckDB for high-performance analytics
                </p>
            </div>
        </div>
    </div>
</div>

{% endblock %}

{% block extra_scripts %}
<script>
$(document).ready(function() {
    // Helper function to show alerts
    function showAlert(message, type) {
        const alertContainer = $('#uploadResults');
        const alertClass = `alert alert-${type} alert-dismissible fade show`;
        const alertHtml = `
            <div class="${alertClass}" role="alert">
                ${message}
                <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
            </div>
        `;
        alertContainer.html(alertHtml).show();
    }

    // Handle form submission
    $('#csvUploadForm').on('submit', function(e) {
        e.preventDefault();

        const formData = new FormData();
        const fileInput = document.getElementById('csvFile');

        if (fileInput.files.length === 0) {
            showAlert('Please select a CSV file.', 'warning');
            return;
        }

        formData.append('file', fileInput.files[0]);

        // Show progress bar
        $('#uploadProgress').show();
        $('#uploadBtn').prop('disabled', true).html('<i class="fas fa-spinner fa-spin"></i> Uploading...');

        // Simulate progress
        let progress = 0;
        const progressInterval = setInterval(() => {
            progress += Math.random() * 15;
            if (progress > 90) progress = 90;
            $('#progressBar').css('width', progress + '%');
            $('#progressText').text(Math.round(progress) + '%');
        }, 500);

        $.ajax({
            url: '/api/upload-csv',
            type: 'POST',
            data: formData,
            processData: false,
            contentType: false,
            success: function(response) {
                clearInterval(progressInterval);
                $('#progressBar').css('width', '100%');
                $('#progressText').text('100%');

                setTimeout(() => {
                    $('#uploadProgress').hide();
                    $('#progressBar').css('width', '0%');
                    $('#progressText').text('0%');

                    // Show results
                    const results = `
                        <div class="alert alert-success">
                            <h5><i class="fas fa-check-circle"></i> Import Successful</h5>
                            <p class="mb-0">${response.message}</p>
                        </div>
                    `;
                    $('#uploadResults').html(results).show();

                    // Reset form
                    $('#csvUploadForm')[0].reset();
                }, 1000);
            },
            error: function(xhr) {
                clearInterval(progressInterval);
                $('#uploadProgress').hide();
                $('#progressBar').css('width', '0%');
                $('#progressText').text('0%');

                let errorMsg = 'Upload failed';
                if (xhr.responseJSON && xhr.responseJSON.error) {
                    errorMsg = xhr.responseJSON.error;
                }

                // Show error results
                const errorResults = `
                    <div class="alert alert-danger">
                        <h5><i class="fas fa-exclamation-triangle"></i> Import Failed</h5>
                        <p class="mb-0">${errorMsg}</p>
                    </div>
                `;
                $('#uploadResults').html(errorResults).show();
            },
            complete: function() {
                $('#uploadBtn').prop('disabled', false).html('<i class="fas fa-cloud-upload-alt"></i> Upload & Import');
            }
        });
    });
});

function downloadSampleCSV() {
    const sampleData = `_time,sender,subject,recipients,attachments,department,bunit,final_outcome
2024-01-15 10:30:00,john.doe@company.com,Monthly Report,manager@company.com,,Finance,North,
2024-01-15 11:45:00,sarah.smith@company.com,Project Update,team@company.com,presentation.pdf,Engineering,South,
2024-01-15 14:20:00,mike.jones@company.com,Client Meeting,client@external.com,,Sales,East,`;
    
    const blob = new Blob([sampleData], { type: 'text/csv' });
    const url = window.URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.style.display = 'none';
    a.href = url;
    a.download = 'sample_email_data.csv';
    document.body.appendChild(a);
    a.click();
    window.URL.revokeObjectURL(url);
    document.body.removeChild(a);
}
</script>
{% endblock %}